(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[660],{5120:function(e,t,a){Promise.resolve().then(a.bind(a,7143))},7143:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return tm}});var i=a(1279),r=a(12),s=a(8251),n=a(164),o=a(6564),l=a(1822),c=a(4454),d=a(7290),u=a(7571),m=a(5935),h=a(8092),f=a(2819),p=a(9430),y=a(7077),g=a(8331),x=a(9720),v=a(548);class b{createLayer(e,t,a){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},r={id:e,renderTarget:new f.dd2(this.config.width,this.config.height,{format:f.wk1,type:f.ywz,minFilter:f.wem,magFilter:f.wem,generateMipmaps:!1}),scene:t,camera:a,enabled:!0,blendMode:"normal",opacity:1,zIndex:0,...i};return this.layers.set(e,r),this.layerOrder.push(e),this.sortLayers(),r}removeLayer(e){let t=this.layers.get(e);t&&(t.renderTarget.dispose(),this.layers.delete(e),this.layerOrder=this.layerOrder.filter(t=>t!==e))}updateLayer(e,t){let a=this.layers.get(e);a&&(Object.assign(a,t),void 0!==t.zIndex&&this.sortLayers())}sortLayers(){this.layerOrder.sort((e,t)=>{let a=this.layers.get(e),i=this.layers.get(t);return((null==a?void 0:a.zIndex)||0)-((null==i?void 0:i.zIndex)||0)})}render(){for(let e of this.layerOrder){let t=this.layers.get(e);t&&t.enabled&&(this.renderer.setRenderTarget(t.renderTarget),this.renderer.clear(),this.renderer.render(t.scene,t.camera))}this.compositeLayersToMain(),this.config.enableBloom&&this.applyBloomEffect(),this.renderFinalOutput()}compositeLayersToMain(){for(let e of(this.renderer.setRenderTarget(this.mainRenderTarget),this.renderer.clear(),this.layerOrder)){let t=this.layers.get(e);t&&t.enabled&&this.renderLayerWithBlending(t)}}renderLayerWithBlending(e){let t=this.getBlendModeShader(e.blendMode),a=new f.jyz({vertexShader:"\n        varying vec2 vUv;\n        void main() {\n          vUv = uv;\n          gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n        }\n      ",fragmentShader:t,uniforms:{tDiffuse:new f.xWb(e.renderTarget.texture),opacity:new f.xWb(e.opacity)},transparent:!0,depthTest:!1,depthWrite:!1}),i=new f.Kj0(this.quadGeometry,a),r=new f.xsS;r.add(i),this.renderer.render(r,this.quadCamera),a.dispose(),i.geometry.dispose()}applyBloomEffect(){this.renderer.setRenderTarget(this.bloomRenderTarget),this.renderer.clear();let e=new f.jyz({vertexShader:"\n        varying vec2 vUv;\n        void main() {\n          vUv = uv;\n          gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n        }\n      ",fragmentShader:"\n        uniform sampler2D tDiffuse;\n        varying vec2 vUv;\n        \n        void main() {\n          vec4 texel = texture2D(tDiffuse, vUv);\n          float brightness = (texel.r + texel.g + texel.b) / 3.0;\n          float threshold = 0.7;\n          float bloom = max(0.0, brightness - threshold);\n          gl_FragColor = vec4(texel.rgb * bloom, bloom);\n        }\n      ",uniforms:{tDiffuse:new f.xWb(this.mainRenderTarget.texture)}}),t=new f.Kj0(this.quadGeometry,e),a=new f.xsS;a.add(t),this.renderer.render(a,this.quadCamera),this.renderer.setRenderTarget(this.tempRenderTarget),this.renderer.clear();let i=new f.jyz({vertexShader:"\n        varying vec2 vUv;\n        void main() {\n          vUv = uv;\n          gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n        }\n      ",fragmentShader:"\n        uniform sampler2D tMain;\n        uniform sampler2D tBloom;\n        varying vec2 vUv;\n        \n        void main() {\n          vec4 mainColor = texture2D(tMain, vUv);\n          vec4 bloomColor = texture2D(tBloom, vUv);\n          gl_FragColor = mainColor + bloomColor * 0.5;\n        }\n      ",uniforms:{tMain:new f.xWb(this.mainRenderTarget.texture),tBloom:new f.xWb(this.bloomRenderTarget.texture)}}),r=new f.Kj0(this.quadGeometry,i),s=new f.xsS;s.add(r),this.renderer.render(s,this.quadCamera);let n=this.mainRenderTarget;this.mainRenderTarget=this.tempRenderTarget,this.tempRenderTarget=n,e.dispose(),i.dispose(),t.geometry.dispose(),r.geometry.dispose()}renderFinalOutput(){this.renderer.setRenderTarget(null);let e=new f.jyz({vertexShader:"\n        varying vec2 vUv;\n        void main() {\n          vUv = uv;\n          gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n        }\n      ",fragmentShader:"\n        uniform sampler2D tDiffuse;\n        varying vec2 vUv;\n        \n        void main() {\n          vec4 texel = texture2D(tDiffuse, vUv);\n          gl_FragColor = texel;\n        }\n      ",uniforms:{tDiffuse:new f.xWb(this.mainRenderTarget.texture)}}),t=new f.Kj0(this.quadGeometry,e),a=new f.xsS;a.add(t),this.renderer.render(a,this.quadCamera),e.dispose(),t.geometry.dispose()}initializeBlendShaders(){this.blendShaders.set("normal","\n      uniform sampler2D tDiffuse;\n      uniform float opacity;\n      varying vec2 vUv;\n      \n      void main() {\n        vec4 texel = texture2D(tDiffuse, vUv);\n        gl_FragColor = vec4(texel.rgb, texel.a * opacity);\n      }\n    "),this.blendShaders.set("multiply","\n      uniform sampler2D tDiffuse;\n      uniform float opacity;\n      varying vec2 vUv;\n      \n      void main() {\n        vec4 texel = texture2D(tDiffuse, vUv);\n        gl_FragColor = vec4(texel.rgb * texel.rgb, texel.a * opacity);\n      }\n    "),this.blendShaders.set("screen","\n      uniform sampler2D tDiffuse;\n      uniform float opacity;\n      varying vec2 vUv;\n      \n      void main() {\n        vec4 texel = texture2D(tDiffuse, vUv);\n        gl_FragColor = vec4(1.0 - (1.0 - texel.rgb) * (1.0 - texel.rgb), texel.a * opacity);\n      }\n    "),this.blendShaders.set("overlay","\n      uniform sampler2D tDiffuse;\n      uniform float opacity;\n      varying vec2 vUv;\n      \n      void main() {\n        vec4 texel = texture2D(tDiffuse, vUv);\n        vec3 base = vec3(0.5);\n        vec3 overlay = mix(\n          2.0 * base * texel.rgb, \n          1.0 - 2.0 * (1.0 - base) * (1.0 - texel.rgb), \n          step(0.5, base)\n        );\n        gl_FragColor = vec4(overlay, texel.a * opacity);\n      }\n    "),this.blendShaders.set("add","\n      uniform sampler2D tDiffuse;\n      uniform float opacity;\n      varying vec2 vUv;\n      \n      void main() {\n        vec4 texel = texture2D(tDiffuse, vUv);\n        gl_FragColor = vec4(texel.rgb + texel.rgb, texel.a * opacity);\n      }\n    "),this.blendShaders.set("subtract","\n      uniform sampler2D tDiffuse;\n      uniform float opacity;\n      varying vec2 vUv;\n      \n      void main() {\n        vec4 texel = texture2D(tDiffuse, vUv);\n        gl_FragColor = vec4(max(texel.rgb - texel.rgb, 0.0), texel.a * opacity);\n      }\n    ")}getBlendModeShader(e){return this.blendShaders.get(e)||this.blendShaders.get("normal")}getLayer(e){return this.layers.get(e)}getLayerIds(){return[...this.layerOrder]}resize(e,t){for(let a of(this.config.width=e,this.config.height=t,this.mainRenderTarget.setSize(e,t),this.bloomRenderTarget.setSize(e,t),this.tempRenderTarget.setSize(e,t),this.layers.values()))a.renderTarget.setSize(e,t)}dispose(){for(let e of(this.mainRenderTarget.dispose(),this.bloomRenderTarget.dispose(),this.tempRenderTarget.dispose(),this.layers.values()))e.renderTarget.dispose();this.quadGeometry.dispose(),this.layers.clear(),this.layerOrder=[]}constructor(e,t){this.layers=new Map,this.layerOrder=[],this.blendShaders=new Map,this.renderer=e,this.config={enableBloom:!1,enableAntialiasing:!0,pixelRatio:window.devicePixelRatio||1,...t},this.mainRenderTarget=new f.dd2(this.config.width,this.config.height,{format:f.wk1,type:f.ywz,minFilter:f.wem,magFilter:f.wem,generateMipmaps:!1}),this.bloomRenderTarget=new f.dd2(this.config.width,this.config.height,{format:f.wk1,type:f.ywz,minFilter:f.wem,magFilter:f.wem,generateMipmaps:!1}),this.tempRenderTarget=new f.dd2(this.config.width,this.config.height,{format:f.wk1,type:f.ywz,minFilter:f.wem,magFilter:f.wem,generateMipmaps:!1}),this.quadGeometry=new f._12(2,2),this.quadCamera=new f.iKG(-1,1,1,-1,0,1),this.initializeBlendShaders()}}class w{init(e,t,a){console.log("✨ BloomEffect.init() called"),this.scene=e,this.camera=t,this.renderer=a,this.setupComposer(),this.setupMultiLayerCompositor(),console.log("✨ Bloom effect initialized")}setupComposer(){this.composer=new y.x(this.renderer),this.renderPass=new g.C(this.scene,this.camera),this.composer.addPass(this.renderPass);let e=this.renderer.getSize(new f.FM8);this.bloomPass=new x.m(new f.FM8(e.x,e.y),this.parameters.strength,this.parameters.radius,this.parameters.threshold),this.composer.addPass(this.bloomPass);let t={uniforms:{tDiffuse:{value:null},uExposure:{value:this.parameters.exposure}},vertexShader:"\n        varying vec2 vUv;\n        void main() {\n          vUv = uv;\n          gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n        }\n      ",fragmentShader:"\n        uniform sampler2D tDiffuse;\n        uniform float uExposure;\n        varying vec2 vUv;\n        \n        void main() {\n          vec4 color = texture2D(tDiffuse, vUv);\n          \n          // Apply exposure\n          color.rgb *= uExposure;\n          \n          // Gamma correction\n          color.rgb = pow(color.rgb, vec3(1.0 / 2.2));\n          \n          gl_FragColor = color;\n        }\n      "};this.finalPass=new v.T(t),this.composer.addPass(this.finalPass),console.log("\uD83C\uDFAD Bloom composer setup complete")}setupMultiLayerCompositor(){try{let e=this.renderer.getSize(new f.FM8);this.multiLayerCompositor=new b(this.renderer,{width:e.x,height:e.y,enableBloom:!0,enableAntialiasing:!0,pixelRatio:window.devicePixelRatio||1}),this.multiLayerCompositor.createLayer("main-3d",this.scene,this.camera,{blendMode:"normal",opacity:1,zIndex:100,enabled:!0}),console.log("\uD83C\uDFA8 MultiLayerCompositor initialized (disabled by default)")}catch(e){console.error("Failed to initialize MultiLayerCompositor:",e),this.useMultiLayerCompositing=!1}}update(e,t,a){let i=Math.max(.3,Math.min(a.activeNotes.length/5,1));this.bloomPass.strength=this.parameters.strength*(.9+.1*i),this.bloomPass.threshold=this.parameters.threshold*(1+.1*i),this.finalPass.uniforms.uExposure.value=this.parameters.exposure}render(){this.useMultiLayerCompositing&&this.multiLayerCompositor?this.multiLayerCompositor.render():this.composer&&this.composer.render()}enableMultiLayerCompositing(){this.useMultiLayerCompositing=!0,console.log("\uD83C\uDFA8 GPU compositing enabled")}disableMultiLayerCompositing(){this.useMultiLayerCompositing=!1,console.log("\uD83C\uDFA8 GPU compositing disabled")}getMultiLayerCompositor(){return this.multiLayerCompositor}handleResize(e,t){this.composer&&(this.composer.setSize(e,t),this.bloomPass.setSize(e,t)),this.multiLayerCompositor&&this.multiLayerCompositor.resize(e,t)}destroy(){this.composer&&this.composer.dispose(),this.multiLayerCompositor&&this.multiLayerCompositor.dispose()}constructor(){this.id="bloom",this.name="Bloom Post-Processing",this.description="Global bloom effect for all visualizations",this.enabled=!0,this.parameters={threshold:.25,strength:.1,radius:.4,exposure:.8},this.useMultiLayerCompositing=!1,this.multiLayerCompositor=null,console.log("✨ BloomEffect constructor called")}}class k{loadAudioAnalysis(e){this.buildFeatureMapping(e),this.packFeaturesIntoTexture(e)}buildFeatureMapping(e){this.featureMappings=[],this.featureIndexMap.clear();let t=0;for(let a of e.stemTypes)if(e.features[a])for(let e of["rms","spectralCentroid","spectralRolloff","zcr"]){if(t>=this.maxFeatures)break;let i={featureIndex:t,stemType:a,featureName:e,minValue:0,maxValue:1};this.featureMappings.push(i),this.featureIndexMap.set("".concat(a,"-").concat(e),t),t++}this.packFeatureMetadata()}packFeatureMetadata(){for(let e=0;e<this.featureMappings.length;e++){let t=this.featureMappings[e],a=4*Math.floor(e/4)+e%4;this.featureData[4*a+0]=t.featureIndex,this.featureData[4*a+1]=this.hashString(t.stemType),this.featureData[4*a+2]=this.hashString(t.featureName),this.featureData[4*a+3]=t.maxValue-t.minValue}this.featureTexture.needsUpdate=!0}packFeaturesIntoTexture(e){for(let t of(this.audioData.fill(0),this.featureMappings)){let a=e.features[t.stemType];if(!a)continue;let i=this.extractFeatureData(a,t.featureName);if(!i)continue;let r=Math.floor(t.featureIndex/4),s=t.featureIndex%4;for(let e=0;e<Math.min(this.textureWidth,i.length);e++){let a=(e+r*this.textureWidth)*4+s,n=this.normalizeValue(i[e],t.minValue,t.maxValue);this.audioData[a]=n}}this.audioTexture.needsUpdate=!0}extractFeatureData(e,t){return e}updateTime(e,t){this.timeData[0]=e,this.timeData[1]=t,this.timeData[2]=e/t,this.timeData[3]=0,this.timeTexture.needsUpdate=!0}getShaderUniforms(){return{uAudioTexture:new f.xWb(this.audioTexture),uFeatureTexture:new f.xWb(this.featureTexture),uTimeTexture:new f.xWb(this.timeTexture),uAudioTextureSize:new f.xWb(new f.FM8(this.textureWidth,this.textureHeight)),uFeatureTextureSize:new f.xWb(new f.FM8(4,this.textureHeight))}}generateShaderCode(){return"\n      uniform sampler2D uAudioTexture;\n      uniform sampler2D uFeatureTexture;\n      uniform sampler2D uTimeTexture;\n      uniform vec2 uAudioTextureSize;\n      uniform vec2 uFeatureTextureSize;\n      \n      float sampleAudioFeature(float featureIndex) {\n        vec4 timeData = texture2D(uTimeTexture, vec2(0.5));\n        float normalizedTime = timeData.z;\n        \n        float rowIndex = floor(featureIndex / 4.0);\n        vec2 uv = vec2(normalizedTime, rowIndex / uAudioTextureSize.y);\n        vec4 featureData = texture2D(uAudioTexture, uv);\n        \n        // Extract correct channel based on feature index\n        float channelIndex = mod(featureIndex, 4.0);\n        if (channelIndex < 0.5) return featureData.r;\n        else if (channelIndex < 1.5) return featureData.g;\n        else if (channelIndex < 2.5) return featureData.b;\n        else return featureData.a;\n      }\n      \n      float sampleAudioFeatureByName(float stemTypeHash, float featureNameHash) {\n        // Find feature index by name (simplified - in practice you'd use a lookup table)\n        for (float i = 0.0; i < uFeatureTextureSize.y; i++) {\n          vec2 featureUv = vec2(0.5, (i + 0.5) / uFeatureTextureSize.y);\n          vec4 featureInfo = texture2D(uFeatureTexture, featureUv);\n          \n          if (featureInfo.y == stemTypeHash && featureInfo.z == featureNameHash) {\n            return sampleAudioFeature(featureInfo.x);\n          }\n        }\n        return 0.0;\n      }\n    "}getFeatureValue(e,t){let a="".concat(e,"-").concat(t),i=this.featureIndexMap.get(a);if(void 0===i)return 0;let r=(Math.floor(this.timeData[2]*this.textureWidth)+Math.floor(i/4)*this.textureWidth)*4+i%4;return this.audioData[r]||0}hashString(e){let t=0;for(let a=0;a<e.length;a++)t=(t<<5)-t+e.charCodeAt(a),t&=t;return Math.abs(t)/2147483647}normalizeValue(e,t,a){return Math.max(0,Math.min(1,(e-t)/(a-t)))}dispose(){this.audioTexture.dispose(),this.featureTexture.dispose(),this.timeTexture.dispose()}constructor(){this.textureWidth=256,this.textureHeight=64,this.maxFeatures=256,this.featureMappings=[],this.featureIndexMap=new Map,this.audioData=new Float32Array(this.textureWidth*this.textureHeight*4),this.featureData=new Float32Array(4*this.textureHeight),this.timeData=new Float32Array(4),this.audioTexture=new f.IEO(this.audioData,this.textureWidth,this.textureHeight,f.wk1,f.VzW),this.audioTexture.needsUpdate=!0,this.audioTexture.wrapS=f.uWy,this.audioTexture.wrapT=f.uWy,this.audioTexture.magFilter=f.wem,this.audioTexture.minFilter=f.wem,this.featureTexture=new f.IEO(this.featureData,4,this.textureHeight,f.wk1,f.VzW),this.featureTexture.needsUpdate=!0,this.featureTexture.wrapS=f.uWy,this.featureTexture.wrapT=f.uWy,this.featureTexture.magFilter=f.TyD,this.featureTexture.minFilter=f.TyD,this.timeTexture=new f.IEO(this.timeData,1,1,f.wk1,f.VzW),this.timeTexture.needsUpdate=!0,this.timeTexture.wrapS=f.uWy,this.timeTexture.wrapT=f.uWy,this.timeTexture.magFilter=f.TyD,this.timeTexture.minFilter=f.TyD}}class S{addMediaLayer(e){this.mediaLayers.set(e.id,e);let t=this.createTextureFromSource(e.source,e.type);this.layerTextures.set(e.id,t);let a=this.createMaterial(e,t);this.layerMaterials.set(e.id,a);let i=this.createMesh(e,a);this.layerMeshes.set(e.id,i),this.scene.add(i)}removeMediaLayer(e){let t=this.layerMeshes.get(e);t&&(this.scene.remove(t),t.geometry.dispose(),this.layerMeshes.delete(e));let a=this.layerMaterials.get(e);a&&(a.dispose(),this.layerMaterials.delete(e));let i=this.layerTextures.get(e);i&&(i.dispose(),this.layerTextures.delete(e)),this.mediaLayers.delete(e)}updateWithAudioFeatures(e){for(let[t,a]of this.mediaLayers){if(!a.audioBindings)continue;let i=this.layerMaterials.get(t);if(i)for(let t of a.audioBindings){let r=e[t.feature];if(void 0===r)continue;let s=this.mapRange(r,t.inputRange[0],t.inputRange[1],t.outputRange[0],t.outputRange[1]);switch(t.property){case"opacity":i.uniforms.uOpacity.value=s;break;case"scale":i.uniforms.uScale.value.set(s,s);break;case"rotation":i.uniforms.uRotation.value=s;break;case"position":i.uniforms.uPosition.value.set(a.position.x+s,a.position.y+s)}}}}updateTextures(){for(let[e,t]of this.layerTextures)t instanceof f.fO1&&(t.needsUpdate=!0)}createTextureFromSource(e,t){switch(t){case"video":if("string"==typeof e){let t=document.createElement("video");return t.src=e,t.loop=!0,t.muted=!0,t.play(),new f.fO1(t)}if(e instanceof HTMLVideoElement)return new f.fO1(e);break;case"image":if("string"==typeof e)return new f.dpR().load(e);if(e instanceof HTMLImageElement)return new f.xEZ(e);break;case"canvas":if(e instanceof HTMLCanvasElement)return new f.ROQ(e)}return new f.xEZ}createMaterial(e,t){return new f.jyz({vertexShader:"\n        uniform vec2 uPosition;\n        uniform vec2 uScale;\n        uniform float uRotation;\n        varying vec2 vUv;\n        \n        void main() {\n          vUv = uv;\n          \n          vec3 pos = position;\n          \n          // Apply scale\n          pos.xy *= uScale;\n          \n          // Apply rotation\n          float c = cos(uRotation);\n          float s = sin(uRotation);\n          mat2 rotationMatrix = mat2(c, -s, s, c);\n          pos.xy = rotationMatrix * pos.xy;\n          \n          // Apply position\n          pos.xy += uPosition;\n          \n          gl_Position = projectionMatrix * modelViewMatrix * vec4(pos, 1.0);\n        }\n      ",fragmentShader:"\n        uniform sampler2D tDiffuse;\n        uniform float uOpacity;\n        varying vec2 vUv;\n        \n        void main() {\n          vec4 texel = texture2D(tDiffuse, vUv);\n          gl_FragColor = vec4(texel.rgb, texel.a * uOpacity);\n        }\n      ",uniforms:{tDiffuse:new f.xWb(t),uOpacity:new f.xWb(e.opacity),uPosition:new f.xWb(new f.FM8(e.position.x,e.position.y)),uScale:new f.xWb(new f.FM8(e.scale.x,e.scale.y)),uRotation:new f.xWb(e.rotation)},transparent:!0,depthTest:!1,depthWrite:!1})}createMesh(e,t){let a=new f._12(1,1),i=new f.Kj0(a,t);return i.position.set(e.position.x,e.position.y,-e.zIndex),i.scale.set(e.scale.x,e.scale.y,1),i.rotation.z=e.rotation,i}mapRange(e,t,a,i,r){return(e-t)*(r-i)/(a-t)+i}getMediaLayer(e){return this.mediaLayers.get(e)}getMediaLayerIds(){return[...this.mediaLayers.keys()]}updateLayerConfig(e,t){let a=this.mediaLayers.get(e);if(!a)return;Object.assign(a,t);let i=this.layerMaterials.get(e);i&&(void 0!==t.opacity&&(i.uniforms.uOpacity.value=t.opacity),void 0!==t.position&&i.uniforms.uPosition.value.set(t.position.x,t.position.y),void 0!==t.scale&&i.uniforms.uScale.value.set(t.scale.x,t.scale.y),void 0!==t.rotation&&(i.uniforms.uRotation.value=t.rotation));let r=this.layerMeshes.get(e);r&&(void 0!==t.position&&r.position.set(t.position.x,t.position.y,-a.zIndex),void 0!==t.scale&&r.scale.set(t.scale.x,t.scale.y,1),void 0!==t.rotation&&(r.rotation.z=t.rotation),void 0!==t.zIndex&&(r.position.z=-t.zIndex))}dispose(){for(let[e]of this.mediaLayers)this.removeMediaLayer(e);this.mediaLayers.clear(),this.layerMaterials.clear(),this.layerTextures.clear(),this.layerMeshes.clear()}constructor(e,t,a){this.mediaLayers=new Map,this.layerMaterials=new Map,this.layerTextures=new Map,this.layerMeshes=new Map,this.scene=e,this.camera=t,this.renderer=a}}class C{initScene(e){this.scene=new f.xsS,this.scene.background=new f.Ilk(0),this.scene.fog=new f.ybr(0,10,50);let t=e.aspectRatio?e.aspectRatio.width/e.aspectRatio.height:1;this.camera=new f.cPb(75,t,.1,1e3),this.camera.position.set(0,0,5);try{(this.canvas.getContext("webgl2")||this.canvas.getContext("webgl"))&&h.q.log("\uD83D\uDD04 Found existing WebGL context, will attempt to reuse"),this.renderer=new p.CP7({canvas:this.canvas,antialias:!0,alpha:!0,powerPreference:"default",failIfMajorPerformanceCaveat:!1}),h.q.log("✅ WebGL Renderer created successfully"),h.q.log("\uD83D\uDD27 WebGL Context:",this.renderer.getContext())}catch(e){console.error("❌ Primary WebGL renderer failed:",e);try{h.q.log("\uD83D\uDD04 Attempting fallback renderer with minimal settings..."),this.renderer=new p.CP7({canvas:this.canvas,antialias:!1,alpha:!0,powerPreference:"low-power",failIfMajorPerformanceCaveat:!1}),h.q.log("✅ Fallback renderer created successfully")}catch(e){throw console.error("❌ Fallback renderer also failed:",e),Error("WebGL is not available. Please refresh the page and try again. If the problem persists, try closing other browser tabs or restarting your browser.")}}this.renderer.setSize(e.canvas.width,e.canvas.height),this.renderer.setPixelRatio(Math.min(window.devicePixelRatio,e.canvas.pixelRatio||2)),this.renderer.setClearColor(0,1),h.q.log("\uD83C\uDFAE Renderer configured with size:",e.canvas.width,"x",e.canvas.height),this.renderer.setAnimationLoop(null),this.renderer.info.autoReset=!1,this.renderer.toneMapping=f.LY2,this.renderer.toneMappingExposure=1,this.renderer.shadowMap.enabled=!1,this.renderer.shadowMap.type=f.ntZ}initBloomEffect(){this.bloomEffect=new w,this.bloomEffect.init(this.scene,this.camera,this.renderer),h.q.log("✨ Bloom post-processing initialized")}initAudioTextureManager(){this.audioTextureManager=new k,h.q.log("\uD83C\uDFB5 AudioTextureManager initialized")}initMediaLayerManager(){this.mediaLayerManager=new S(this.scene,this.camera,this.renderer),h.q.log("\uD83C\uDFAC MediaLayerManager initialized")}async initAudioAnalyzer(){this.audioContext||(h.q.log("\uD83C\uDFB5 Creating AudioContext after user interaction..."),this.audioContext=new AudioContext,await this.audioContext.resume());try{h.q.log("\uD83C\uDFB5 Audio analyzer initialization (placeholder)")}catch(e){h.q.error("❌ Failed to initialize audio analyzer:",e)}}setupEventListeners(){window.addEventListener("resize",()=>{let e=this.canvas.clientWidth,t=this.canvas.clientHeight;this.handleViewportResize(e,t)}),document.addEventListener("visibilitychange",()=>{document.hidden&&this.isPlaying&&this.pause()}),this.canvas.addEventListener("webglcontextlost",e=>{console.warn("⚠️ WebGL context lost!"),e.preventDefault(),this.pause()}),this.canvas.addEventListener("webglcontextrestored",()=>{h.q.log("✅ WebGL context restored, reinitializing..."),h.q.log("\uD83D\uDD04 Please refresh the page to restore full functionality")})}addEffect(e){try{h.q.log("\uD83C\uDFA8 Adding effect: ".concat(e.name," (").concat(e.id,")")),e.init(this.scene,this.camera,this.renderer),this.effects.set(e.id,e),e.enabled?this.showEffectInScene(e):this.hideEffectFromScene(e),h.q.log("✅ Added effect: ".concat(e.name,". Total effects: ").concat(this.effects.size))}catch(t){h.q.error("❌ Failed to add effect ".concat(e.name,":"),t)}}addEffectWithId(e,t){try{h.q.log("\uD83C\uDFA8 Adding effect with custom ID: ".concat(e.name," (").concat(t,")")),this.effects.set(t,e),h.q.log("✅ Added effect reference with custom ID: ".concat(e.name," (").concat(t,"). Total effects: ").concat(this.effects.size))}catch(a){h.q.error("❌ Failed to add effect ".concat(e.name," with custom ID ").concat(t,":"),a)}}removeEffect(e){let t=this.effects.get(e);t&&(t.destroy(),this.effects.delete(e),h.q.log("✅ Removed effect: ".concat(t.name,". Remaining effects: ").concat(this.effects.size)))}getEffect(e){return this.effects.get(e)}getAllEffects(){return Array.from(this.effects.values())}enableEffect(e){let t=this.effects.get(e);t?(t.enabled=!0,this.showEffectInScene(t),h.q.log("✅ Enabled effect: ".concat(t.name," (").concat(e,")"))):h.q.warn("⚠️ Effect not found: ".concat(e))}disableEffect(e){let t=this.effects.get(e);t&&(t.enabled=!1,this.hideEffectFromScene(t),h.q.log("❌ Disabled effect: ".concat(t.name," (").concat(e,")")))}showEffectInScene(e){"mesh"in e&&e.mesh&&(e.mesh.visible=!0),"instancedMesh"in e&&e.instancedMesh&&(e.instancedMesh.visible=!0),"connectionLines"in e&&e.connectionLines&&(e.connectionLines.visible=!0),"mesh"in e&&e.mesh&&(e.mesh.visible=!0),"materials"in e&&Array.isArray(e.materials)&&e.materials.forEach(e=>{e&&void 0!==e.visible&&(e.visible=!0)})}hideEffectFromScene(e){"mesh"in e&&e.mesh&&(e.mesh.visible=!1),"instancedMesh"in e&&e.instancedMesh&&(e.instancedMesh.visible=!1),"connectionLines"in e&&e.connectionLines&&(e.connectionLines.visible=!1),"mesh"in e&&e.mesh&&(e.mesh.visible=!1),"materials"in e&&Array.isArray(e.materials)&&e.materials.forEach(e=>{e&&void 0!==e.visible&&(e.visible=!1)})}play(){h.q.log("\uD83C\uDFAC Play() called. Current state: isPlaying=".concat(this.isPlaying,", effects=").concat(this.effects.size)),this.isPlaying||(this.isPlaying=!0,this.clock.start(),this.animate(),h.q.log("\uD83C\uDFAC Animation started"),this.audioSources.forEach((e,t)=>{try{e.start(0),h.q.log("\uD83C\uDFB5 Started audio source ".concat(t))}catch(e){h.q.warn("⚠️ Audio source ".concat(t," already playing or ended"))}}))}pause(){this.isPlaying=!1,this.clock.stop(),this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null),this.audioSources.forEach((e,t)=>{try{e.stop(),h.q.log("\uD83C\uDFB5 Stopped audio source ".concat(t))}catch(e){h.q.warn("⚠️ Audio source ".concat(t," already stopped"))}})}stop(){this.pause(),this.clock.elapsedTime=0}createMockAudioData(){let e=Array(256),t=Array(256);for(let a=0;a<256;a++)e[a]=.5*Math.sin(2*this.clock.elapsedTime+.1*a)+.5,t[a]=.3*Math.cos(3*this.clock.elapsedTime+.05*a)+.3;return{frequencies:e,timeData:t,volume:(Math.sin(1.5*this.clock.elapsedTime)+1)*.5,bass:(Math.sin(.8*this.clock.elapsedTime)+1)*.5,mid:(Math.sin(1.2*this.clock.elapsedTime)+1)*.5,treble:(Math.sin(2*this.clock.elapsedTime)+1)*.5}}createMockMidiData(){return{activeNotes:[],currentTime:this.clock.elapsedTime,tempo:120,totalNotes:0,trackActivity:{}}}updateMIDIData(e){this.currentMidiData=e,h.q.log("\uD83C\uDFB5 MIDI data received:",e)}updateAudioData(e){this.currentAudioData=e,h.q.log("\uD83C\uDFB5 Audio data received:",e)}updateEffectParameter(e,t,a){let i=this.effects.get(e);i&&i.parameters.hasOwnProperty(t)?(i.parameters[t],i.parameters[t]=a,"function"==typeof i.updateParameter&&i.updateParameter(t,a)):i?i.parameters.hasOwnProperty(t)||console.warn("⚠️ Parameter ".concat(t," not found in effect ").concat(e)):console.warn("⚠️ Effect ".concat(e," not found"))}getFPS(){return this.fps}getMemoryUsage(){var e;return{geometries:this.renderer.info.memory.geometries,textures:this.renderer.info.memory.textures,programs:(null===(e=this.renderer.info.programs)||void 0===e?void 0:e.length)||0}}dispose(){h.q.log("\uD83D\uDDD1️ VisualizerManager.dispose() called. Effects: ".concat(this.effects.size)),this.stop(),this.bloomEffect&&(this.bloomEffect.destroy(),this.bloomEffect=null),h.q.log("\uD83D\uDDD1️ Disposing ".concat(this.effects.size," effects")),this.effects.forEach(e=>e.destroy()),this.effects.clear(),h.q.log("\uD83D\uDDD1️ Effects cleared. Remaining: ".concat(this.effects.size)),this.scene.traverse(e=>{e instanceof f.Kj0&&(e.geometry.dispose(),e.material instanceof Array?e.material.forEach(e=>e.dispose()):e.material.dispose())}),this.renderer.dispose()}async loadAudioBuffer(e){if(!this.audioContext)throw Error("AudioContext not initialized");try{h.q.log("Audio buffer length:",e.byteLength),h.q.log("First 16 bytes:",Array.from(new Uint8Array(e.slice(0,16)))),this.currentAudioBuffer=await this.audioContext.decodeAudioData(e);let t=this.audioContext.createBufferSource();t.buffer=this.currentAudioBuffer,t.connect(this.audioContext.destination),this.audioSources||(this.audioSources=[]),this.audioSources.push(t)}catch(e){throw h.q.error("❌ Failed to load audio buffer:",e),e}}setGlobalScale(e){this.visualParams.globalScale=e,this.effects.forEach(t=>{"setScale"in t&&t.setScale(e)})}setRotationSpeed(e){this.visualParams.rotationSpeed=e,this.effects.forEach(t=>{"setRotationSpeed"in t&&t.setRotationSpeed(e)})}setColorIntensity(e){this.visualParams.colorIntensity=e,this.effects.forEach(t=>{"setColorIntensity"in t&&t.setColorIntensity(e)})}setEmissionIntensity(e){this.visualParams.emissionIntensity=e,this.effects.forEach(t=>{"setEmissionIntensity"in t&&t.setEmissionIntensity(e)})}setPositionOffset(e){this.visualParams.positionOffset=e,this.effects.forEach(t=>{"setPositionOffset"in t&&t.setPositionOffset(e)})}setHeightScale(e){this.visualParams.heightScale=e,this.effects.forEach(t=>{"setHeightScale"in t&&t.setHeightScale(e)})}setHueRotation(e){this.visualParams.hueRotation=e,this.effects.forEach(t=>{"setHueRotation"in t&&t.setHueRotation(e)})}setBrightness(e){this.visualParams.brightness=e,this.effects.forEach(t=>{"setBrightness"in t&&t.setBrightness(e)})}setComplexity(e){this.visualParams.complexity=e,this.effects.forEach(t=>{"setComplexity"in t&&t.setComplexity(e)})}setParticleSize(e){this.visualParams.particleSize=e,this.effects.forEach(t=>{"setParticleSize"in t&&t.setParticleSize(e)})}setOpacity(e){this.visualParams.opacity=e,this.effects.forEach(t=>{"setOpacity"in t&&t.setOpacity(e)})}setAnimationSpeed(e){this.visualParams.animationSpeed=e,this.effects.forEach(t=>{"setAnimationSpeed"in t&&t.setAnimationSpeed(e)})}setParticleCount(e){this.visualParams.particleCount=e,this.effects.forEach(t=>{"setParticleCount"in t&&t.setParticleCount(e)})}updateSettings(e){Object.entries(e).forEach(e=>{let[t,a]=e;switch(t){case"globalIntensity":this.setColorIntensity(a),this.setEmissionIntensity(a);break;case"smoothingFactor":this.effects.forEach(e=>{"setSmoothingFactor"in e&&e.setSmoothingFactor(a)});break;case"responsiveness":this.effects.forEach(e=>{"setResponsiveness"in e&&e.setResponsiveness(a)})}})}handleViewportResize(e,t){this.renderer.setSize(e,t),this.camera.aspect=e/t,this.camera.updateProjectionMatrix(),this.effects.forEach(a=>{var i;"uniforms"in a&&(null===(i=a.uniforms)||void 0===i?void 0:i.uResolution)&&a.uniforms.uResolution.value.set(e,t)}),this.bloomEffect&&this.bloomEffect.handleResize(e,t),h.q.log("\uD83C\uDFA8 Responsive resize:",e,t,"aspect:",this.camera.aspect)}createCompositionLayer(){let e=this.camera.aspect,t=new f.iKG(-(2*e/2),2*e/2,1,-1,.1,1e3);t.position.set(0,0,1),t.lookAt(0,0,0);let a=new f.xsS;return{scene:a,camera:t,addVideoLayer:(e,t,i)=>{let r=new f.fO1(e),s=new f._12(1,1),n=new f.vBJ({map:r}),o=new f.Kj0(s,n);return o.position.set(t.x,t.y,0),o.scale.set(i.x,i.y,1),a.add(o),o},addImageLayer:(e,t,i)=>{let r=new f.dpR().load(e.src),s=new f._12(1,1),n=new f.vBJ({map:r}),o=new f.Kj0(s,n);return o.position.set(t.x,t.y,0),o.scale.set(i.x,i.y,1),a.add(o),o}}}getAudioTextureManager(){return this.audioTextureManager}getMediaLayerManager(){return this.mediaLayerManager}enableGPUCompositing(){this.bloomEffect&&(this.bloomEffect.enableMultiLayerCompositing(),h.q.log("\uD83C\uDFA8 GPU compositing enabled"))}disableGPUCompositing(){this.bloomEffect&&(this.bloomEffect.disableMultiLayerCompositing(),h.q.log("\uD83C\uDFA8 GPU compositing disabled"))}loadAudioAnalysisForGPU(e){this.audioTextureManager&&(this.audioTextureManager.loadAudioAnalysis(e),h.q.log("\uD83C\uDFB5 Audio analysis loaded into GPU textures"))}constructor(e,t){this.animationId=null,this.effects=new Map,this.isPlaying=!1,this.lastTime=0,this.audioContext=null,this.audioSources=[],this.currentAudioBuffer=null,this.bloomEffect=null,this.audioTextureManager=null,this.mediaLayerManager=null,this.frameCount=0,this.fps=60,this.lastFPSUpdate=0,this.consecutiveSlowFrames=0,this.maxSlowFrames=10,this.visualParams={globalScale:1,rotationSpeed:0,colorIntensity:1,emissionIntensity:1,positionOffset:0,heightScale:1,hueRotation:0,brightness:1,complexity:.5,particleSize:1,opacity:1,animationSpeed:1,particleCount:5e3},this.animate=()=>{if(!this.isPlaying)return;this.animationId=requestAnimationFrame(this.animate);let e=performance.now(),t=e-this.lastTime;if(t<1e3/30)return;if(t>100){if(this.consecutiveSlowFrames++,this.consecutiveSlowFrames>=this.maxSlowFrames){h.q.error("\uD83D\uDEA8 Emergency pause: ".concat(this.maxSlowFrames," consecutive slow frames detected. Pausing to prevent browser freeze.")),this.pause(),setTimeout(()=>{h.q.log("\uD83D\uDCA1 Tip: Try refreshing the page or closing other browser tabs to improve performance.")},1e3);return}this.lastTime=e;return}this.consecutiveSlowFrames=0;let a=Math.min(this.clock.getDelta(),.1);if(this.frameCount++,e-this.lastFPSUpdate>1e3&&(this.fps=Math.round(1e3*this.frameCount/(e-this.lastFPSUpdate)),this.frameCount=0,this.lastFPSUpdate=e),this.frameCount%300==0){let e=this.getMemoryUsage();(e.geometries>100||e.textures>50)&&h.q.warn("⚠️ High memory usage detected: ".concat(e.geometries," geometries, ").concat(e.textures," textures"))}let i=0,r=0;if(this.effects.forEach(e=>{if(e.enabled&&r<3){i++,r++;try{let t=this.currentAudioData||this.createMockAudioData(),i=this.currentMidiData||this.createMockMidiData();e.update(a,t,i)}catch(t){h.q.error("❌ Effect ".concat(e.id," update failed:"),t),e.enabled=!1}}else e.enabled&&i++}),this.audioTextureManager&&this.currentAudioData){let t={features:{main:[this.currentAudioData.volume,this.currentAudioData.bass,this.currentAudioData.mid,this.currentAudioData.treble]},duration:0,sampleRate:44100,stemTypes:["main"]};this.audioTextureManager.updateTime(e/1e3,t.duration)}if(this.mediaLayerManager&&this.currentAudioData){let e={"main-volume":this.currentAudioData.volume,"main-bass":this.currentAudioData.bass,"main-mid":this.currentAudioData.mid,"main-treble":this.currentAudioData.treble};this.mediaLayerManager.updateWithAudioFeatures(e),this.mediaLayerManager.updateTextures()}if(this.bloomEffect){let e=this.currentAudioData||this.createMockAudioData(),t=this.currentMidiData||this.createMockMidiData();this.bloomEffect.update(a,e,t),this.bloomEffect.render()}else this.renderer.render(this.scene,this.camera);this.lastTime=e},h.q.log("\uD83C\uDFAD VisualizerManager constructor called"),this.instanceId=++C.instanceCounter,this.canvas=e,this.clock=new f.SUY,this.initScene(t),this.setupEventListeners(),this.initBloomEffect(),this.initAudioTextureManager(),this.initMediaLayerManager(),h.q.log("\uD83C\uDFAD VisualizerManager constructor complete")}}C.instanceCounter=0;class D{setupUniforms(){this.uniforms={uTime:{value:0},uIntensity:{value:1},uResolution:{value:new f.FM8(1024,1024)},uCameraPos:{value:new f.Pa4(0,0,3)},uCameraTarget:{value:new f.Pa4(0,0,0)},uBaseRadius:{value:this.parameters.baseRadius},uSmoothingFactor:{value:this.parameters.smoothingFactor},uNoiseIntensity:{value:this.parameters.noiseIntensity},uAnimationSpeed:{value:this.parameters.animationSpeed},uHighlightColor:{value:new f.Ilk(...this.parameters.highlightColor)}}}init(e,t,a){this.scene=e,this.camera=t,this.renderer=a;let i=a.getSize(new f.FM8);this.uniforms.uResolution.value.set(i.x,i.y),this.createMaterial(),this.createMesh()}createMaterial(){try{this.material=new f.jyz({vertexShader:"\n      varying vec2 vUv;\n      \n      void main() {\n        vUv = uv;\n        gl_Position = vec4(position, 1.0);\n      }\n    ",fragmentShader:"\n      precision highp float;\n\n      uniform float uTime;\n      uniform float uIntensity;\n      uniform vec2 uResolution;\n      uniform vec3 uCameraPos;\n      uniform vec3 uCameraTarget;\n      uniform float uBaseRadius;\n      uniform float uSmoothingFactor;\n      uniform float uNoiseIntensity;\n      uniform float uAnimationSpeed;\n      uniform vec3 uHighlightColor;\n      varying vec2 vUv;\n\n      const int MAX_STEPS = 32;\n      const float MIN_DIST = 0.0;\n      const float MAX_DIST = 50.0;\n      const float EPSILON = 0.002;\n\n      // Gooey neon palette\n      vec3 neon1 = vec3(0.7, 0.2, 1.0); // purple\n      vec3 neon2 = vec3(0.2, 0.7, 1.0); // blue\n      vec3 neon3 = vec3(0.9, 0.3, 0.8); // pink\n\n      // 3D noise for organic movement\n      vec3 random3(vec3 c) {\n        float j = 4096.0 * sin(dot(c, vec3(17.0, 59.4, 15.0)));\n        vec3 r;\n        r.z = fract(512.0 * j);\n        j *= 0.125;\n        r.x = fract(512.0 * j);\n        j *= 0.125;\n        r.y = fract(512.0 * j);\n        return r - 0.5;\n      }\n      float noise(vec3 p) {\n        vec3 pi = floor(p);\n        vec3 pf = p - pi;\n        vec3 u = pf * pf * (3.0 - 2.0 * pf);\n        return mix(mix(mix(dot(random3(pi + vec3(0, 0, 0)), pf - vec3(0, 0, 0)),\n                          dot(random3(pi + vec3(1, 0, 0)), pf - vec3(1, 0, 0)), u.x),\n                      mix(dot(random3(pi + vec3(0, 1, 0)), pf - vec3(0, 1, 0)),\n                          dot(random3(pi + vec3(1, 1, 0)), pf - vec3(1, 1, 0)), u.x), u.y),\n                  mix(mix(dot(random3(pi + vec3(0, 0, 1)), pf - vec3(0, 0, 1)),\n                          dot(random3(pi + vec3(1, 0, 1)), pf - vec3(1, 0, 1)), u.x),\n                      mix(dot(random3(pi + vec3(0, 1, 1)), pf - vec3(0, 1, 1)),\n                          dot(random3(pi + vec3(1, 1, 1)), pf - vec3(1, 1, 1)), u.x), u.y), u.z);\n      }\n      float smin(float a, float b, float k) {\n        float h = max(k - abs(a - b), 0.0) / k;\n        return min(a, b) - h * h * h * k * (1.0 / 6.0);\n      }\n      float sphere(vec3 p, float s) {\n        return length(p) - s;\n      }\n      float map(vec3 pos) {\n        float t = uTime * uAnimationSpeed * 0.5;\n        float intensity = 0.5 + uIntensity * 0.5;\n        float noiseAmt = uNoiseIntensity * 0.05;\n        vec3 sphere1Pos = vec3(sin(t) * 0.8, cos(t * 1.3) * 0.6, sin(t * 0.7) * 0.4);\n        vec3 sphere2Pos = vec3(cos(t * 1.1) * 0.6, sin(t * 0.9) * 0.8, cos(t * 1.4) * 0.5);\n        vec3 sphere3Pos = vec3(sin(t * 1.7) * 0.4, cos(t * 0.6) * 0.3, sin(t * 1.2) * 0.6);\n        vec3 sphere4Pos = vec3(cos(t * 0.8) * 0.7, sin(t * 1.5) * 0.4, cos(t) * 0.3);\n        sphere1Pos += vec3(sin(t * 2.3), cos(t * 1.9), sin(t * 2.7)) * noiseAmt;\n        sphere2Pos += vec3(cos(t * 1.7), sin(t * 2.1), cos(t * 1.3)) * noiseAmt;\n        sphere3Pos += vec3(sin(t * 3.1), cos(t * 2.5), sin(t * 1.8)) * noiseAmt;\n        sphere4Pos += vec3(cos(t * 2.9), sin(t * 1.6), cos(t * 2.2)) * noiseAmt;\n        float radius1 = uBaseRadius * 1.2 + intensity * 0.2;\n        float radius2 = uBaseRadius * 1.0 + intensity * 0.15;\n        float radius3 = uBaseRadius * 0.8 + intensity * 0.1;\n        float radius4 = uBaseRadius * 0.6 + intensity * 0.1;\n        float d1 = sphere(pos - sphere1Pos, radius1);\n        float d2 = sphere(pos - sphere2Pos, radius2);\n        float d3 = sphere(pos - sphere3Pos, radius3);\n        float d4 = sphere(pos - sphere4Pos, radius4);\n        float smoothness = uSmoothingFactor;\n        float result = smin(d1, d2, smoothness);\n        result = smin(result, d3, smoothness);\n        result = smin(result, d4, smoothness);\n        return result;\n      }\n      vec3 calcNormal(vec3 pos) {\n        vec2 e = vec2(EPSILON, 0.0);\n        return normalize(vec3(\n          map(pos + e.xyy) - map(pos - e.xyy),\n          map(pos + e.yxy) - map(pos - e.yxy),\n          map(pos + e.yyx) - map(pos - e.yyx)\n        ));\n      }\n      float rayMarch(vec3 ro, vec3 rd) {\n        float dO = MIN_DIST;\n        for (int i = 0; i < MAX_STEPS; i++) {\n          vec3 p = ro + rd * dO;\n          float dS = map(p);\n          dO += dS;\n          if (dO > MAX_DIST || abs(dS) < EPSILON) break;\n        }\n        return dO;\n      }\n      vec3 getNeonColor(vec3 pos, float fresnel, float edge, float core) {\n        float mix1 = 0.5 + 0.5 * sin(pos.x * 2.0 + uTime * 0.7);\n        float mix2 = 0.5 + 0.5 * cos(pos.y * 2.0 + uTime * 1.1);\n        vec3 color = mix(neon1, neon2, mix1);\n        color = mix(color, neon3, mix2 * fresnel);\n        color += vec3(1.0, 0.7, 1.0) * pow(edge, 2.5) * 1.2;\n        color += uHighlightColor * pow(core, 2.0) * 0.7;\n        return color;\n      }\n\n      // Thickness approximation for more liquid look\n      float getThickness(vec3 pos, vec3 normal) {\n        // Sample SDF in both directions to estimate thickness\n        float stepSize = 0.08;\n        float t1 = abs(map(pos + normal * stepSize));\n        float t2 = abs(map(pos - normal * stepSize));\n        return 1.0 - clamp((t1 + t2) * 2.5, 0.0, 1.0); // 0 = thin, 1 = thick\n      }\n\n      // 3D value noise with trilinear interpolation\n      float hash(vec3 p) {\n        p = fract(p * 0.3183099 + .1);\n        p *= 17.0;\n        return fract(p.x * p.y * p.z * (p.x + p.y + p.z));\n      }\n      float valueNoise3D(vec3 p) {\n        vec3 pi = floor(p);\n        vec3 pf = fract(p);\n        // 8 corners of the cube\n        float a000 = hash(pi + vec3(0,0,0));\n        float a100 = hash(pi + vec3(1,0,0));\n        float a010 = hash(pi + vec3(0,1,0));\n        float a110 = hash(pi + vec3(1,1,0));\n        float a001 = hash(pi + vec3(0,0,1));\n        float a101 = hash(pi + vec3(1,0,1));\n        float a011 = hash(pi + vec3(0,1,1));\n        float a111 = hash(pi + vec3(1,1,1));\n        // Trilinear interpolation\n        float k0 = a000;\n        float k1 = a100 - a000;\n        float k2 = a010 - a000;\n        float k3 = a001 - a000;\n        float k4 = a000 - a100 - a010 + a110;\n        float k5 = a000 - a010 - a001 + a011;\n        float k6 = a000 - a100 - a001 + a101;\n        float k7 = -a000 + a100 + a010 - a110 + a001 - a101 - a011 + a111;\n        vec3 u = pf;\n        return k0 + k1 * u.x + k2 * u.y + k3 * u.z + k4 * u.x * u.y + k5 * u.y * u.z + k6 * u.z * u.x + k7 * u.x * u.y * u.z;\n      }\n\n      void main() {\n        vec2 uv = (vUv - 0.5) * 2.0;\n        \n        // Apply aspect ratio correction to prevent stretching\n        float aspectRatio = uResolution.x / uResolution.y;\n        uv.x *= aspectRatio;\n        \n        vec3 cameraPos = uCameraPos;\n        vec3 cameraTarget = uCameraTarget;\n        vec3 cameraDir = normalize(cameraTarget - cameraPos);\n        vec3 cameraRight = normalize(cross(cameraDir, vec3(0.0, 1.0, 0.0)));\n        vec3 cameraUp = cross(cameraRight, cameraDir);\n        vec3 rayDir = normalize(cameraDir + uv.x * cameraRight + uv.y * cameraUp);\n        float dist = rayMarch(cameraPos, rayDir);\n        vec4 finalColor = vec4(0.0);\n        if (dist < MAX_DIST) {\n          vec3 pos = cameraPos + rayDir * dist;\n          vec3 normal = calcNormal(pos);\n          float fresnel = pow(1.0 - max(0.0, dot(normal, -rayDir)), 2.5);\n          float edge = smoothstep(0.0, 0.08, abs(map(pos)));\n          float core = 1.0 - edge;\n          float thickness = getThickness(pos, normal);\n          // Water droplet color using value noise and reflection vector\n          vec3 reflectDir = reflect(rayDir, normal);\n          // Define unique offsets for each metaball\n          vec3 offsets[4];\n          offsets[0] = vec3(1.3, 2.1, 0.7);\n          offsets[1] = vec3(-2.2, 0.5, 1.8);\n          offsets[2] = vec3(0.9, -1.4, 2.3);\n          offsets[3] = vec3(-1.7, 1.2, -2.5);\n          vec3 colorSum = vec3(0.0);\n          for (int i = 0; i < 4; i++) {\n            vec3 metaballReflect = reflectDir + offsets[i];\n            float noiseVal = valueNoise3D(metaballReflect * 2.0 + uTime * (1.0 + float(i) * 0.3));\n            float modFactor = 0.8 + 0.2 * float(i); // unique per metaball\n            colorSum += uHighlightColor * modFactor * noiseVal;\n          }\n          vec3 color = colorSum / 4.0;\n          color = pow(color, vec3(7.0));\n          // Add a subtle neon rim from before\n          color = mix(color, getNeonColor(pos, fresnel, edge, core), 0.25 * fresnel);\n          // Translucency: base alpha is very low, highlights/rims are subtle\n          float alpha = 0.07 + 0.10 * thickness;\n          alpha += 0.25 * fresnel;\n          alpha += 0.10 * pow(core, 2.0);\n          alpha = clamp(alpha, 0.0, 0.55);\n          finalColor = vec4(color, alpha);\n        }\n        gl_FragColor = finalColor;\n      }\n    ",uniforms:this.uniforms,transparent:!0,side:f.ehD})}catch(e){console.error("❌ Shader compilation error:",e),this.material=new f.vBJ({color:16711935,transparent:!0,opacity:.8})}}createMesh(){let e=new f._12(2,2);this.mesh=new f.Kj0(e,this.material),this.mesh.renderOrder=9999,this.material.depthWrite=!0,this.material.depthTest=!0,this.scene.add(this.mesh),this.mesh.position.set(0,0,0),this.mesh.scale.set(2,2,1)}updateParameter(e,t){if(this.uniforms)switch(e){case"animationSpeed":this.uniforms.uAnimationSpeed.value=t;break;case"baseRadius":this.uniforms.uBaseRadius.value=t;break;case"smoothingFactor":this.uniforms.uSmoothingFactor.value=t;break;case"noiseIntensity":this.uniforms.uNoiseIntensity.value=t;break;case"highlightColor":this.uniforms.uHighlightColor.value.set(...t)}}update(e,t,a){if(!this.uniforms)return;for(let e in this.parameters){let t="u"+e.charAt(0).toUpperCase()+e.slice(1);this.uniforms[t]&&(this.uniforms[t].value=this.parameters[e])}this.uniforms.uTime.value+=e*this.parameters.animationSpeed;let i=Math.min(a.activeNotes.length/3,1),r=t.volume;if(this.uniforms.uIntensity.value=Math.max(.8,(i+r)*1.2),this.updateCameraAnimation(a,t),a.activeNotes.length,this.uniforms.uResolution&&this.renderer){let e=this.renderer.getSize(new f.FM8);this.uniforms.uResolution.value.set(e.x,e.y)}}updateCameraAnimation(e,t){let a=this.uniforms.uTime.value,i=.3*a,r=.3*Math.sin(.2*a),s=this.baseCameraDistance;if(e.activeNotes.length>0){let t=(e.activeNotes.reduce((e,t)=>e+t.note,0)/e.activeNotes.length-60)/48,n=e.activeNotes.reduce((e,t)=>e+t.velocity,0)/e.activeNotes.length/127;i+=2*t,r+=.8*t,s+=1.5*n,i+=n*Math.sin(4*a)*.5;let o=Math.min(e.activeNotes.length,5)/5;r+=Math.sin(3*a+2*o)*o*.3,e.activeNotes.length>=3&&(i+=.4*Math.sin(2*a),s+=.3*Math.cos(1.5*a))}let n=.3*t.volume;s+=n,r+=Math.sin(5*a)*n*.2;let o=new f.Pa4(Math.cos(i)*s,r+this.cameraHeight,Math.sin(i)*s);this.uniforms.uCameraPos.value.lerp(o,this.cameraSmoothing);let l=new f.Pa4(0,0,0);if(e.activeNotes.length>2){let t=Math.min(e.activeNotes.length/5,1);l.x=Math.sin(2*a)*t*.2,l.y=Math.cos(1.5*a)*t*.1}this.uniforms.uCameraTarget.value.copy(l)}destroy(){this.mesh&&(this.scene.remove(this.mesh),this.mesh.geometry.dispose(),this.material.dispose())}constructor(e={}){this.id="metaballs",this.name="MIDI Metaballs",this.description="Fluid droplet-like spheres that respond to MIDI notes",this.enabled=!0,this.baseCameraDistance=3,this.cameraOrbitRadius=2,this.cameraHeight=1,this.cameraSmoothing=.02,this.parameters={trailLength:15,baseRadius:.25,smoothingFactor:.3,colorPalette:["#CC66FF","#33CCFF","#FF9933"],animationSpeed:.8,noiseIntensity:1.5,highlightColor:[.8,.5,1],...e},this.setupUniforms()}}class j{screenToWorld(e,t){if(!this.renderer||!this.camera)return new f.Pa4;let a=this.renderer.getSize(new f.FM8),i=e/a.x*2-1,r=-(t/a.y*2-1),s=new f.Pa4(i,r,0);return s.unproject(this.camera),s}setupUniforms(){this.uniforms={uTime:{value:0},uIntensity:{value:1},uGlowIntensity:{value:1},uGlowSoftness:{value:this.parameters.glowSoftness},uSizeMultiplier:{value:1}}}init(e,t,a){console.log("\uD83C\uDF1F ParticleNetworkEffect.init() called"),this.scene=e,this.camera=t,this.renderer=a,this.createParticleSystem(),this.createConnectionSystem(),this.uniforms&&(this.uniforms.uSizeMultiplier.value=this.parameters.particleSize),console.log("\uD83C\uDF1F Particle Network initialized")}createParticleSystem(){let e=new f._12(1,1);this.material=new f.jyz({vertexShader:"\n      attribute vec3 instanceColor;\n      attribute float instanceLife;\n      attribute float instanceSize;\n      varying vec3 vColor;\n      varying float vLife;\n      varying float vSize;\n      varying vec2 vUv;\n      \n      void main() {\n        vColor = instanceColor;\n        vLife  = instanceLife;\n        vSize  = instanceSize;\n        vUv    = uv;\n        \n        gl_Position = projectionMatrix * modelViewMatrix * instanceMatrix * vec4(position, 1.0);\n      }\n    ",fragmentShader:"\n      precision highp float;\n      uniform float uGlowIntensity;\n      uniform float uGlowSoftness;\n      varying vec3 vColor;\n      varying float vLife;\n      varying float vSize;\n      varying vec2 vUv;\n      \n      void main() {\n        vec2 center = vUv - 0.5;\n        float dist = length(center);\n        if (dist > 0.5) discard; // keep circle\n        \n        // bloom using distance falloff with adjustable softness exponent\n        float glow = pow(max(0.0, 0.5 - dist), uGlowSoftness);\n        vec3 color = vColor * (1.0 + glow * uGlowIntensity * 0.6);\n        \n        float alpha = glow * vLife;\n        gl_FragColor = vec4(color, alpha);\n      }\n    ",uniforms:this.uniforms,transparent:!0,blending:f.WMw,depthWrite:!1,depthTest:!1,vertexColors:!0});let t=this.parameters.maxParticles;this.instancedMesh=new f.SPe(e,this.material,t),this.instanceColors=new Float32Array(3*t),this.instanceLives=new Float32Array(t),this.instanceSizes=new Float32Array(t),this.instancedMesh.instanceMatrix.setUsage(f.dj0),this.instancedMesh.geometry.setAttribute("instanceColor",new f.lb7(this.instanceColors,3,!1)),this.instancedMesh.geometry.setAttribute("instanceLife",new f.lb7(this.instanceLives,1,!1)),this.instancedMesh.geometry.setAttribute("instanceSize",new f.lb7(this.instanceSizes,1,!1)),this.initializeDefaultParticles(),this.scene.add(this.instancedMesh)}initializeDefaultParticles(){for(let e=0;e<5;e++){let t=this.createParticle(60+e,64,"default");this.particles.push(t)}this.updateBuffers()}getRandomSpawnPosition(){return new f.Pa4((Math.random()-.5)*4,(Math.random()-.5)*4,0)}createParticle(e,t,a){let i,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"midi",s=arguments.length>4?arguments[4]:void 0,n=arguments.length>5?arguments[5]:void 0,o=this.getRandomSpawnPosition(),l=new f.Pa4((Math.random()-.5)*.02,(Math.random()-.5)*.02,(Math.random()-.5)*.02);return i="audio"===r&&void 0!==n?this.parameters.particleSize*(.5+1.5*n):3+t/127*5,{position:o,velocity:l,life:1,maxLife:this.parameters.particleLifetime,size:i,note:e,noteVelocity:t,track:a,audioFeature:s,audioValue:n,spawnType:r}}getNoteColor(e,t){let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"midi",i=arguments.length>3?arguments[3]:void 0,r=new f.Ilk(this.parameters.particleColor[0],this.parameters.particleColor[1],this.parameters.particleColor[2]);if("audio"===a&&void 0!==i)return new f.Ilk().setHSL(.3*i%1,.7,.6).lerp(r,.5);{let a=new f.Ilk;return a.setHSL(e%12/12,.4+t/127*.3,.5+t/127*.2),a.lerp(r,.3)}}updateParticles(e,t,a){t.activeNotes.forEach(e=>{if(this.particles.length<this.parameters.maxParticles&&!this.particles.some(t=>t.note===e.note&&t.life>.8&&"midi"===t.spawnType)){let t=this.createParticle(e.note,e.velocity,e.track,"midi");this.particles.push(t)}}),this.parameters.particleSpawning>=this.parameters.spawnThreshold&&this.spawnManualParticles(e);for(let t=this.particles.length-1;t>=0;t--){let a=this.particles[t];if(a.life-=e/a.maxLife,a.life<=0){this.particles.splice(t,1);continue}a.velocity.multiplyScalar(.98),a.position.add(a.velocity)}this.updateBuffers(),this.updateConnections()}spawnManualParticles(e){let t=performance.now()/1e3;if(!(t-this.lastManualSpawnTime<.1)&&Math.random()<Math.min(2*(this.parameters.particleSpawning-this.parameters.spawnThreshold),.5)&&this.particles.length<this.parameters.maxParticles){let e=this.createParticle(60,Math.floor(127*this.parameters.particleSpawning),"manual","audio","manual",this.parameters.particleSpawning);this.particles.push(e),this.lastManualSpawnTime=t}}updateBuffers(){let e=this.camera.quaternion,t=0;this.particles.forEach(a=>{if(t>=this.parameters.maxParticles)return;let i=Math.min(this.parameters.particleSize,30),r=.02*a.size*i,s=new f.Pa4(r,r,1);this.dummyMatrix.compose(a.position,e,s),this.instancedMesh.setMatrixAt(t,this.dummyMatrix);let n=this.getNoteColor(a.note,a.noteVelocity,a.spawnType,a.audioValue);this.instanceColors[3*t]=n.r,this.instanceColors[3*t+1]=n.g,this.instanceColors[3*t+2]=n.b,this.instanceLives[t]=a.life,this.instanceSizes[t]=a.size,t++}),this.instancedMesh.count=t,this.instancedMesh.instanceMatrix.needsUpdate=!0,this.instancedMesh.geometry.getAttribute("instanceColor").needsUpdate=!0,this.instancedMesh.geometry.getAttribute("instanceLife").needsUpdate=!0,this.instancedMesh.geometry.getAttribute("instanceSize").needsUpdate=!0}createConnectionSystem(){this.connectionGeometry=new f.u9r,this.connectionPositions=new Float32Array(6*this.maxConnections),this.connectionColors=new Float32Array(6*this.maxConnections),this.connectionGeometry.setAttribute("position",new f.TlE(this.connectionPositions,3)),this.connectionGeometry.setAttribute("color",new f.TlE(this.connectionColors,3)),this.connectionMaterial=new f.nls({vertexColors:!0,transparent:!0,opacity:.8,blending:f.WMw,depthTest:!1}),this.connectionLines=new f.ejS(this.connectionGeometry,this.connectionMaterial),this.scene.add(this.connectionLines)}updateConnections(){this.activeConnections=0,this.connectionPositions.fill(0),this.connectionColors.fill(0);let e=0;for(let t=0;t<this.particles.length-1&&e<this.maxConnections;t++)for(let a=t+1;a<this.particles.length&&e<this.maxConnections;a++){let i=this.particles[t],r=this.particles[a],s=i.position.distanceTo(r.position);s<this.parameters.connectionDistance&&(this.createConnection(i,r,s,e),e++)}this.connectionGeometry.attributes.position.needsUpdate=!0,this.connectionGeometry.attributes.color.needsUpdate=!0,this.connectionGeometry.setDrawRange(0,2*e)}createConnection(e,t,a,i){let r=(1-a/this.parameters.connectionDistance)*Math.min(e.life,t.life)*((e.noteVelocity+t.noteVelocity)/254),s=new f.Ilk().lerpColors(this.getNoteColor(e.note,e.noteVelocity),this.getNoteColor(t.note,t.noteVelocity),.5),n=6*i;this.connectionPositions[n]=e.position.x,this.connectionPositions[n+1]=e.position.y,this.connectionPositions[n+2]=e.position.z,this.connectionPositions[n+3]=t.position.x,this.connectionPositions[n+4]=t.position.y,this.connectionPositions[n+5]=t.position.z;let o=6*i;this.connectionColors[o]=s.r*r,this.connectionColors[o+1]=s.g*r,this.connectionColors[o+2]=s.b*r,this.connectionColors[o+3]=s.r*r,this.connectionColors[o+4]=s.g*r,this.connectionColors[o+5]=s.b*r}updateParameter(e,t){switch(e){case"maxParticles":case"connectionDistance":case"particleLifetime":case"particleColor":break;case"glowIntensity":this.uniforms&&(this.uniforms.uGlowIntensity.value=t);break;case"glowSoftness":this.parameters.glowSoftness=t,this.uniforms&&(this.uniforms.uGlowSoftness.value=t);break;case"particleSize":this.parameters.particleSize=t;break;case"particleSpawning":this.parameters.particleSpawning=t;break;case"spawnThreshold":this.parameters.spawnThreshold=t}}update(e,t,a){if(!this.uniforms){console.warn("⚠️ Uniforms not initialized in ParticleNetworkEffect.update()");return}for(let e in this.currentAudioData=t,this.parameters){let t="u"+e.charAt(0).toUpperCase()+e.slice(1);this.uniforms[t]&&(this.uniforms[t].value=this.parameters[e])}this.uniforms.uTime.value+=e,this.uniforms.uIntensity.value=Math.max(.5,Math.min(a.activeNotes.length/3,2)),this.uniforms.uGlowIntensity.value=this.parameters.glowIntensity,this.instancedMesh&&(this.instancedMesh.visible=!0),this.frameSkipCounter++,this.frameSkipCounter>=this.frameSkipInterval&&(this.frameSkipCounter=0,this.updateParticles(e*this.frameSkipInterval,a,t))}destroy(){this.instancedMesh&&(this.scene.remove(this.instancedMesh),this.material.dispose()),this.connectionLines&&(this.scene.remove(this.connectionLines),this.connectionGeometry.dispose(),this.connectionMaterial.dispose())}constructor(){this.id="particleNetwork",this.name="MIDI & Audio Particle Network",this.description="Glowing particle network that responds to MIDI notes and audio features",this.enabled=!0,this.parameters={maxParticles:50,connectionDistance:1,particleLifetime:3,glowIntensity:.6,glowSoftness:3,particleColor:[1,1,1],particleSize:15,particleSpawning:0,spawnThreshold:.5},this.particles=[],this.maxConnections=500,this.activeConnections=0,this.frameSkipCounter=0,this.frameSkipInterval=2,this.dummyMatrix=new f.yGw,this.lastAudioSpawnTime=0,this.lastManualSpawnTime=0,this.currentAudioData=null,this.setupUniforms()}}var M=a(5720),N=a(3731),T=a.n(N);function A(e){let{children:t,title:a,isOpen:s,onClose:n,initialPosition:o={x:0,y:0},className:l,bounds:c="#editor-bounds",portalContainerId:d="modal-portal-root"}=e,u=(0,r.useRef)(null),[m,f]=(0,r.useState)(null),[p,y]=(0,r.useState)(null),g=(0,r.useCallback)(()=>{var e;if(!c)return;let t=document.querySelector(c);if(!t)return;let a=t.getBoundingClientRect(),i=(null===(e=u.current)||void 0===e?void 0:e.offsetHeight)||400;y({left:Math.floor(a.left),top:Math.floor(a.top),right:Math.floor(a.right-288),bottom:Math.floor(a.bottom-i)})},[c]);if((0,r.useEffect)(()=>{if(!s)return;g(),window.addEventListener("resize",g);let e=new MutationObserver(g),t=document.querySelector(c||"");return t&&e.observe(t,{attributes:!0,childList:!0,subtree:!0}),()=>{window.removeEventListener("resize",g),e.disconnect()}},[s,c,g]),(0,r.useEffect)(()=>{let e=document.getElementById(d);return e||((e=document.createElement("div")).id=d,e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100vw",e.style.height="100vh",e.style.pointerEvents="none",e.style.zIndex="50",document.body.appendChild(e)),f(e),()=>{e&&0===e.childNodes.length&&setTimeout(()=>{if(e&&0===e.childNodes.length&&e.parentNode)try{document.body.removeChild(e)}catch(e){console.warn("Portal container cleanup error:",e)}},100)}},[d]),!s||!m)return null;let x=(0,i.jsx)("div",{style:{pointerEvents:"auto"},children:(0,i.jsx)(T(),{nodeRef:u,handle:".drag-handle",defaultPosition:o,bounds:p||void 0,onStart:g,onDrag:g,children:(0,i.jsxs)("div",{ref:u,className:(0,h.cn)("absolute top-0 left-0 w-72 rounded-lg shadow-2xl","bg-white/10 backdrop-blur-xl border border-white/20",l),style:{background:"linear-gradient(to bottom, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05))"},children:[(0,i.jsxs)("div",{className:"drag-handle cursor-move bg-white p-1 rounded-t-md border-b border-black/30 flex items-center gap-1.5 h-7",children:[(0,i.jsxs)("button",{onClick:n,className:"w-4 h-4 border border-black/80 flex-shrink-0 bg-white hover:bg-gray-100 transition-colors duration-200 flex items-center justify-center group relative","aria-label":"Close",children:[(0,i.jsx)("div",{className:"absolute w-full h-0.5 bg-black transform rotate-45 scale-x-0 group-hover:scale-x-100 transition-transform duration-200"}),(0,i.jsx)("div",{className:"absolute w-full h-0.5 bg-black transform -rotate-45 scale-x-0 group-hover:scale-x-100 transition-transform duration-200"})]}),(0,i.jsxs)("div",{className:"flex-grow flex items-center justify-center gap-1.5 overflow-hidden",children:[(0,i.jsx)("div",{className:"space-y-0.5 flex-grow",children:Array.from({length:6}).map((e,t)=>(0,i.jsx)("div",{className:"h-px bg-black"},t))}),(0,i.jsx)("span",{className:"flex-shrink-0 bg-white px-1 text-xs font-mono font-bold text-black",children:a}),(0,i.jsx)("div",{className:"space-y-0.5 flex-grow",children:Array.from({length:6}).map((e,t)=>(0,i.jsx)("div",{className:"h-px bg-black"},t))})]})]}),(0,i.jsx)("div",{className:"p-4 rounded-b-md bg-transparent",children:t})]})})});return(0,M.createPortal)(x,m)}var F=a(8497),R=a(8370),I=a(5900);let E=r.forwardRef((e,t)=>{let{className:a,...r}=e;return(0,i.jsx)(I.fC,{className:(0,h.cn)("peer inline-flex h-[24px] w-[44px] shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input",a),...r,ref:t,children:(0,i.jsx)(I.bU,{className:(0,h.cn)("pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0")})})});E.displayName=I.fC.displayName;var P=a(6378),z=a(9413),L=a(6738);function O(e){let{value:t,onChange:a,className:s,size:n="sm"}=e,[o,l]=(0,r.useState)(!1);(0,r.useRef)(null);let c=(0,r.useRef)(0),d=(0,r.useRef)(0),u=e=>{e.preventDefault(),e.stopPropagation(),l(!0),c.current=e.clientY,d.current=t;let i=e=>{let t=c.current-e.clientY;a(Math.max(0,Math.min(1,d.current+.0075*t)))},r=()=>{l(!1),document.removeEventListener("mousemove",i),document.removeEventListener("mouseup",r)};document.addEventListener("mousemove",i),document.addEventListener("mouseup",r)};return(0,i.jsxs)("div",{className:(0,h.cn)("relative flex items-center gap-2 select-none",s),onMouseEnter:e=>e.stopPropagation(),onMouseLeave:e=>e.stopPropagation(),children:[(0,i.jsx)("div",{className:"text-xs text-white font-mono min-w-[5ch] text-right",children:(()=>{let e=Math.round((t-.5)*100);return"".concat(e>0?"+":"").concat(e,"%")})()}),(0,i.jsxs)("div",{className:(0,h.cn)("relative flex items-center justify-center cursor-ns-resize",{sm:"w-8 h-8",md:"w-10 h-10"}[n],"pointer-events-auto"),style:{pointerEvents:"auto"},onMouseDown:e=>{e.stopPropagation(),u(e)},children:[(0,i.jsx)("div",{className:(0,h.cn)("absolute inset-0 rounded-full border-2",o?"border-white/30":"border-white/20"),style:{backgroundColor:"#0b0b0b"}}),(0,i.jsx)("div",{className:"absolute left-1/2 top-1/2 origin-bottom bg-white",style:{width:2,height:"sm"===n?12:15,transform:"translate(-50%, -100%) rotate(".concat((t-.5)*270,"deg)"),borderRadius:1}})]})]})}let B=e=>{let{parameterId:t,label:a,children:s,mappedFeatureId:n,mappedFeatureName:o,modulationAmount:l=1,baseValue:c,modulatedValue:d,sliderMax:u,onFeatureDrop:m,onFeatureUnmap:h,onModulationAmountChange:f,className:p="",dropZoneStyle:y="",showTagOnHover:g=!1}=e,x={isOver:!1,canDrop:!1},v=()=>{};try{let e=(0,P.L)({accept:"feature",drop:e=>{m(t,e.id,e.stemType)},canDrop:()=>!0,collect:e=>({isOver:e.isOver(),canDrop:e.canDrop()})});x=e[0];let a=e[1];v=r.useCallback(e=>{a(e)},[a])}catch(e){console.warn("Drop context not available for DroppableParameter:",e)}let[b,w]=r.useState(!1);return(0,i.jsxs)("div",{className:"space-y-2 ".concat(p),children:[(0,i.jsxs)("div",{className:"flex items-center justify-between",children:[(0,i.jsx)("label",{className:"text-white/80 text-xs font-mono",children:a}),(0,i.jsxs)("div",{className:"flex items-center gap-2",children:[n&&f&&(0,i.jsx)("div",{className:"pointer-events-auto",onMouseEnter:e=>e.stopPropagation(),onMouseLeave:e=>e.stopPropagation(),children:(0,i.jsx)(O,{value:l,onChange:e=>f(t,e),size:"sm"})}),(0,i.jsxs)("div",{ref:v,className:"\n              relative flex items-center justify-center w-8 h-6 rounded-full cursor-pointer\n              transition-all duration-200 ease-out\n              ".concat(n?"bg-emerald-600/20 border-2 border-emerald-500/50 shadow-lg":"bg-stone-700/50 border-2 border-stone-600/50 shadow-inner","\n              ").concat(x.isOver&&x.canDrop?"scale-110 bg-emerald-500/30 border-emerald-400 shadow-lg ring-2 ring-emerald-400/50":"","\n              ").concat(n||x.isOver?"":"hover:bg-stone-600/60 hover:border-stone-500/60","\n              ").concat("inlayed"===y?"ring-2 ring-stone-900/80 shadow-[inset_0_2px_8px_rgba(0,0,0,0.7),0_2px_8px_rgba(16,185,129,0.15)]":"","\n            "),style:{boxShadow:n?"\n                  inset 0 1px 0 rgba(255, 255, 255, 0.1),\n                  inset 0 -1px 0 rgba(0, 0, 0, 0.2),\n                  0 2px 4px rgba(0, 0, 0, 0.3),\n                  0 0 8px rgba(16, 185, 129, 0.3),\n                  ".concat("inlayed"===y?"inset 0 4px 12px rgba(0,0,0,0.7)":"","\n                "):"\n                  inset 0 1px 0 rgba(255, 255, 255, 0.05),\n                  inset 0 -1px 0 rgba(0, 0, 0, 0.3),\n                  0 1px 2px rgba(0, 0, 0, 0.2),\n                  ".concat("inlayed"===y?"inset 0 4px 12px rgba(0,0,0,0.7)":"","\n                "),background:n?"linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(16, 185, 129, 0.1) 100%)":"linear-gradient(135deg, rgba(68, 64, 60, 0.5) 0%, rgba(41, 37, 36, 0.5) 100%)"},onMouseEnter:()=>w(!0),onMouseLeave:()=>w(!1),children:[!n&&(0,i.jsx)("div",{className:"\n                w-2 h-2 rounded-full transition-all duration-200\n                ".concat(x.isOver&&x.canDrop?"bg-emerald-400 scale-125":"bg-stone-400/50","\n              ")}),n&&(0,i.jsx)("div",{className:"w-2 h-2 rounded-full bg-emerald-400 animate-pulse"})]})]})]}),(0,i.jsxs)("div",{className:"relative",children:[(0,i.jsxs)("div",{className:"relative",children:["number"==typeof c&&"number"==typeof d&&"number"==typeof u&&u>0&&(0,i.jsx)("div",{className:"absolute inset-0 pointer-events-none",children:(()=>{let e=Math.max(0,Math.min(1,c/u)),t=Math.max(0,Math.min(1,d/u));return(0,i.jsx)("div",{className:"absolute top-1/2 -translate-y-1/2 h-[6px] bg-emerald-400/40 mix-blend-screen",style:{left:"".concat(100*Math.min(e,t),"%"),width:"".concat(100*Math.abs(t-e),"%"),borderRadius:3}})})()}),s]}),n&&o&&(!g||b)&&(0,i.jsx)("div",{className:"absolute -top-2 -right-2 z-10",children:(0,i.jsxs)(z.C,{className:"bg-emerald-600/90 text-emerald-100 text-xs px-2 py-1 border border-emerald-500/50 shadow-lg",style:{boxShadow:"0 2px 4px rgba(0, 0, 0, 0.3), 0 0 8px rgba(16, 185, 129, 0.2)"},children:[(0,i.jsx)("span",{className:"mr-1",children:o}),(0,i.jsx)("button",{onClick:e=>{e.stopPropagation(),h(t)},className:"ml-1 hover:bg-emerald-500/50 rounded-full p-0.5 transition-colors",children:(0,i.jsx)(L.Z,{className:"h-3 w-3"})})]})})]}),x.isOver&&x.canDrop&&!n&&(0,i.jsx)("div",{className:"text-xs text-emerald-400/80 font-mono animate-pulse",children:"Drop to map feature"})]})},W={mobile:{id:"mobile",name:"Mobile",width:9,height:16,maxWidth:"400px",maxHeight:"711px",className:"max-w-md"},youtube:{id:"youtube",name:"YouTube",width:16,height:9,maxWidth:"1280px",maxHeight:"720px",className:"max-w-4xl"},instagram:{id:"instagram",name:"Instagram",width:1,height:1,maxWidth:"600px",maxHeight:"600px",className:"max-w-lg"},tiktok:{id:"tiktok",name:"TikTok",width:9,height:16,maxWidth:"360px",maxHeight:"640px",className:"max-w-sm"},landscape:{id:"landscape",name:"Landscape",width:16,height:10,maxWidth:"1600px",maxHeight:"1000px",className:"max-w-5xl"}};function U(e){let{midiData:t,settings:a,currentTime:s,isPlaying:n,onPlayPause:o,onSettingsChange:l,onFpsUpdate:c,className:d,selectedEffects:u,onSelectedEffectsChange:m,aspectRatio:f="mobile",openEffectModals:p,onCloseEffectModal:y,mappings:g,featureNames:x,onMapFeature:v,onUnmapFeature:b,onModulationAmountChange:w,activeSliderValues:k,setActiveSliderValues:S,visualizerRef:M,layers:N,selectedLayerId:T,onLayerSelect:I,onLayerUpdate:P}=e,z=(0,r.useRef)(null),L=(0,r.useRef)(null),O=(0,r.useRef)(null),[U,q]=(0,r.useState)(null),[V,H]=(0,r.useState)(!1),[G,Z]=(0,r.useState)({width:400,height:711}),[Y,X]=(0,r.useState)({width:0,height:0}),Q=(0,r.useRef)({}),K=W[f]||W.mobile;(0,r.useEffect)(()=>{if(!L.current)return;let e=new ResizeObserver(e=>{for(let t of e){let{width:e,height:a}=t.contentRect;X({width:e,height:a})}});return e.observe(L.current),()=>{e.disconnect()}},[]),(0,r.useEffect)(()=>{Y.width>0&&Y.height>0&&Z(function(e,t,a){let{width:i,height:r}=a,s=i/r,n=e,o=e/s;if(o>t&&(o=t,n=t*s),a.maxWidth){let e=parseInt(a.maxWidth);n>e&&(n=e,o=e/s)}if(a.maxHeight){let e=parseInt(a.maxHeight);o>e&&(o=e,n=e*s)}return{width:Math.floor(n),height:Math.floor(o)}}(Y.width,Y.height,K))},[Y,K]),(0,r.useEffect)(()=>{O.current&&G.width>0&&G.height>0&&(O.current.handleViewportResize(G.width,G.height),h.q.log("\uD83C\uDFA8 Canvas resized to:",G.width,"x",G.height,"aspect:",G.width/G.height))},[G]),(0,r.useEffect)(()=>{if(z.current&&!V)try{h.q.log("\uD83C\uDFAD Initializing ThreeVisualizer with aspect ratio:",f);let e={canvas:{width:G.width,height:G.height,pixelRatio:Math.min(window.devicePixelRatio,2)},aspectRatio:K,performance:{targetFPS:60,enableBloom:!0,enableShadows:!1},midi:{velocitySensitivity:1,noteTrailDuration:2,trackColorMapping:{}}};O.current=new C(z.current,e),Object.entries(u).forEach(e=>{var t,a;let[i,r]=e;r?null===(t=O.current)||void 0===t||t.enableEffect(i):null===(a=O.current)||void 0===a||a.disableEffect(i)}),H(!0),h.q.log("✅ ThreeVisualizer initialized successfully")}catch(e){q(e instanceof Error?e.message:"Unknown error occurred"),h.q.error("❌ Failed to initialize ThreeVisualizer:",e)}},[G,K]),(0,r.useEffect)(()=>{if(!O.current)return;let e=O.current;console.log("[ThreeVisualizer] layers prop:",N,N.map(e=>e.type));let t=N.filter(e=>"effect"===e.type);console.log("[ThreeVisualizer] effectLayers:",t);let a=Object.keys(Q.current),i=t.map(e=>e.id);for(let t of a)i.includes(t)||(e.removeEffect(t),delete Q.current[t],console.log("[ThreeVisualizer] Removed effect instance: ".concat(t)));for(let a of t)if(!Q.current[a.id]){let t=null;"metaballs"===a.effectType?(console.log("[ThreeVisualizer] Instantiating MetaballsEffect for layer:",a),t=new D(a.settings||{})):("particles"===a.effectType||"particleNetwork"===a.effectType)&&(console.log("[ThreeVisualizer] Instantiating ParticleNetworkEffect for layer:",a),t=new j),t&&(Q.current[a.id]=t,e.addEffect(t),console.log("[ThreeVisualizer] Added effect instance: ".concat(a.id," (").concat(a.effectType,") with effect ID: ").concat(t.id)))}if(0===t.length)for(let t of Object.keys(Q.current))e.removeEffect(t),delete Q.current[t],console.log("[ThreeVisualizer] Removed effect instance (all cleared): ".concat(t))},[N,O.current]),(0,r.useEffect)(()=>{M&&O.current&&("function"==typeof M?M(O.current):M&&"current"in M&&(M.current=O.current))},[M,V]),(0,r.useEffect)(()=>{O.current&&(n?O.current.play():O.current.pause())},[n]),(0,r.useEffect)(()=>{if(!O.current||!t)return;let e={currentTime:s,activeNotes:t.tracks.flatMap(e=>e.notes.filter(e=>e.start<=s&&e.start+e.duration>=s).map(t=>({note:t.pitch,velocity:t.velocity,track:e.id,startTime:t.start}))),tempo:120,totalNotes:t.tracks.reduce((e,t)=>e+t.notes.length,0),trackActivity:t.tracks.reduce((e,t)=>(e[t.id]=t.notes.filter(e=>e.start<=s&&e.start+e.duration>=s).length>0,e),{})};O.current.updateMIDIData(e)},[t,s]),(0,r.useEffect)(()=>{if(!O.current||!c)return;let e=setInterval(()=>{var e;c((null===(e=O.current)||void 0===e?void 0:e.getFPS())||60)},1e3);return()=>clearInterval(e)},[c]);let J=(e,t,a)=>{if(!O.current)return;O.current.updateEffectParameter(e,t,a);let i="".concat(e,"-").concat(t);S(e=>({...e,[i]:a}))};if((0,r.useEffect)(()=>()=>{O.current&&O.current.dispose()},[]),U)return(0,i.jsx)(_,{message:U});let $=0===N.length||N.every(e=>"image"===e.type&&!e.src);return(0,i.jsx)("div",{ref:L,className:(0,h.cn)("relative w-full h-full flex items-center justify-center",d),style:{minHeight:"200px",aspectRatio:"".concat(K.width,"/").concat(K.height)},children:(0,i.jsxs)("div",{className:"relative bg-stone-900 rounded-lg overflow-hidden shadow-lg",style:{width:"".concat(G.width,"px"),height:"".concat(G.height,"px"),maxWidth:"100%",maxHeight:"100%",pointerEvents:"auto",zIndex:10},children:[(0,i.jsx)("canvas",{ref:z,className:"absolute top-0 left-0 w-full h-full",style:{width:"".concat(G.width,"px"),height:"".concat(G.height,"px"),pointerEvents:"none",zIndex:1}}),$&&(0,i.jsx)("div",{className:"absolute inset-0 flex items-center justify-center z-20 pointer-events-auto",children:(0,i.jsx)("span",{className:"text-white/60 text-sm font-mono text-center select-none",children:"Add your first layer"})}),Object.entries(p).map((e,t)=>{var a;let[r,s]=e;if(!s)return null;let n=null===(a=O.current)||void 0===a?void 0:a.getAllEffects().find(e=>e.id===r);if(!n)return null;let o=Object.entries(n.parameters).sort((e,t)=>{let[,a]=e,[,i]=t;return"boolean"==typeof a&&"boolean"!=typeof i?-1:"boolean"!=typeof a&&"boolean"==typeof i?1:0});return(0,i.jsx)(A,{title:n.name.replace(" Effect",""),isOpen:s,onClose:()=>y(r),initialPosition:{x:100+50*t,y:100+50*t},bounds:"#editor-bounds",children:(0,i.jsxs)("div",{className:"space-y-4",children:[(0,i.jsx)("div",{className:"text-sm text-white/80 mb-4",children:n.description}),0===o.length?(0,i.jsx)("div",{className:"text-white/60 text-xs font-mono text-center py-4",children:"No configurable parameters."}):o.map(e=>{let[t,a]=e;if("boolean"==typeof a)return(0,i.jsxs)("div",{className:"flex items-center justify-between",children:[(0,i.jsx)(R._,{className:"text-white/80 text-xs font-mono",children:t}),(0,i.jsx)(E,{checked:a,onCheckedChange:e=>J(r,t,e)})]},t);if("number"==typeof a){var s;let e="".concat(r,"-").concat(t),n=g[e],o=(null==n?void 0:n.featureId)||null,l=o?x[o]:void 0,c=(null==n?void 0:n.modulationAmount)||1;return(0,i.jsx)(B,{parameterId:e,label:t,mappedFeatureId:o,mappedFeatureName:l,modulationAmount:c,onFeatureDrop:v,onFeatureUnmap:b,onModulationAmountChange:w,className:"mb-2",dropZoneStyle:"inlayed",showTagOnHover:!0,children:(0,i.jsx)(F.i,{value:[null!==(s=k[e])&&void 0!==s?s:a],onValueChange:a=>{let[i]=a;S(t=>({...t,[e]:i})),J(r,t,i)},min:0,max:function(e){switch(e){case"animationSpeed":case"glowSoftness":return 5;case"noiseIntensity":case"glowIntensity":case"strength":case"radius":case"audioSpawnIntensity":return 2;case"threshold":case"particleSpawning":case"spawnThreshold":case"audioSpawnThreshold":case"audioSpawnRate":case"audioSpawnCooldown":default:return 1;case"particleLifetime":return 10;case"particleSize":case"audioParticleSize":return 50}}(t),step:function(e){switch(e){case"animationSpeed":case"radius":return .05;case"noiseIntensity":case"glowIntensity":case"strength":case"glowSoftness":case"audioParticleSize":return .1;default:return .01}}(t),className:"w-full"})},e)}if(("highlightColor"===t||"particleColor"===t)&&Array.isArray(a)){let e="highlightColor"===t?"Highlight Color":"Particle Color";return(0,i.jsxs)("div",{className:"space-y-2",children:[(0,i.jsxs)(R._,{className:"text-white/90 text-sm font-medium flex items-center justify-between",children:[e,(0,i.jsx)("span",{className:"ml-2 w-6 h-6 rounded-full border border-white/40 inline-block",style:{background:"rgb(".concat(a.map(e=>Math.round(255*e)).join(","),")")}})]}),(0,i.jsx)("input",{type:"color",value:"#".concat(a.map(e=>Math.round(255*e).toString(16).padStart(2,"0")).join("")),onChange:e=>{let a=e.target.value;J(r,t,[parseInt(a.slice(1,3),16)/255,parseInt(a.slice(3,5),16)/255,parseInt(a.slice(5,7),16)/255])},className:"w-12 h-8 rounded border border-white/30 bg-transparent cursor-pointer"})]},t)}return null}),(0,i.jsx)("div",{className:"pt-4 border-t border-white/20",children:(0,i.jsxs)("div",{className:"flex items-center justify-between",children:[(0,i.jsx)(R._,{className:"text-white/80 text-xs font-mono",children:"Effect Enabled"}),(0,i.jsx)(E,{checked:u[r],onCheckedChange:e=>{m(t=>({...t,[r]:e}))}})]})})]})},r)})]})})}function _(e){let{message:t}=e;return(0,i.jsx)("div",{className:"absolute inset-0 flex items-center justify-center bg-red-900/50 z-50",children:(0,i.jsxs)(m.Zb,{className:"bg-red-800/80 text-white p-4 max-w-md",children:[(0,i.jsx)("h3",{className:"text-lg font-semibold",children:"An Error Occurred"}),(0,i.jsx)("p",{className:"text-sm",children:t}),(0,i.jsx)(l.z,{onClick:()=>window.location.reload(),variant:"secondary",className:"mt-4",children:"Refresh Page"})]})})}var q=a(3841),V=a(909),H=a(393),G=a(5787);let Z=e=>{let{effect:t,cardStyle:a,onDoubleClick:r}=e,[{isDragging:s},n]=(0,q.c)({type:"EFFECT_CARD",item:{type:"EFFECT_CARD",id:t.id,name:t.name,category:t.category,rarity:t.rarity,parameters:t.parameters},collect:e=>({isDragging:e.isDragging()})});return(0,i.jsx)("div",{ref:n,className:"cursor-grab",children:(0,i.jsxs)("div",{className:(0,h.cn)("h-24 cursor-grab active:cursor-grabbing transition-all duration-200 border relative overflow-hidden p-0","hover:bg-gray-800",a.background,a.border,s?"opacity-50":""),onDoubleClick:r,children:[(0,i.jsx)("div",{className:(0,h.cn)("absolute top-1 right-1 w-4 h-4 border flex items-center justify-center",a.frameColor,"border-gray-600"),children:(0,i.jsx)("span",{className:"text-black font-bold text-xs",children:"Common"===t.rarity?"C":"Rare"===t.rarity?"R":"M"})}),(0,i.jsx)("div",{className:"relative z-10 pb-0 p-2",children:(0,i.jsxs)("div",{className:"flex items-center gap-1 font-mono text-xs font-bold tracking-wide text-black",children:[(0,i.jsx)("div",{className:"w-1 h-1 flex-shrink-0 border border-gray-600",style:{backgroundColor:"#71717a"}}),t.name.toUpperCase().replace(" EFFECT","")]})}),(0,i.jsxs)("div",{className:"relative z-10 p-2 flex-1 flex flex-col",children:[(0,i.jsx)("div",{className:"h-8 mb-1 bg-gray-800 border border-gray-600 flex items-center justify-center relative overflow-hidden",children:(0,i.jsxs)("div",{className:"text-center relative z-10",children:[(0,i.jsx)("div",{className:"text-xs",children:"Generative"===t.category?"\uD83C\uDF0A":"Overlays"===t.category?"\uD83D\uDCCA":"✨"}),(0,i.jsx)("div",{className:"text-xs font-mono text-gray-300 uppercase tracking-wider",children:t.category.slice(0,3)})]})}),(0,i.jsx)("div",{className:"absolute bottom-1 right-1 z-20",children:(0,i.jsx)("div",{className:"bg-gray-600 text-gray-900 text-xs font-bold px-1 py-0.5 border border-gray-700",children:"↙"})})]})]})})};function Y(e){let{effects:t,selectedEffects:a,onEffectToggle:s,onEffectDoubleClick:n,isVisible:o,className:c}=e,[d,u]=(0,r.useState)(""),[m,f]=(0,r.useState)({Generative:!0,Overlays:!0,"Post-Processing":!0}),p=(0,r.useMemo)(()=>{if(!d.trim())return t;let e=d.toLowerCase();return t.filter(t=>t.name.toLowerCase().includes(e)||t.description.toLowerCase().includes(e)||t.category.toLowerCase().includes(e)||t.rarity.toLowerCase().includes(e))},[t,d]),y=(0,r.useMemo)(()=>{let e={Generative:[],Overlays:[],"Post-Processing":[]};return p.forEach(t=>{e[t.category]&&e[t.category].push(t)}),e},[p]),g=(e,t)=>{let a={Common:{name:"Common",background:"bg-gray-700",border:"border-gray-600",glow:"shadow-gray-600/50",textColor:"text-white",frameColor:"bg-gray-500"},Rare:{name:"Rare",background:"bg-blue-700",border:"border-blue-600",glow:"shadow-blue-600/50",textColor:"text-white",frameColor:"bg-blue-500"},Mythic:{name:"Mythic Rare",background:"bg-yellow-700",border:"border-yellow-600",glow:"shadow-yellow-600/50",textColor:"text-white",frameColor:"bg-yellow-500"}};return a[e]||a.Common},x=e=>{f(t=>({...t,[e]:!t[e]}))},v=()=>{u("")};return o?(0,i.jsxs)("div",{className:(0,h.cn)("h-full flex flex-col bg-black border-l border-gray-800",c),children:[(0,i.jsxs)("div",{className:"p-3 border-b border-gray-800",children:[(0,i.jsx)("h2",{className:"font-mono text-sm font-bold text-gray-100 uppercase tracking-wider mb-2",children:"Effects Library"}),(0,i.jsxs)("div",{className:"relative",children:[(0,i.jsx)(V.Z,{className:"absolute left-2 top-1/2 transform -translate-y-1/2 h-3 w-3 text-gray-400"}),(0,i.jsx)("input",{type:"text",placeholder:"Search effects...",value:d,onChange:e=>u(e.target.value),className:"w-full pl-7 pr-7 py-1.5 bg-gray-900 border border-gray-700 text-xs text-white placeholder-gray-500 focus:outline-none focus:ring-1 focus:ring-gray-600 focus:border-transparent"}),d&&(0,i.jsx)("button",{onClick:v,className:"absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-white",children:(0,i.jsx)(L.Z,{className:"h-3 w-3"})})]})]}),(0,i.jsxs)("div",{className:"flex-1 overflow-y-auto p-3 space-y-3",children:[Object.entries(y).map(e=>{let[t,r]=e;if(0===r.length)return null;let s=m[t];return(0,i.jsxs)("div",{className:"space-y-1.5",children:[(0,i.jsxs)("button",{onClick:()=>x(t),className:"w-full flex items-center justify-between p-2 bg-gray-900 border border-gray-700 hover:bg-gray-800 transition-colors",children:[(0,i.jsx)("span",{className:"font-mono text-xs font-semibold text-gray-300 uppercase tracking-wide",children:t}),(0,i.jsxs)("div",{className:"flex items-center gap-2",children:[(0,i.jsx)("span",{className:"text-xs text-gray-500",children:r.length}),s?(0,i.jsx)(H.Z,{className:"h-3 w-3 text-gray-400"}):(0,i.jsx)(G.Z,{className:"h-3 w-3 text-gray-400"})]})]}),s&&(0,i.jsx)("div",{className:"grid grid-cols-2 gap-1.5 w-full",children:r.map((e,t)=>{let r=g(e.rarity,a[e.id]);return(0,i.jsx)(Z,{effect:e,cardStyle:r,onDoubleClick:()=>n(e.id)},e.id)})})]},t)}),0===p.length&&(0,i.jsxs)("div",{className:"text-center py-4",children:[(0,i.jsxs)("div",{className:"text-gray-500 text-xs",children:['No effects found matching "',d,'"']}),(0,i.jsx)(l.z,{variant:"outline",size:"sm",onClick:v,className:"mt-2 text-xs text-gray-400 border-gray-700 hover:bg-gray-800",children:"Clear search"})]})]})]}):null}var X=a(3122),Q=a(9881),K=a(9878);function J(e){let{children:t}=e,[a,s]=r.useState(!1);return(0,i.jsxs)("div",{className:(0,h.cn)("relative bg-stone-900 border-l border-white/10 transition-all duration-300 ease-in-out z-20",a?"w-16":"w-80"),children:[(0,i.jsxs)("div",{className:"h-full flex flex-col",children:[(0,i.jsxs)("div",{className:(0,h.cn)("flex items-center p-4 border-b border-white/10",a?"justify-center":"justify-between"),children:[(0,i.jsxs)("div",{className:(0,h.cn)("flex items-center gap-2",a&&"hidden"),children:[(0,i.jsx)(X.Z,{className:"h-5 w-5 text-white/70"}),(0,i.jsx)("span",{className:"text-lg font-semibold text-white",children:"Effects Library"})]}),a&&(0,i.jsx)(X.Z,{className:"h-6 w-6 text-white/70"})]}),(0,i.jsx)("div",{className:"flex-1 overflow-hidden",children:a?(0,i.jsx)("div",{className:"flex justify-center items-center p-4 h-full",children:(0,i.jsxs)("div",{className:"text-center space-y-3 text-white/50",children:[(0,i.jsx)(X.Z,{className:"w-8 h-8 mx-auto"}),(0,i.jsx)("div",{className:"text-xs",children:"Effects"})]})}):t})]}),(0,i.jsx)("button",{onClick:()=>s(!a),className:"absolute top-1/2 -translate-y-1/2 -left-4 w-8 h-28 bg-stone-800 hover:bg-stone-700 rounded-l-lg border-y border-l border-white/10 flex items-center justify-center transition-colors","aria-label":"Toggle effects sidebar",children:a?(0,i.jsx)(Q.Z,{className:"h-6 w-6 text-white/60"}):(0,i.jsx)(K.Z,{className:"h-6 w-6 text-white/60"})})]})}a(8936),a(96),a(4096);var $=a(9746),ee=a(4942);a(7115);var et=a(1909),ea=a(2609),ei=a(5487),er=a(6998),es=a(4443);let en=e=>{let{file:t,onClick:a,onDelete:s,isSelected:n=!1,className:o}=e,l=()=>{let e=t.name.toLowerCase().split(".").pop();return["mp4","mov","avi","mkv","webm"].includes(e||"")?"video":["jpg","jpeg","png","gif","bmp","webp"].includes(e||"")?"image":["mp3","wav","ogg","m4a","aac"].includes(e||"")?"audio":["mid","midi"].includes(e||"")?"midi":"unknown"},c=(0,q.c)({type:l().toUpperCase()+"_FILE",item:{type:l().toUpperCase()+"_FILE",id:t.id,name:t.name,fileType:l(),src:"/api/files/".concat(t.id,"/download"),size:t.file_size},collect:e=>({isDragging:e.isDragging()})}),{isDragging:d}=c[0],u=c[1],m=r.useCallback(e=>{u(e)},[u]);return(0,i.jsxs)("div",{ref:m,className:(0,h.cn)("flex items-center border border-stone-400 bg-stone-300 text-black font-mono text-xs h-8 px-2 gap-2 select-none transition-colors duration-100","hover:bg-stone-900 hover:text-stone-100 hover:border-stone-500 cursor-grab active:cursor-grabbing",n&&"bg-stone-900 text-stone-100 border-stone-500",d&&"relative z-20 bg-white/30 backdrop-blur-md border border-white/40 shadow-2xl text-black",o),style:{borderRadius:2,minHeight:32,maxHeight:32},onClick:a,tabIndex:0,children:[(0,i.jsx)("div",{className:"flex-shrink-0 w-4 h-4 flex items-center justify-center",children:(()=>{switch(l()){case"video":return(0,i.jsx)("span",{className:"text-xs",children:"\uD83C\uDFAC"});case"image":return(0,i.jsx)("span",{className:"text-xs",children:"\uD83D\uDDBC️"});case"audio":return(0,i.jsx)("span",{className:"text-xs",children:"\uD83C\uDFB5"});case"midi":return(0,i.jsx)("span",{className:"text-xs",children:"\uD83C\uDFB9"});default:return(0,i.jsx)("span",{className:"text-xs",children:"\uD83D\uDCC4"})}})()}),(0,i.jsx)("div",{className:"truncate flex-1 font-medium",title:t.name,style:{maxWidth:140},children:t.name}),(0,i.jsx)("button",{className:"ml-1 p-0.5 text-black hover:text-red-600 border-none bg-transparent focus:outline-none",style:{lineHeight:1,borderRadius:1},tabIndex:-1,onClick:e=>{e.stopPropagation(),s&&s()},"aria-label":"Delete file",children:(0,i.jsx)(es.Z,{size:12,strokeWidth:2})}),t.uploading&&(0,i.jsx)("div",{className:"absolute left-0 bottom-0 w-full h-0.5 bg-gradient-to-r from-black to-gray-400 animate-pulse"})]})};function eo(e){let{onFileSelected:t,selectedFileId:a,showUpload:s=!0,useDemoData:n,onDemoModeChange:o,projectId:l,projectName:c}=e,[d,u]=(0,r.useState)(!1),{toast:m}=(0,ei.pm)(),[h,f]=(0,r.useState)(null),[p,y]=(0,r.useState)(!1),{data:g,isLoading:x,error:v,refetch:b}=et.S.file.getUserFiles.useQuery({limit:20,fileType:"all",projectId:l}),w=et.S.midi.parseMidiFile.useMutation({onSuccess:e=>{e.success&&(m({title:"MIDI File Ready",description:"File parsed successfully and ready for visualization"}),t(e.midiFileId),o(!1),b())},onError:e=>{m({title:"Parsing Failed",description:e.message,variant:"destructive"})}}),{addAndUploadFiles:k,files:S,clearFiles:C}=(0,ea.V)({projectId:l,onUploadComplete:e=>{if(b(),e.fileId&&!e.fileId.startsWith("mock_")){let t=e.file.name.toLowerCase().split(".").pop();t&&["mid","midi"].includes(t)&&w.mutate({fileId:e.fileId})}else m({title:"Upload Demo",description:"File uploaded successfully! This is demo mode - parsing not available yet.",variant:"default"})},onUploadError:(e,t)=>{m({title:"Upload Failed",description:"".concat(e.file.name,": ").concat(t),variant:"destructive"})}}),D=et.S.file.deleteFile.useMutation({onSuccess:()=>{m({title:"File deleted",description:"The file was deleted."}),f(null),b()},onError:e=>{m({title:"Delete failed",description:e.message,variant:"destructive"}),f(null)},onSettled:()=>y(!1)}),j=e=>{y(!0),D.mutate({fileId:e})},M=async e=>{let t=e.filter(e=>["mid","midi","mp3","wav","ogg","m4a","aac","mp4","mov","avi","mkv","webm","jpg","jpeg","png","gif","bmp","webp"].includes(e.name.toLowerCase().split(".").pop()||""));if(0===t.length){m({title:"Invalid Files",description:"Please select supported files (MIDI, audio, video, or image files)",variant:"destructive"});return}await k(t),u(!1)},N=(null==g?void 0:g.files)||[];return(0,i.jsxs)("div",{className:"bg-stone-900 border border-stone-700 rounded-none font-mono text-xs flex flex-col min-h-0",style:{maxHeight:420,overflow:"hidden"},children:[(0,i.jsx)("div",{className:"flex items-center justify-between px-3 py-2 border-b border-stone-700 bg-stone-900 text-stone-100",children:(0,i.jsx)("h3",{className:"text-xs font-bold tracking-widest uppercase",children:c?"".concat(c," - Files"):"File Library"})}),(0,i.jsx)("div",{className:"flex-1 min-h-0 overflow-y-auto",style:{maxHeight:320},children:(0,i.jsxs)("div",{className:"space-y-1 p-2",children:[v&&(0,i.jsx)("p",{className:"text-red-400 text-xs",children:"Error loading files."}),!n&&0===N.length&&!x&&(0,i.jsxs)("div",{className:"text-center py-8 text-stone-400",children:[(0,i.jsx)("span",{className:"text-2xl",children:"\uD83D\uDCC4"}),(0,i.jsx)("p",{className:"text-xs mt-1",children:"No files uploaded yet"})]}),!n&&N.map(e=>(0,i.jsx)(en,{file:{id:e.id,name:e.file_name,file_type:e.file_type,file_size:e.file_size,uploading:"uploading"===e.upload_status},isSelected:a===e.id,onClick:()=>"midi"===e.file_type&&t(e.id),onDelete:()=>f(e.id)},e.id)),n&&(0,i.jsxs)("div",{className:"flex items-center border border-stone-700 bg-stone-900 text-stone-100 font-mono text-xs h-8 px-2 gap-2 select-none",style:{borderRadius:2,minHeight:32,maxHeight:32},children:[(0,i.jsx)("div",{className:"flex-shrink-0 w-4 h-4 flex items-center justify-center",children:"\uD83C\uDFB9"}),(0,i.jsx)("div",{className:"truncate flex-1 font-bold",title:"Creative Demo.mid",style:{maxWidth:120},children:"Creative Demo.mid"}),(0,i.jsx)("div",{className:"uppercase tracking-widest px-1 border border-stone-700 bg-transparent",style:{borderRadius:1},children:"midi"}),(0,i.jsx)("div",{className:"text-[10px] text-stone-400 font-mono px-1",children:"1 KB"})]})]})}),!n&&(0,i.jsx)("div",{className:"border-t border-stone-700 p-2 bg-stone-900",children:(0,i.jsxs)("div",{className:"w-full border-2 border-dashed border-stone-700 rounded-none text-center cursor-pointer hover:bg-stone-800 hover:text-stone-100 transition-colors py-2",onClick:()=>{var e;return null===(e=document.getElementById("file-upload-input"))||void 0===e?void 0:e.click()},children:[(0,i.jsx)("div",{className:"text-lg",children:"⬆️"}),(0,i.jsx)("div",{className:"font-bold",children:"Upload Files"}),(0,i.jsx)("div",{className:"text-[10px]",children:"MIDI, audio, video, or images"}),(0,i.jsx)("input",{id:"file-upload-input",type:"file",multiple:!0,accept:".mid,.midi,.mp3,.wav,.ogg,.m4a,.aac,.mp4,.mov,.avi,.mkv,.webm,.jpg,.jpeg,.png,.gif,.bmp,.webp",className:"hidden",onChange:e=>{let t=Array.from(e.target.files||[]);t.length>0&&M(t)}})]})}),(0,i.jsx)(er.c,{isOpen:!!h,onClose:()=>f(null),onConfirm:()=>h&&j(h),title:"Delete File?",description:"Are you sure you want to delete this file? This action cannot be undone.",confirmText:p?"Deleting...":"Delete",confirmVariant:"danger"})]})}var el=a(9494),ec=a(4501),ed=a(6810),eu=a(1973),em=a(8113),eh=a(5003);let ef=e=>{let{href:t,icon:a,label:r,isCollapsed:s}=e;return(0,i.jsxs)("a",{href:t,className:"flex items-center p-2 text-gray-300 rounded-lg hover:bg-gray-800 group",children:[(0,i.jsx)(a,{className:"w-6 h-6 text-gray-400 transition duration-75 group-hover:text-gray-200"}),(0,i.jsx)("span",{className:(0,h.cn)("ml-3",s&&"hidden"),children:r})]})};function ep(e){let{children:t}=e,[a,s]=r.useState(!1);return(0,i.jsxs)("div",{className:(0,h.cn)("relative bg-black border-r border-gray-800 transition-all duration-300 ease-in-out z-20",a?"w-24":"w-64"),children:[(0,i.jsxs)("div",{className:"h-full flex flex-col p-4",children:[(0,i.jsx)("div",{className:(0,h.cn)("flex items-center mb-6",a?"justify-center":"justify-between"),children:(0,i.jsx)("div",{className:(0,h.cn)("text-2xl font-semibold text-gray-100",a&&"hidden"),children:(0,i.jsx)(eh.S,{size:"sm",className:"text-gray-100"})})}),(0,i.jsxs)("nav",{className:"flex-grow space-y-2",children:[(0,i.jsx)(ef,{href:"/dashboard",icon:ec.Z,label:"Home",isCollapsed:a}),(0,i.jsx)(ef,{href:"/files",icon:ed.Z,label:"Files",isCollapsed:a}),(0,i.jsx)(ef,{href:"/profile",icon:eu.Z,label:"Profile",isCollapsed:a})]}),(0,i.jsx)("div",{className:"flex-shrink-0",children:a?(0,i.jsx)("div",{className:"flex justify-center items-center p-4",children:(0,i.jsx)(em.Z,{className:"w-8 h-8 text-gray-400"})}):t})]}),(0,i.jsx)("button",{onClick:()=>s(!a),className:"absolute top-1/2 -translate-y-1/2 -right-4 w-8 h-28 bg-gray-900 hover:bg-gray-800 rounded-r-lg border-y border-r border-gray-700 flex items-center justify-center transition-colors","aria-label":"Toggle sidebar",children:a?(0,i.jsx)(K.Z,{className:"h-6 w-6 text-gray-300"}):(0,i.jsx)(Q.Z,{className:"h-6 w-6 text-gray-300"})})]})}var ey=a(9767),eg=a(759),ex=a(7953);let ev=e=>{let{isOpen:t,onClose:a,onSelect:s,onCreateNew:n}=e,[o,l]=(0,r.useState)(""),{data:c=[],isLoading:d}=et.S.project.list.useQuery(),u=c.filter(e=>e.name.toLowerCase().includes(o.toLowerCase()));return(0,i.jsx)(ey.l,{isOpen:t,onClose:a,sizeClassName:"max-w-md min-h-[300px]",children:(0,i.jsxs)("div",{className:"w-full h-full bg-stone-900 text-stone-200 font-mono border border-stone-700 rounded-xl max-h-[90vh] overflow-y-auto p-4 min-w-[340px]",children:[(0,i.jsx)("h2",{className:"text-xl font-bold text-stone-200 mb-1 tracking-widest uppercase",children:"Select a Project"}),(0,i.jsx)("p",{className:"text-stone-400 text-xs mb-2",children:"Choose a project to open in the visualizer, or create a new one."}),(0,i.jsx)("input",{type:"text",placeholder:"Search projects...",value:o,onChange:e=>l(e.target.value),className:"w-full px-3 py-2 mb-4 border border-stone-700 rounded-md text-stone-200 bg-stone-800 placeholder:text-stone-400 focus:outline-none focus:ring-2 focus:ring-emerald-400"}),(0,i.jsx)("div",{className:"max-h-64 overflow-y-auto mb-4",children:d?(0,i.jsx)("div",{className:"flex justify-center py-8",children:(0,i.jsx)(eg.T,{})}):0===u.length?(0,i.jsx)("div",{className:"text-stone-500 text-center py-8",children:"No projects found."}):(0,i.jsx)("ul",{children:u.map(e=>(0,i.jsx)("li",{children:(0,i.jsxs)("button",{className:"w-full text-left px-4 py-3 rounded hover:bg-stone-700 transition flex flex-col mb-1 border border-transparent hover:border-emerald-400",onClick:()=>{s(e.id)},children:[(0,i.jsx)("span",{className:"font-bold text-stone-200",children:e.name}),(0,i.jsx)("span",{className:"text-xs text-stone-400",children:e.description||"No description"})]})},e.id))})}),(0,i.jsx)(ex.n,{variant:"primary",size:"lg",className:"w-full bg-emerald-400 text-stone-900 font-bold mt-2",onClick:n,children:"+ Create New Project"})]})})};var eb=a(8030);function ew(){let[e,t]=(0,r.useState)(!1),[a,i]=(0,r.useState)({}),[s,n]=(0,r.useState)(0),[o,l]=(0,r.useState)(null),[c,d]=(0,r.useState)(!1),[u,m]=(0,r.useState)(!1),h=(0,r.useRef)(!1),[f,p]=(0,r.useState)(!0),[y,g]=(0,r.useState)(new Set),x=(0,r.useRef)(null);(0,r.useRef)(new Set);let v=(0,r.useRef)(null),b=(0,r.useRef)({}),w=(0,r.useRef)({}),k=(0,r.useRef)({}),S=(0,r.useRef)(0),C=(0,r.useRef)(0),D=(0,r.useRef)(0),j=(0,r.useRef)(null),M=(0,r.useRef)(!1);(0,r.useEffect)(()=>((async()=>{try{if(v.current=new(window.AudioContext||window.webkitAudioContext),console.log("\uD83C\uDFB5 Audio context created with state:",v.current.state),console.log("\uD83C\uDFB5 Audio context sample rate:",v.current.sampleRate),"suspended"===v.current.state){console.log("\uD83C\uDFB5 Audio context is suspended, attempting to resume...");try{await v.current.resume(),console.log("\uD83C\uDFB5 Audio context resumed successfully")}catch(e){console.warn("⚠️ Could not resume audio context immediately:",e),console.log("\uD83C\uDFB5 User interaction will be required to start audio")}}console.log("\uD83C\uDFB5 Advanced audio analysis system initialized")}catch(e){console.error("❌ Failed to initialize audio analysis system:",e)}})(),()=>{v.current&&"closed"!==v.current.state&&v.current.close()}),[]),(0,r.useEffect)(()=>{if(!e||!v.current)return;let t=v.current,a=y.size>0,i=x.current;Object.entries(k.current).forEach(e=>{let[r,s]=e,n=y.has(r),o=0;o=a?n?.7:0:r===i?.7:0,s.gain.linearRampToValueAtTime(o,t.currentTime+.1)})},[y,e]);let N=(0,r.useCallback)(e=>{g(t=>{let a=new Set(t);return a.has(e)?a.delete(e):a.add(e),a})},[]),T=(0,r.useCallback)(async(e,t)=>{if(0!==e.length){if(h.current||c){console.log("⚠️ Stems already loading or loaded, skipping duplicate request");return}h.current=!0;try{console.log("\uD83C\uDFB5 Starting to load ".concat(e.length," stems...")),console.log("\uD83C\uDFB5 Stem master info:",e.map(e=>({id:e.id,label:e.label,isMaster:e.isMaster})));let a={},i=e.find(e=>e.isMaster);for(let r of(i?(x.current=i.id,console.log("\uD83C\uDFB5 Master stem identified:",i.id,i.label)):e.length>0&&(x.current=e[0].id,console.warn("⚠️ No master stem designated. Defaulting to first stem:",e[0].id)),e))try{let e=await fetch(r.url);if(!e.ok)throw Error("Failed to load stem ".concat(r.id,": ").concat(e.status));let i=await e.arrayBuffer(),s=await v.current.decodeAudioData(i);a[r.id]=s;let n=v.current.createGain();n.gain.value=.7,k.current[r.id]=n,console.log("\uD83C\uDFB5 Decoded audio buffer for ".concat(r.id,": ").concat(s.duration.toFixed(2),"s")),t&&t(r.id,s)}catch(e){console.error("❌ Failed to decode audio buffer for ".concat(r.id,":"),e)}b.current={...b.current,...a},d(!0),h.current=!1}catch(e){console.error("❌ Failed to load stems:",e),h.current=!1}}},[]),A=(0,r.useCallback)(async()=>{if(!v.current||!c){console.warn("⚠️ Cannot play: AudioContext not ready or stems not loaded");return}try{"suspended"===v.current.state&&await v.current.resume(),Object.values(w.current).forEach(e=>{try{e.stop()}catch(e){}}),w.current={};let a=v.current.currentTime+.1,i=D.current;S.current=a-i,C.current=a-i;let r=y.size>0,s=x.current;Object.entries(b.current).forEach(e=>{let[t,n]=e,o=v.current.createBufferSource(),l=k.current[t],c=y.has(t),d=0;d=r?c?.7:0:t===s?.7:0,l.gain.setValueAtTime(d,v.current.currentTime),o.buffer=n,o.connect(l),l.connect(v.current.destination),o.loop=f,o.onended=()=>{M.current&&delete w.current[t]},o.start(a,i),w.current[t]=o}),D.current=0,t(!0),M.current=!1,j.current=setInterval(()=>{if(v.current&&e){let e=v.current.currentTime-S.current,t=O();n(t>0?e%t:Math.max(0,e))}},16)}catch(e){console.error("❌ Failed to start audio playback:",e),t(!1)}},[c,f,y]),F=(0,r.useCallback)(()=>{e&&(M.current=!0,Object.values(w.current).forEach(e=>{try{e.stop()}catch(e){}}),w.current={},j.current&&(clearInterval(j.current),j.current=null),D.current=v.current.currentTime-S.current,t(!1))},[e]),R=(0,r.useCallback)(()=>{try{t(!1),M.current=!0,Object.entries(w.current).forEach(e=>{let[t,a]=e;try{a.stop()}catch(e){console.error("❌ Failed to stop playback for ".concat(t,":"),e)}}),w.current={},setTimeout(()=>{M.current=!1},100),n(0),D.current=0,S.current=0}catch(e){console.error("❌ Failed to stop playback:",e)}},[]),I=(0,r.useCallback)(()=>{try{t(!1),n(0),i({}),l(null),d(!1),m(!1),h.current=!1,Object.entries(w.current).forEach(e=>{let[t,a]=e;try{a.stop()}catch(e){}}),w.current={},b.current={},k.current={},D.current=0,S.current=0,console.log("\uD83D\uDDD1️ Advanced audio analysis and playback cleared")}catch(e){console.error("❌ Failed to clear stems:",e)}},[]);(0,r.useEffect)(()=>{let t;if(!e||!v.current)return;let a=0,i=1e3/30,r=()=>{try{let e=performance.now();if(e-a>=i){let t=v.current.currentTime-S.current,i=O();n(i>0?t%i:Math.max(0,t)),a=e}t=requestAnimationFrame(r)}catch(e){console.error("❌ Failed to update time:",e)}};return t=requestAnimationFrame(r),()=>{t&&cancelAnimationFrame(t)}},[e]),(0,r.useEffect)(()=>{let e=async()=>{if(v.current&&"suspended"===v.current.state){console.log("\uD83C\uDFB5 User interaction detected, resuming audio context...");try{await v.current.resume(),console.log("\uD83C\uDFB5 Audio context resumed via user interaction")}catch(e){console.error("❌ Failed to resume audio context on user interaction:",e)}}},t=["click","touchstart","keydown","mousedown"];return t.forEach(t=>{document.addEventListener(t,e,{once:!0,passive:!0})}),()=>{t.forEach(t=>{document.removeEventListener(t,e)})}},[]),(0,r.useEffect)(()=>{},[]);let E=(0,r.useCallback)((e,t)=>{let a=k.current[e];a&&(a.gain.value=Math.max(0,Math.min(1,t)),console.log("\uD83C\uDFB5 Set volume for ".concat(e,": ").concat(t)))},[]),P=(0,r.useCallback)(e=>{let t=k.current[e];return t?t.gain.value:.7},[]),z=(0,r.useCallback)(async()=>{if(!v.current){console.warn("⚠️ No audio context available for test");return}try{console.log("\uD83C\uDFB5 Testing audio output...");let e=v.current.createOscillator(),t=v.current.createGain();e.frequency.setValueAtTime(440,v.current.currentTime),e.type="sine",t.gain.setValueAtTime(.1,v.current.currentTime),t.gain.exponentialRampToValueAtTime(.01,v.current.currentTime+.5),e.connect(t),t.connect(v.current.destination),e.start(v.current.currentTime),e.stop(v.current.currentTime+.5),console.log("\uD83C\uDFB5 Test tone played - you should hear a 440Hz tone for 0.5 seconds")}catch(e){console.error("❌ Audio output test failed:",e)}},[]),L=(0,r.useCallback)(()=>Math.max(...Object.values(b.current).map(e=>e.duration),0),[]),O=(0,r.useCallback)(()=>{let e=x.current;return e&&b.current[e]?b.current[e].duration:L()},[L]),B=(0,r.useCallback)(()=>{let e=v.current;return e?(e.baseLatency||0)+(e.outputLatency||0):0},[]),W=(0,r.useCallback)(()=>v.current?v.current.currentTime:0,[]),U=(0,r.useCallback)(function(e){var t;let a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1024,i=b.current[e];if(!i)return console.warn("[getStereoWindow] No buffer for stemId",e,"Available buffers:",Object.keys(b.current)),null;let r=i.numberOfChannels,s=Math.floor(((null===(t=v.current)||void 0===t?void 0:t.currentTime)||0-S.current)*i.sampleRate),n=Math.max(0,s-a),o=Math.min(i.length,s),l=[],c=[];try{if(1===r){let e=i.getChannelData(0).slice(n,o);l=Array.from(e),c=Array.from(e)}else l=Array.from(i.getChannelData(0).slice(n,o)),c=Array.from(i.getChannelData(1).slice(n,o))}catch(t){return console.error("[getStereoWindow] Error accessing buffer:",t,{stemId:e,buffer:i}),null}return l.length<a&&(l=Array(a-l.length).fill(0).concat(l),c=Array(a-c.length).fill(0).concat(c)),{left:l,right:c}},[]);return{play:A,pause:F,stop:R,isPlaying:e,featuresByStem:a,currentTime:s,setCurrentTime:n,loadStems:T,clearStems:I,setStemVolume:E,getStemVolume:P,testAudioOutput:z,visualizationData:o,stemsLoaded:c,isLooping:f,setLooping:p,soloedStems:y,toggleStemSolo:N,getAudioLatency:B,getAudioContextTime:W,scheduledStartTimeRef:C,duration:O(),getStereoWindow:U}}function ek(){let[e,t]=(0,r.useState)([]),[a,i]=(0,r.useState)(!1),[s,n]=(0,r.useState)(null),[o,l]=(0,r.useState)(!1),[c,d]=(0,r.useState)([]),[u,m]=(0,r.useState)(void 0),h=(0,r.useRef)(null),[f,p]=(0,r.useState)({}),y=et.S.stem.cacheClientSideAnalysis.useMutation({onSuccess:e=>{e.cached&&console.log("Client-side analysis cached successfully:",e)},onError:e=>{console.error("Failed to cache client-side analysis:",e)}});(0,r.useEffect)(()=>(h.current=new Worker("/workers/audio-analysis-worker.js"),h.current.onmessage=e=>{let{type:a,data:i}=e.data;switch(a){case"ANALYSIS_PROGRESS":p(e=>({...e,[i.fileId]:{progress:i.progress,message:i.message}}));break;case"ANALYSIS_COMPLETE":console.log("Analysis complete for file:",i.fileId),console.log("Analysis result data:",i.result),t(e=>{let t=[...e,i.result];return console.log("Updated cached analysis:",t.map(e=>({id:e.fileMetadataId,stemType:e.stemType}))),t}),p(e=>({...e,[i.fileId]:null})),y.mutate(i.result);break;case"ANALYSIS_ERROR":console.error("Analysis error for ".concat(i.fileId,":"),i.error),p(e=>({...e,[i.fileId]:{progress:1,message:"Error: ".concat(i.error)}}))}},()=>{var e;null===(e=h.current)||void 0===e||e.terminate()}),[]);let{data:g,isLoading:x,error:v,refetch:b}=et.S.stem.getCachedAnalysis.useQuery({fileIds:c,stemType:u},{enabled:c.length>0}),w=(0,r.useCallback)(async(t,a)=>{if(!t||0===t.length)return;let r=t.filter(t=>!e.some(e=>e.fileMetadataId===t));0!==r.length&&(c.join(",")!==r.join(",")||u!==a)&&(i(!0),n(null),d(r),m(a))},[c,u,e]),k=(0,r.useCallback)((t,a,i)=>{if(console.log("\uD83C\uDFB5 analyzeAudioBuffer called:",{fileId:t,stemType:i,duration:a.duration}),!h.current){console.error("Analysis worker not ready.");return}if(e.some(e=>e.fileMetadataId===t)||f[t]){console.log("\uD83C\uDFB5 Skipping analysis - already cached or in progress:",{fileId:t,hasCached:e.some(e=>e.fileMetadataId===t),inProgress:!!f[t]});return}console.log("\uD83C\uDFB5 Starting analysis for:",t,i),p(e=>({...e,[t]:{progress:0,message:"Queued for analysis..."}}));let r=a.getChannelData(0),s=new Float32Array(r.length);s.set(r),h.current.postMessage({type:"ANALYZE_BUFFER",data:{fileId:t,channelData:s,sampleRate:a.sampleRate,duration:a.duration,stemType:i}})},[e,f]);return(0,r.useEffect)(()=>{if(x){i(!0);return}i(!1),v?n(v instanceof Error?v.message:String(v)):g&&(t(e=>{let t=(Array.isArray(g)?g:[g]).filter(Boolean),a=new Set(e.map(e=>e.fileMetadataId)),i=t.filter(e=>!(!e||!e.fileMetadataId||a.has(e.fileMetadataId))&&(!e.analysisData||void 0===e.analysisData.volume||(console.warn("Skipping cached analysis for ".concat(e.fileMetadataId," due to outdated format.")),!1)));return i.length>0?[...e,...i]:e}),n(null))},[g,x,v]),{cachedAnalysis:e,isLoading:a,error:s,analysisProgress:f,loadAnalysis:w,analyzeAudioBuffer:k}}var eS=a(6813),eC=a(4038);let eD=e=>{let{feature:t,category:a,currentTime:s,cachedAnalysis:n,isPlaying:o}=e,[l,c]=(0,r.useState)(0),[d,u]=(0,r.useState)(!1);(0,r.useEffect)(()=>{if(!n||0===n.length||!t.stemType){c(0),u(!1);return}let e=n.find(e=>e.stemType===t.stemType);if(!e||!e.analysisData){c(0),u(!1);return}let a=Math.max(0,Math.min(1,((t,a)=>{let i=t.split("-");if(i.length>=2){let t=i.slice(1).join("-");switch(t){case"impact":let r=e.analysisData.transients.find(e=>.1>Math.abs(e.time-a));return(null==r?void 0:r.intensity)||0;case"pitch-height":let s=e.analysisData.chroma.find(e=>.1>Math.abs(e.time-a));return(null==s?void 0:s.pitch)||0;case"brightness":let n=e.analysisData.chroma.find(e=>.1>Math.abs(e.time-a));return(null==n?void 0:n.confidence)||0;case"rms":case"volume":case"loudness":let o=e.analysisData.rms.find(e=>.1>Math.abs(e.time-a));return(null==o?void 0:o.value)||0;default:if(e.analysisData.original&&e.analysisData.original[t]){let i=e.analysisData.original[t];if(Array.isArray(i)&&i.length>0)return i[Math.round(10*a)]||0}}}return 0})(t.id,s)));c(a),u(o&&a>.1)},[t,s,n,o]);let m={isDragging:!1},f=()=>{};try{let e=(0,q.c)({type:"feature",item:{id:t.id,name:t.name,stemType:t.stemType},collect:e=>({isDragging:e.isDragging()})});m=e[0];let a=e[1];f=r.useCallback(e=>{a(e)},[a])}catch(e){console.warn("Drag context not available for FeatureNode:",e)}return(0,i.jsx)("div",{ref:f,className:"cursor-grab transition-all duration-200 hover:bg-gray-800 ".concat(m.isDragging?"opacity-50":""),title:t.description,children:(0,i.jsxs)("div",{className:(0,h.cn)("w-full px-2 py-1.5 text-xs font-medium border border-gray-700 transition-all duration-200","bg-black hover:bg-gray-900",m.isDragging&&"shadow-lg",d&&"ring-1 ring-opacity-50",d&&"rhythm"===a&&"ring-red-400",d&&"pitch"===a&&"ring-blue-400",d&&"intensity"===a&&"ring-yellow-400",d&&"timbre"===a&&"ring-purple-400"),children:[(0,i.jsxs)("div",{className:"flex items-center justify-between w-full mb-1",children:[(0,i.jsx)("span",{className:"truncate font-medium text-gray-300",children:t.name}),t.stemType&&(0,i.jsx)("span",{className:"text-xs opacity-60 ml-1 text-gray-400",children:eN(t.stemType)})]}),(0,i.jsx)("div",{className:"w-full bg-gray-800 rounded-sm h-1 mb-1 overflow-hidden",children:(0,i.jsx)("div",{className:(0,h.cn)("h-full rounded-sm transition-all duration-150 ease-out","rhythm"===a&&"bg-red-500","pitch"===a&&"bg-blue-500","intensity"===a&&"bg-yellow-500","timbre"===a&&"bg-purple-500"),style:{width:"".concat(100*l,"%"),transform:d?"scaleY(1.1)":"scaleY(1)",transition:"width 150ms ease-out, transform 150ms ease-out"}})}),(0,i.jsxs)("div",{className:"flex items-center justify-between text-xs opacity-70 text-gray-400",children:[(0,i.jsxs)("span",{children:[(100*l).toFixed(0),"%"]}),d&&(0,i.jsx)("span",{className:(0,h.cn)("w-1 h-1 rounded-full animate-pulse","rhythm"===a&&"bg-red-400","pitch"===a&&"bg-blue-400","intensity"===a&&"bg-yellow-400","timbre"===a&&"bg-purple-400")})]})]})})},ej={rhythm:eS.Z,pitch:ee.Z,intensity:eC.Z,timbre:ee.Z},eM={rhythm:"Rhythm & Groove",pitch:"Pitch & Tone",intensity:"Energy & Impact",timbre:"Texture & Character"},eN=e=>({drums:"\uD83E\uDD41 Drums",bass:"\uD83C\uDFB8 Bass",vocals:"\uD83C\uDFA4 Vocals",melody:"\uD83C\uDFB9 Melody",other:"\uD83C\uDFBC Other"})[e]||e;function eT(e){let{activeTrackId:t,className:a,selectedStemType:s,currentTime:n=0,cachedAnalysis:o=[],isPlaying:l=!1}=e,c=(0,r.useMemo)(()=>{if(!t)return[];let e=[{id:"drums-rms",name:"RMS Energy",description:"Raw audio energy and intensity of drum hits",category:"intensity",stemType:"drums"},{id:"drums-impact",name:"Impact",description:"Sharp, punchy energy for every drum hit",category:"rhythm",stemType:"drums"},{id:"drums-brightness",name:"Brightness",description:"Tone of the drum - bright hi-hats vs deep kicks",category:"pitch",stemType:"drums"},{id:"drums-harshness",name:"Harshness",description:"Sharpness of snare cracks and rimshots",category:"intensity",stemType:"drums"},{id:"drums-volume",name:"Volume",description:"Overall drum energy and power",category:"rhythm",stemType:"drums"},{id:"drums-spectral-rolloff",name:"Spectral Rolloff",description:"High-frequency content and brightness",category:"pitch",stemType:"drums"},{id:"drums-spectral-flatness",name:"Spectral Flatness",description:"Tone vs noise ratio in drum sounds",category:"timbre",stemType:"drums"},{id:"drums-zcr",name:"Zero Crossing Rate",description:"Percussive attack and transient content",category:"rhythm",stemType:"drums"},{id:"bass-rms",name:"RMS Energy",description:"Raw audio energy and intensity of bass notes",category:"intensity",stemType:"bass"},{id:"bass-volume",name:"Volume",description:"Sustained power of the bassline foundation",category:"rhythm",stemType:"bass"},{id:"bass-brightness",name:"Brightness",description:"Filter changes - bright vs dull bass tones",category:"pitch",stemType:"bass"},{id:"bass-noisiness",name:"Noisiness",description:"Clean sub-bass vs gritty distorted bass",category:"timbre",stemType:"bass"},{id:"bass-warmth",name:"Warmth",description:"Perceived warmth and richness of bass",category:"timbre",stemType:"bass"},{id:"bass-spectral-rolloff",name:"Spectral Rolloff",description:"High-frequency content and presence",category:"pitch",stemType:"bass"},{id:"bass-spectral-flatness",name:"Spectral Flatness",description:"Harmonic richness vs noise",category:"timbre",stemType:"bass"},{id:"bass-perceptual-spread",name:"Perceptual Spread",description:"Spectral width and stereo image",category:"timbre",stemType:"bass"},{id:"melody-rms",name:"RMS Energy",description:"Raw audio energy and intensity of melody notes",category:"intensity",stemType:"melody"},{id:"melody-volume",name:"Volume",description:"Swell and decay of chords and melodies",category:"rhythm",stemType:"melody"},{id:"melody-brightness",name:"Brightness",description:"Mood - bright happy vs dark moody passages",category:"pitch",stemType:"melody"},{id:"melody-pitch-height",name:"Pitch Height",description:"Average pitch of the melody line",category:"pitch",stemType:"melody"},{id:"melody-harmonic-content",name:"Harmonic Content",description:"Richness and complexity of harmonies",category:"timbre",stemType:"melody"},{id:"melody-spectral-rolloff",name:"Spectral Rolloff",description:"High-frequency harmonics and overtones",category:"pitch",stemType:"melody"},{id:"melody-spectral-flatness",name:"Spectral Flatness",description:"Tone quality and harmonic richness",category:"timbre",stemType:"melody"},{id:"melody-perceptual-sharpness",name:"Perceptual Sharpness",description:"Perceived sharpness and clarity",category:"timbre",stemType:"melody"},{id:"vocals-rms",name:"RMS Energy",description:"Raw audio energy and intensity of vocal performance",category:"intensity",stemType:"vocals"},{id:"vocals-loudness",name:"Loudness",description:"Natural dynamics of the human voice",category:"intensity",stemType:"vocals"},{id:"vocals-pitch-height",name:"Pitch Height",description:"Average pitch of the vocal melody",category:"pitch",stemType:"vocals"},{id:"vocals-noisiness",name:"Noisiness",description:"Clean singing vs breathy or raspy vocals",category:"timbre",stemType:"vocals"},{id:"vocals-expression",name:"Expression",description:"Emotional intensity of vocal performance",category:"intensity",stemType:"vocals"},{id:"vocals-spectral-rolloff",name:"Spectral Rolloff",description:"High-frequency harmonics and sibilance",category:"pitch",stemType:"vocals"},{id:"vocals-spectral-flatness",name:"Spectral Flatness",description:"Tone quality and breathiness",category:"timbre",stemType:"vocals"},{id:"vocals-perceptual-sharpness",name:"Perceptual Sharpness",description:"Clarity and presence of vocals",category:"timbre",stemType:"vocals"},{id:"other-rms",name:"RMS Energy",description:"Raw audio energy and intensity of the instrument",category:"intensity",stemType:"other"},{id:"other-volume",name:"Volume",description:"Overall energy and power of the instrument",category:"rhythm",stemType:"other"},{id:"other-brightness",name:"Brightness",description:"Tone and mood of the instrument",category:"pitch",stemType:"other"},{id:"other-harmonic-content",name:"Harmonic Content",description:"Richness and complexity of the sound",category:"timbre",stemType:"other"},{id:"other-texture",name:"Texture",description:"Textural characteristics and timbre",category:"timbre",stemType:"other"},{id:"other-spectral-rolloff",name:"Spectral Rolloff",description:"High-frequency content and brightness",category:"pitch",stemType:"other"},{id:"other-spectral-flatness",name:"Spectral Flatness",description:"Tone vs noise characteristics",category:"timbre",stemType:"other"},{id:"other-perceptual-spread",name:"Perceptual Spread",description:"Spectral width and stereo image",category:"timbre",stemType:"other"},{id:"master-rms",name:"RMS Energy",description:"Overall mix energy and intensity",category:"intensity",stemType:"master"},{id:"master-volume",name:"Volume",description:"Overall mix volume and power",category:"rhythm",stemType:"master"},{id:"master-brightness",name:"Brightness",description:"Overall mix brightness and mood",category:"pitch",stemType:"master"},{id:"master-harmonic-content",name:"Harmonic Content",description:"Overall mix richness and complexity",category:"timbre",stemType:"master"},{id:"master-spectral-rolloff",name:"Spectral Rolloff",description:"Overall mix high-frequency content",category:"pitch",stemType:"master"},{id:"master-spectral-flatness",name:"Spectral Flatness",description:"Overall mix tone quality",category:"timbre",stemType:"master"},{id:"master-perceptual-spread",name:"Perceptual Spread",description:"Overall mix stereo width",category:"timbre",stemType:"master"},{id:"master-loudness",name:"Loudness",description:"Overall mix perceived loudness",category:"intensity",stemType:"master"}];return s?e.filter(e=>e.stemType===s):e},[t,s]),d=(0,r.useMemo)(()=>c.reduce((e,t)=>(e[t.category]||(e[t.category]=[]),e[t.category].push(t),e),{}),[c]);return t?(0,i.jsxs)("div",{className:(0,h.cn)("bg-black border border-gray-800 flex flex-col",a),children:[(0,i.jsxs)("div",{className:"p-3 border-b border-gray-800",children:[(0,i.jsxs)("div",{className:"flex items-center gap-2",children:[(0,i.jsx)(eC.Z,{className:"h-4 w-4 text-gray-300"}),(0,i.jsx)("span",{className:"text-sm font-semibold text-gray-100",children:"Audio Features"})]}),(0,i.jsx)("div",{className:"text-xs text-gray-500 mt-1",children:"Drag features to map to effect parameters"})]}),(0,i.jsx)("div",{className:"flex-1 overflow-y-auto p-3 space-y-3",children:Object.entries(d).map(e=>{let[t,a]=e,r=ej[t];return(0,i.jsxs)("div",{className:"space-y-1.5",children:[(0,i.jsxs)("div",{className:"flex items-center gap-2",children:[(0,i.jsx)(r,{className:"h-3 w-3 text-gray-400"}),(0,i.jsx)("span",{className:"text-xs font-medium text-gray-400 uppercase tracking-wider",children:eM[t]||t}),(0,i.jsx)("span",{className:"text-xs text-gray-600 bg-gray-800 px-1.5 py-0.5 rounded border border-gray-700",children:a.length})]}),(0,i.jsx)("div",{className:"space-y-1",children:a.map(e=>(0,i.jsx)(eD,{feature:e,category:e.category,currentTime:n,cachedAnalysis:o,isPlaying:l},e.id))})]},t)})})]}):(0,i.jsxs)("div",{className:(0,h.cn)("bg-black border border-gray-800",a),children:[(0,i.jsx)("div",{className:"p-3 border-b border-gray-800",children:(0,i.jsxs)("div",{className:"flex items-center gap-2",children:[(0,i.jsx)(eC.Z,{className:"h-4 w-4 text-gray-300"}),(0,i.jsx)("span",{className:"text-sm font-semibold text-gray-100",children:"Audio Features"})]})}),(0,i.jsx)("div",{className:"p-4",children:(0,i.jsx)("div",{className:"text-xs text-gray-500 text-center py-2",children:"Select a track to see available features"})})]})}function eA(e,t,a){switch(a){case"add":return e+t;case"multiply":return e*t;default:return t}}function eF(e,t){switch(t){case"velocity":return e.activeNotes.length>0?e.activeNotes.reduce((e,t)=>e+t.velocity,0)/e.activeNotes.length:0;case"cc":return .5*Math.sin(.001*Date.now())+.5;case"pitchBend":return .5*Math.sin(.002*Date.now())+.5;case"channelPressure":return .5*Math.sin(.003*Date.now())+.5;default:return}}function eR(e,t,a,i,r){let s=e;return t.forEach(e=>{let t;switch(e.feature){case"volume":case"bass":case"mid":case"treble":t=a[e.feature];break;case"frequencies":t=a.frequencies.length>0?a.frequencies.reduce((e,t)=>e+t,0)/a.frequencies.length:0;break;case"timeData":t=a.timeData.length>0?a.timeData.reduce((e,t)=>e+t,0)/a.timeData.length:0}if(void 0!==t){var i,r,n,o,l;let a=(r=t,n=e.inputRange[0],o=e.inputRange[1],l=e.outputRange[0],(r-n)/(o-n)*(e.outputRange[1]-l)+l),c=null!==(i=e.modulationAmount)&&void 0!==i?i:1;s=eA(s,a*c,e.blendMode)}}),i.forEach(e=>{let t=eF(r,e.source);if(void 0!==t){var a,i,n;let r=(a=e.inputRange[0],i=e.inputRange[1],n=e.outputRange[0],(t-a)/(i-a)*(e.outputRange[1]-n)+n);s=eA(s,r,e.blendMode)}}),Math.max(0,Math.min(1,s))}function eI(e,t,a,i,r){let s=e.x,n=e.y;return t.forEach(e=>{let t;switch(e.feature){case"volume":case"bass":case"mid":case"treble":t=a[e.feature];break;case"frequencies":t=a.frequencies.length>0?a.frequencies.reduce((e,t)=>e+t,0)/a.frequencies.length:0;break;case"timeData":t=a.timeData.length>0?a.timeData.reduce((e,t)=>e+t,0)/a.timeData.length:0}if(void 0!==t){var i,r,o,l,c;let a=(r=t,o=e.inputRange[0],l=e.inputRange[1],c=e.outputRange[0],((r-o)/(l-o)*(e.outputRange[1]-c)+c)*(null!==(i=e.modulationAmount)&&void 0!==i?i:1));s=eA(s,a,e.blendMode),n=eA(n,a,e.blendMode)}}),i.forEach(e=>{let t=eF(r,e.source);if(void 0!==t){var a,i,o;let r=(a=e.inputRange[0],i=e.inputRange[1],o=e.outputRange[0],(t-a)/(i-a)*(e.outputRange[1]-o)+o);s=eA(s,r,e.blendMode),n=eA(n,r,e.blendMode)}}),{x:Math.max(.1,Math.min(5,s)),y:Math.max(.1,Math.min(5,n))}}function eE(e,t,a,i,r){let s=e;return t.forEach(e=>{let t;switch(e.feature){case"volume":case"bass":case"mid":case"treble":t=a[e.feature];break;case"frequencies":t=a.frequencies.length>0?a.frequencies.reduce((e,t)=>e+t,0)/a.frequencies.length:0;break;case"timeData":t=a.timeData.length>0?a.timeData.reduce((e,t)=>e+t,0)/a.timeData.length:0}if(void 0!==t){var i,r,n,o,l;let a=(r=t,n=e.inputRange[0],o=e.inputRange[1],l=e.outputRange[0],(r-n)/(o-n)*(e.outputRange[1]-l)+l),c=null!==(i=e.modulationAmount)&&void 0!==i?i:1;s=eA(s,a*c,e.blendMode)}}),i.forEach(e=>{let t=eF(r,e.source);if(void 0!==t){var a,i,n;let r=(a=e.inputRange[0],i=e.inputRange[1],n=e.outputRange[0],(t-a)/(i-a)*(e.outputRange[1]-n)+n);s=eA(s,r,e.blendMode)}}),s%360}function eP(e,t,a,i,r){let s=e.x,n=e.y;return t.forEach(e=>{let t;switch(e.feature){case"volume":case"bass":case"mid":case"treble":t=a[e.feature];break;case"frequencies":t=a.frequencies.length>0?a.frequencies.reduce((e,t)=>e+t,0)/a.frequencies.length:0;break;case"timeData":t=a.timeData.length>0?a.timeData.reduce((e,t)=>e+t,0)/a.timeData.length:0}if(void 0!==t){var i,r,o,l,c;let a=(r=t,o=e.inputRange[0],l=e.inputRange[1],c=e.outputRange[0],((r-o)/(l-o)*(e.outputRange[1]-c)+c)*(null!==(i=e.modulationAmount)&&void 0!==i?i:1));s=eA(s,a,e.blendMode),n=eA(n,a,e.blendMode)}}),i.forEach(e=>{let t=eF(r,e.source);if(void 0!==t){var a,i,o;let r=(a=e.inputRange[0],i=e.inputRange[1],o=e.outputRange[0],(t-a)/(i-a)*(e.outputRange[1]-o)+o);s=eA(s,r,e.blendMode),n=eA(n,r,e.blendMode)}}),{x:s,y:n}}let ez=e=>{let{src:t,position:a,scale:s,rotation:n,opacity:o,audioBindings:l,midiBindings:c,zIndex:d,blendMode:u,startTime:m=0,endTime:h,currentTime:f=0,isPlaying:p=!1,audioFeatures:y,midiData:g}=e,x=(0,r.useRef)(null),[v,b]=(0,r.useState)(0),[w,k]=(0,r.useState)(!1),S=!h||f>=m&&f<=h,C=eR(o,l,y||{frequencies:[],timeData:[],volume:0,bass:0,mid:0,treble:0},c,g||{activeNotes:[],currentTime:0,tempo:120,totalNotes:0,trackActivity:{}}),D=eI(s,l,y||{frequencies:[],timeData:[],volume:0,bass:0,mid:0,treble:0},c,g||{activeNotes:[],currentTime:0,tempo:120,totalNotes:0,trackActivity:{}}),j=eE(n,l,y||{frequencies:[],timeData:[],volume:0,bass:0,mid:0,treble:0},c,g||{activeNotes:[],currentTime:0,tempo:120,totalNotes:0,trackActivity:{}}),M=eP(a,l,y||{frequencies:[],timeData:[],volume:0,bass:0,mid:0,treble:0},c,g||{activeNotes:[],currentTime:0,tempo:120,totalNotes:0,trackActivity:{}});return((0,r.useEffect)(()=>{let e=x.current;if(!e)return;let t=()=>b(e.currentTime),a=()=>k(!0);return e.addEventListener("timeupdate",t),e.addEventListener("loadeddata",a),()=>{e.removeEventListener("timeupdate",t),e.removeEventListener("loadeddata",a)}},[]),(0,r.useEffect)(()=>{let e=x.current;e&&w&&(p?e.play().catch(console.error):e.pause())},[p,w]),(0,r.useEffect)(()=>{let e=x.current;if(!e||!w)return;let t=f-m;Math.abs(e.currentTime-t)>.1&&(e.currentTime=Math.max(0,t))},[f,m,w]),S)?(0,i.jsx)("div",{className:"video-layer absolute",style:{left:"".concat(M.x,"%"),top:"".concat(M.y,"%"),transform:"translate(-50%, -50%) scale(".concat(D.x,", ").concat(D.y,") rotate(").concat(j,"deg)"),opacity:C,zIndex:d,mixBlendMode:u,pointerEvents:"none",width:"200px",height:"150px"},children:(0,i.jsx)("video",{ref:x,src:t,autoPlay:!1,loop:!0,muted:!0,playsInline:!0,style:{width:"100%",height:"100%",objectFit:"cover",borderRadius:"4px"}})}):null},eL=e=>{let{src:t,position:a,scale:r,rotation:s,opacity:n,audioBindings:o,midiBindings:l,zIndex:c,blendMode:d,startTime:u=0,endTime:m,currentTime:h=0,audioFeatures:f,midiData:p}=e,y=eR(n,o,f||{frequencies:[],timeData:[],volume:0,bass:0,mid:0,treble:0},l,p||{activeNotes:[],currentTime:0,tempo:120,totalNotes:0,trackActivity:{}}),g=eI(r,o,f||{frequencies:[],timeData:[],volume:0,bass:0,mid:0,treble:0},l,p||{activeNotes:[],currentTime:0,tempo:120,totalNotes:0,trackActivity:{}}),x=eE(s,o,f||{frequencies:[],timeData:[],volume:0,bass:0,mid:0,treble:0},l,p||{activeNotes:[],currentTime:0,tempo:120,totalNotes:0,trackActivity:{}}),v=eP(a,o,f||{frequencies:[],timeData:[],volume:0,bass:0,mid:0,treble:0},l,p||{activeNotes:[],currentTime:0,tempo:120,totalNotes:0,trackActivity:{}});return!m||h>=u&&h<=m?(0,i.jsx)("div",{className:"image-layer absolute",style:{left:"".concat(v.x,"%"),top:"".concat(v.y,"%"),transform:"translate(-50%, -50%) scale(".concat(g.x,", ").concat(g.y,") rotate(").concat(x,"deg)"),opacity:y,zIndex:c,mixBlendMode:d,pointerEvents:"none",width:"200px",height:"150px"},children:(0,i.jsx)("img",{src:t,alt:"Layer",style:{width:"100%",height:"100%",objectFit:"cover",borderRadius:"4px"}})}):null},eO=e=>{let{effectType:t,settings:a,position:r,scale:s,opacity:n,audioBindings:o,midiBindings:l,zIndex:c,blendMode:d,startTime:u=0,endTime:m,currentTime:h=0,audioFeatures:f,midiData:p,onEffectUpdate:y}=e,g=eR(n,o,f||{frequencies:[],timeData:[],volume:0,bass:0,mid:0,treble:0},l,p||{activeNotes:[],currentTime:0,tempo:120,totalNotes:0,trackActivity:{}}),x=eI(s,o,f||{frequencies:[],timeData:[],volume:0,bass:0,mid:0,treble:0},l,p||{activeNotes:[],currentTime:0,tempo:120,totalNotes:0,trackActivity:{}}),v=eP(r,o,f||{frequencies:[],timeData:[],volume:0,bass:0,mid:0,treble:0},l,p||{activeNotes:[],currentTime:0,tempo:120,totalNotes:0,trackActivity:{}});return!m||h>=u&&h<=m?(0,i.jsx)("div",{className:"effect-layer absolute",style:{left:"".concat(v.x,"%"),top:"".concat(v.y,"%"),transform:"translate(-50%, -50%) scale(".concat(x.x,", ").concat(x.y,")"),opacity:g,zIndex:c,mixBlendMode:d,pointerEvents:"none",width:"200px",height:"150px"},children:(0,i.jsx)(()=>(0,i.jsx)("div",{className:"effect-placeholder bg-gradient-to-r from-purple-500 to-pink-500 w-full h-full rounded-lg flex items-center justify-center",children:(0,i.jsx)("span",{className:"text-white text-xs font-mono",children:t})}),{})}):null},eB=e=>{let{layers:t,width:a,height:r,currentTime:s,isPlaying:n,audioFeatures:o,midiData:l,onLayerUpdate:c,onLayerDelete:d}=e,u=[...t].sort((e,t)=>e.zIndex-t.zIndex);return(0,i.jsx)("div",{className:"layer-container relative overflow-hidden",style:{width:"".concat(a,"px"),height:"".concat(r,"px"),background:"transparent"},children:u.map(e=>{let t={key:e.id,startTime:e.startTime,endTime:e.endTime,currentTime:s,isPlaying:n,audioFeatures:o,midiData:l,position:e.position,scale:e.scale,rotation:e.rotation,opacity:e.opacity,audioBindings:e.audioBindings,midiBindings:e.midiBindings,zIndex:e.zIndex,blendMode:e.blendMode};switch(e.type){case"video":return(0,i.jsx)(ez,{...t,src:e.src});case"image":return(0,i.jsx)(eL,{...t,src:e.src});case"effect":return(0,i.jsx)(eO,{...t,effectType:e.effectType,settings:e.settings,onEffectUpdate:(t,a)=>{null==c||c(e.id,{settings:a})}});default:return null}})})};var eW=a(7641),eU=a(6553),e_=a(7756),eq=a(687),eV=a(2018),eH=a(1577);let eG=r.memo(e=>{let{waveformData:t,duration:a,currentTime:s,onSeek:n,isPlaying:o,isLoading:l}=e,c=(0,r.useRef)(null),d=(0,r.useRef)(null);if((0,r.useEffect)(()=>{if(!c.current||!t)return;let e=c.current,a=e.getContext("2d");if(!a)return;let{width:i,height:r}=e.getBoundingClientRect();e.width=i,e.height=r;let s=t.points,n=s.length;a.clearRect(0,0,i,r),a.beginPath(),a.moveTo(0,r/2),a.lineTo(i,r/2),a.strokeStyle="#444",a.lineWidth=1,a.stroke(),a.beginPath();let o=r/2;a.strokeStyle="#ffffff",a.lineWidth=1;for(let e=0;e<n;e++){let t=e/(n-1)*i,r=s[e]*o;a.moveTo(t,o-r),a.lineTo(t,o+r)}a.stroke()},[t]),l)return(0,i.jsx)("div",{className:"h-[32px] flex items-center justify-center bg-stone-800/20",children:(0,i.jsx)("p",{className:"text-xs text-stone-400",children:"Analyzing..."})});if(!t)return(0,i.jsx)("div",{className:"h-[32px] flex items-center justify-center bg-stone-800/20",children:(0,i.jsx)("p",{className:"text-xs text-stone-500",children:"No analysis data available"})});let u=a>0?s/a*100:0;return(0,i.jsxs)("div",{ref:d,className:"relative h-[32px] w-full cursor-pointer",onClick:e=>{if(!n||!d.current)return;let t=d.current.getBoundingClientRect();n((e.clientX-t.left)/t.width*a)},children:[(0,i.jsx)("canvas",{ref:c,className:"absolute inset-0 w-full h-full"}),(0,i.jsx)("div",{className:"absolute top-0 left-0 h-full bg-white/20",style:{width:"".concat(u,"%")}}),(0,i.jsx)("div",{className:"absolute top-0 w-px h-full bg-red-500",style:{left:"".concat(u,"%")}})]})});function eZ(e,t,a){e.strokeStyle="#00ffff",e.lineWidth=2,e.beginPath();for(let i=0;i<t;i++){let t=a/2+a/4*Math.sin(i/20);0===i?e.moveTo(i,t):e.lineTo(i,t)}e.stroke()}function eY(e,t,a){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},{color:r="#00ffff",glowIntensity:s=0,showGrid:n=!1,gridColor:o="#333333",amplitude:l=1,traceWidth:c=2,cornerRadius:d=0}=i;if(n){e.save(),d>0&&(e.beginPath(),e.roundRect(0,0,t,a,d),e.clip()),e.strokeStyle=o,e.lineWidth=.5;for(let i=0;i<=t;i+=t/10)e.beginPath(),e.moveTo(i,0),e.lineTo(i,a),e.stroke();for(let i=0;i<=a;i+=a/8)e.beginPath(),e.moveTo(0,i),e.lineTo(t,i),e.stroke();e.strokeStyle=o,e.lineWidth=1,e.beginPath(),e.moveTo(t/2,0),e.lineTo(t/2,a),e.moveTo(0,a/2),e.lineTo(t,a/2),e.stroke(),e.restore()}if(s>0){e.save();let i=.15*s,n=Math.max(1,Math.floor(t/100));for(let o=0;o<t;o+=n){let t=a/2+a/3*Math.sin(o/10)*Math.sin(o/60)*l,n=e.createRadialGradient(o,t,0,o,t,2.5*s),c=r.startsWith("#")?"rgba(".concat(parseInt(r.slice(1,3),16),", ").concat(parseInt(r.slice(3,5),16),", ").concat(parseInt(r.slice(5,7),16),", ").concat(i,")"):r;n.addColorStop(0,c),n.addColorStop(1,"transparent"),e.fillStyle=n,e.beginPath(),e.arc(o,t,2.5*s,0,2*Math.PI),e.fill()}e.restore()}e.strokeStyle=r,e.lineWidth=c,e.beginPath();for(let i=0;i<t;i++){let t=a/2+a/3*Math.sin(i/10)*Math.sin(i/60)*l;0===i?e.moveTo(i,t):e.lineTo(i,t)}e.stroke()}let eX=[{key:"nw",style:{left:0,top:0,cursor:"nwse-resize"},dx:-1,dy:-1},{key:"n",style:{left:"50%",top:0,transform:"translateX(-50%)",cursor:"ns-resize"},dx:0,dy:-1},{key:"ne",style:{right:0,top:0,cursor:"nesw-resize"},dx:1,dy:-1},{key:"e",style:{right:0,top:"50%",transform:"translateY(-50%)",cursor:"ew-resize"},dx:1,dy:0},{key:"se",style:{right:0,bottom:0,cursor:"nwse-resize"},dx:1,dy:1},{key:"s",style:{left:"50%",bottom:0,transform:"translateX(-50%)",cursor:"ns-resize"},dx:0,dy:1},{key:"sw",style:{left:0,bottom:0,cursor:"nesw-resize"},dx:-1,dy:1},{key:"w",style:{left:0,top:"50%",transform:"translateY(-50%)",cursor:"ew-resize"},dx:-1,dy:0}];function eQ(e){let{id:t,type:a,position:s,size:n,stem:o,settings:l,featureData:c,onOpenModal:d,onUpdate:u,isSelected:m,onSelect:h}=e,f=(0,r.useRef)(null),[p,y]=(0,r.useState)(!1),[g,x]=(0,r.useState)(null),[v,b]=(0,r.useState)(null),[w,k]=(0,r.useState)(null),[S,C]=(0,r.useState)(!1);(0,r.useRef)([]);let D=(0,r.useRef)(),j=(0,r.useRef)(),M=(0,r.useCallback)(e=>{if(p&&v&&u({position:{x:e.clientX-v.x,y:e.clientY-v.y}}),g&&w){let t=eX.find(e=>e.key===g);if(!t)return;let{x:a,y:i,width:r,height:s}=w,n=e.clientX-w.startX,o=e.clientY-w.startY;-1===t.dx&&(r-=n,a+=n),1===t.dx&&(r+=n),-1===t.dy&&(s-=o,i+=o),1===t.dy&&(s+=o),u({position:{x:a,y:i},size:{width:r=Math.max(60,r),height:s=Math.max(40,s)}})}},[p,v,g,w,u]),N=(0,r.useCallback)(()=>{y(!1),x(null),b(null),k(null)},[]);return(0,r.useEffect)(()=>{D.current=M,j.current=N},[M,N]),(0,r.useEffect)(()=>{if(p||g){let e=e=>D.current&&D.current(e),t=e=>j.current&&j.current(e);return window.addEventListener("mousemove",e),window.addEventListener("mouseup",t),()=>{window.removeEventListener("mousemove",e),window.removeEventListener("mouseup",t)}}},[p,g]),(0,r.useEffect)(()=>{var e,t,i,r,s,o,d,u,m;if(!f.current)return;let h=f.current.getContext("2d");if(h)switch(h.clearRect(0,0,n.width,n.height),a){case"waveform":if(Array.isArray(c)&&c.length>0){let e=n.height/2;h.beginPath(),h.moveTo(0,e),h.lineTo(n.width,e),h.strokeStyle="#444",h.lineWidth=1,h.stroke(),h.beginPath(),h.strokeStyle=l.color||"#4db3fa",h.lineWidth=1;for(let t=0;t<n.width;t++){let a=Math.floor(t/n.width*(c.length-1)),i=c[a]*e*.8,r=t;h.moveTo(r,e-i),h.lineTo(r,e+i)}h.stroke()}else eZ(h,n.width,n.height);break;case"oscilloscope":let p="number"==typeof l.amplitude?l.amplitude:1,y=l.color||"#00ffff",g="number"==typeof l.glowIntensity?l.glowIntensity:0,x="number"==typeof l.traceWidth?l.traceWidth:2,v=!!l.showGrid,b=l.gridColor||"#333333";if(Array.isArray(c)&&c.length>0){if(v){h.save();let e=l.cornerRadius||0;e>0&&(h.beginPath(),h.roundRect(0,0,n.width,n.height,e),h.clip()),h.strokeStyle=b,h.lineWidth=.5;for(let e=0;e<=n.width;e+=n.width/10)h.beginPath(),h.moveTo(e,0),h.lineTo(e,n.height),h.stroke();for(let e=0;e<=n.height;e+=n.height/8)h.beginPath(),h.moveTo(0,e),h.lineTo(n.width,e),h.stroke();h.strokeStyle=b,h.lineWidth=1,h.beginPath(),h.moveTo(n.width/2,0),h.lineTo(n.width/2,n.height),h.moveTo(0,n.height/2),h.lineTo(n.width,n.height/2),h.stroke(),h.restore()}if(g>0){h.save();let e=.15*g,t=Math.max(1,Math.floor(n.width/100));for(let a=0;a<n.width;a+=t){let t=Math.floor(a/n.width*(c.length-1)),i=(c[t]-.5)*2,r=n.height/2-n.height/2*i*p,s=h.createRadialGradient(a,r,0,a,r,2.5*g),o=y.startsWith("#")?"rgba(".concat(parseInt(y.slice(1,3),16),", ").concat(parseInt(y.slice(3,5),16),", ").concat(parseInt(y.slice(5,7),16),", ").concat(e,")"):y;s.addColorStop(0,o),s.addColorStop(1,"transparent"),h.fillStyle=s,h.beginPath(),h.arc(a,r,2.5*g,0,2*Math.PI),h.fill()}h.restore()}h.strokeStyle=y,h.lineWidth=x,h.beginPath();for(let e=0;e<n.width;e++){let t=Math.floor(e/n.width*(c.length-1)),a=(c[t]-.5)*2,i=n.height/2-n.height/2*a*p;0===e?h.moveTo(e,i):h.lineTo(e,i)}h.stroke()}else eY(h,n.width,n.height,{...l,amplitude:p,traceWidth:x});break;case"spectrogram":if(console.log("\uD83C\uDFB5 Spectrogram rendering check:",{hasFeatureData:!!c,hasFft:!!(c&&c.fft),isArray:!!(c&&c.fft&&Array.isArray(c.fft)),hasBuffer:!!(c&&c.fftBuffer),bufferLength:(null==c?void 0:null===(e=c.fftBuffer)||void 0===e?void 0:e.length)||0,fftLength:(null==c?void 0:null===(t=c.fft)||void 0===t?void 0:t.length)||0}),c&&c.fft&&Array.isArray(c.fft)){console.log("\uD83C\uDFB5 Spectrogram rendering with cached FFT data:",{fftLength:c.fft.length,sampleValues:c.fft.slice(0,5),maxValue:Math.max(...c.fft),minValue:Math.min(...c.fft),hasBuffer:!!c.fftBuffer,bufferLength:(null===(i=c.fftBuffer)||void 0===i?void 0:i.length)||0});let e=c.fftBuffer;if(!e||0===e.length){console.log("\uD83C\uDFB5 No buffer available, creating simple buffer from FFT data");let t=[];for(let e=0;e<50;e++)t.push(Float32Array.from(c.fft));e=t}console.log("\uD83C\uDFB5 Spectrogram buffer state:",{bufferLength:e.length,firstFrameLength:(null===(r=e[0])||void 0===r?void 0:r.length)||0}),h.clearRect(0,0,n.width,n.height);let t=n.width,a=n.height,o=e.length,d=(null===(s=e[0])||void 0===s?void 0:s.length)||0;if(o>0&&d>0){let i=l.colorMap||"Classic",r=(e,t)=>{let a=Math.max(0,Math.min(1,Math.log10(e+1e-10)/Math.log10(1.1)));switch(i){case"Inferno":if(a<.25)return"rgb(".concat(Math.floor(a/.25*255),", 0, 0)");if(a<.5)return"rgb(255, ".concat(Math.floor((a-.25)/.25*255),", 0)");if(a<.75)return"rgb(255, 255, ".concat(Math.floor((a-.5)/.25*255),")");return"rgb(255, 255, ".concat(Math.floor(255*(1-(a-.75)/.25)),")");case"Viridis":return"hsl(".concat(240-120*a,", 90%, ").concat(30+50*a,"%)");case"Rainbow":return"hsl(".concat((240*t+60*a)%360,", 90%, ").concat(30+70*a,"%)");default:return"hsl(".concat(240-(240*t+60*a),", 90%, ").concat(30+70*a,"%)")}},s=window.devicePixelRatio||1,n=t*s,c=a*s,u=document.createElement("canvas");u.width=n,u.height=c;let m=u.getContext("2d");if(m){m.scale(s,s);for(let i=0;i<o;i++){let s=e[i];if(s)for(let e=0;e<a;e++){let n=1-e/a,l=Math.floor(n*d);if(l>=0&&l<s.length){let a=r(s[l],n);m.fillStyle=a;let c=Math.floor(i*t/o),d=Math.max(1,Math.floor(t/o));m.fillRect(c,e,d,1)}}}h.drawImage(u,0,0,t,a)}else for(let i=0;i<o;i++){let s=e[i];if(s)for(let e=0;e<a;e++){let n=1-e/a,l=Math.floor(n*d);if(l>=0&&l<s.length){let a=r(s[l],n);h.fillStyle=a;let c=Math.floor(i*t/o),d=Math.max(1,Math.floor(t/o));h.fillRect(c,e,d,1)}}}l.showFrequencyLabels&&(h.fillStyle="rgba(255, 255, 255, 0.7)",h.font="10px monospace",h.textAlign="right",[20,50,100,200,500,1e3,2e3,5e3,1e4,2e4].forEach(e=>{let i=(1-(Math.log10(e)-Math.log10(20))/(Math.log10(2e4)-Math.log10(20)))*a;i>=0&&i<a&&h.fillText("".concat(e,"Hz"),t-5,i-5)}))}}else!function(e,t,a){for(let i=0;i<t;i+=2)for(let t=0;t<a;t+=2)e.fillStyle="hsl(".concat((i+t)%360,", 80%, ").concat(40+30*Math.sin(i/30),"%)"),e.fillRect(i,t,2,2)}(h,n.width,n.height);break;case"spectrumAnalyzer":if(c&&c.fft&&Array.isArray(c.fft)){let e=c.fft,t=l.barColor||"#00ffff",a=Math.min(128,Math.floor(n.width/4)),i=e.length;h.clearRect(0,0,n.width,n.height);for(let r=0;r<a;r++){let s=Math.floor(20*Math.pow(1e3,r/a)/22050*i),o=Math.ceil(20*Math.pow(1e3,(r+1)/a)/22050*i);s=Math.max(0,s),o=Math.min(i,o);let l=0,c=0;for(let t=s;t<o;t++){let a=e[t],r=1/(1+t/i*22050/1e3);l+=a*r,c+=r}let d=Math.max(0,Math.min(1,(Math.log10((c>0?l/c:0)+1e-10)+6)/4)),u=n.width/a,m=d*n.height*.95,f=h.createLinearGradient(r*u,n.height-m,r*u,n.height),p=r/a,y="hsl(".concat(180+60*p,", 90%, 60%)"),g="hsl(".concat(240+60*p,", 90%, 60%)");f.addColorStop(0,y),f.addColorStop(1,g),h.fillStyle=f,h.fillRect(r*u,n.height-m,u-1,m),d>.7&&(h.shadowColor=t,h.shadowBlur=5,h.fillRect(r*u,n.height-m,u-1,m),h.shadowBlur=0)}l.showFrequencyLabels&&(h.fillStyle="rgba(255, 255, 255, 0.7)",h.font="10px monospace",h.textAlign="center",[20,50,100,200,500,1e3,2e3,5e3,1e4,2e4].forEach(e=>{let t=(Math.log10(e)-Math.log10(20))/(Math.log10(2e4)-Math.log10(20))*n.width;t>=0&&t<n.width&&h.fillText("".concat(e,"Hz"),t,n.height-5)}))}else if(Array.isArray(c)&&c.length>0){let e=n.width/c.length;for(let t=0;t<c.length;t++){let a=Math.max(2,c[t]*n.height*.9);h.fillStyle="hsl(".concat(180+t%120,", 90%, 60%)"),h.fillRect(t*e,n.height-a,e-1,a)}}else!function(e,t,a){for(let i=0;i<t;i+=8){let t=a*(.2+.7*Math.abs(Math.sin(i/40)));e.fillStyle="hsl(".concat(180+i%120,", 90%, 60%)"),e.fillRect(i,a-t,6,t)}}(h,n.width,n.height);break;case"peakMeter":if("number"==typeof c){let e=Math.max(0,Math.min(1,c));h.fillStyle=e>.8?"#f00":e>.5?"#ff0":"#0f0",h.fillRect(0,n.height*(1-e),n.width,n.height*e)}else o=n.width,d=n.height,h.fillStyle="#0f0",h.fillRect(0,.7*d,o,.2*d),h.fillStyle="#ff0",h.fillRect(0,.5*d,o,.2*d),h.fillStyle="#f00",h.fillRect(0,.3*d,o,.2*d);break;case"stereometer":{let e=c&&c.stereoWindow;if(!e&&c&&c.stereoWindow_left&&c.stereoWindow_right&&(e={left:c.stereoWindow_left,right:c.stereoWindow_right}),e&&e.left&&e.right){console.log("[stereometer render]",{leftLength:e.left.length,rightLength:e.right.length,leftSample:e.left.slice(0,5),rightSample:e.right.slice(0,5),type:typeof e.left[0]});let t=e.left,a=e.right,i=Math.min(t.length,a.length,1024);h.save(),h.globalAlpha=.8,h.strokeStyle="#00ffff",h.lineWidth=1.5,h.beginPath();for(let e=0;e<i;e++){let i=t[e],r=a[e],s=(i+1)/2*n.width,o=(r+1)/2*n.height;0===e?h.moveTo(s,o):h.lineTo(s,o)}h.stroke(),h.globalAlpha=.2;for(let e=0;e<i;e+=4){let i=t[e],r=a[e],s=(i+1)/2*n.width,o=(r+1)/2*n.height;h.beginPath(),h.arc(s,o,2,0,2*Math.PI),h.fillStyle="#00ffff",h.fill()}h.restore()}else!function(e,t,a){e.strokeStyle="#ff00ff",e.beginPath();for(let i=0;i<360;i+=2){let r=i*Math.PI/180,s=a/2*(.7+.3*Math.sin(i/30)),n=t/2+s*Math.cos(r),o=a/2+s*Math.sin(r);0===i?e.moveTo(n,o):e.lineTo(n,o)}e.closePath(),e.stroke()}(h,n.width,n.height);break}case"midiMeter":"number"==typeof c?(h.fillStyle="#fff",h.font="bold 18px monospace",h.fillText("MIDI: "+c,n.width/2-40,n.height/2),h.strokeStyle="#0ff",h.strokeRect(n.width/2-40,n.height/2-20,80,40)):(u=n.width,m=n.height,h.fillStyle="#fff",h.font="bold 18px monospace",h.fillText("MIDI",u/2-30,m/2),h.strokeStyle="#0ff",h.strokeRect(u/2-40,m/2-20,80,40));break;case"vuMeter":{let e=0;"Peak"===l.meterType&&"number"==typeof c.peak?e=c.peak:"number"==typeof c.rms&&(e=c.rms),function(e,t,a,i,r){let s=r.color||"#00ff55",n=r.style||"Needle";if(e.save(),e.clearRect(0,0,t,a),"Needle"===n){e.strokeStyle="#333",e.lineWidth=6,e.beginPath(),e.arc(t/2,.9*a,.7*a,Math.PI,2*Math.PI,!1),e.stroke();let r=Math.PI+i*Math.PI;e.strokeStyle=s,e.lineWidth=3,e.beginPath(),e.moveTo(t/2,.9*a),e.lineTo(t/2+Math.cos(r)*a*.7,.9*a+Math.sin(r)*a*.7),e.stroke()}else e.fillStyle=s,e.fillRect(.3*t,.1*a,.4*t,.8*a*i),e.strokeStyle="#333",e.strokeRect(.3*t,.1*a,.4*t,.8*a);e.restore()}(h,n.width,n.height,e,l);break}case"chromaWheel":!function(e,t,a,i,r){let s={Classic:["#ff0000","#ff8000","#ffff00","#80ff00","#00ff00","#00ff80","#00ffff","#0080ff","#0000ff","#8000ff","#ff00ff","#ff0080"],Rainbow:["#ff0000","#ff7f00","#ffff00","#7fff00","#00ff00","#00ff7f","#00ffff","#007fff","#0000ff","#7f00ff","#ff00ff","#ff007f"],Viridis:["#440154","#482878","#3e4989","#31688e","#26828e","#1f9e89","#35b779","#6ece58","#b5de2b","#fee825","#fde725","#f9d923"],Inferno:["#000004","#1b0c41","#4a0c6b","#781c6d","#a52c60","#cf4446","#ed6925","#fb9b06","#f7d13d","#fcffa4","#fffbb4","#fff7ec"]},n=s[r.colorScheme]||s.Classic,o=r.showNoteNames;e.save(),e.clearRect(0,0,t,a);let l=t/2,c=a/2,d=.45*Math.min(t,a);for(let t=0;t<12;t++){let a=t/12*2*Math.PI-Math.PI/2,r=(t+1)/12*2*Math.PI-Math.PI/2;e.beginPath(),e.moveTo(l,c),e.arc(l,c,d,a,r,!1),e.closePath(),e.fillStyle=n[t],e.globalAlpha=i&&i[t]?Math.max(.2,i[t]):.2,e.fill(),e.globalAlpha=1,o&&(e.save(),e.translate(l,c),e.rotate((a+r)/2),e.textAlign="center",e.textBaseline="middle",e.font="bold 10px monospace",e.fillStyle="#fff",e.fillText(["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"][t],.7*d,0),e.restore())}e.restore()}(h,n.width,n.height,c&&c.chroma,l);break;case"waveform":if(Array.isArray(c)&&c.length>0){let e=n.height/2;h.beginPath(),h.moveTo(0,e),h.lineTo(n.width,e),h.strokeStyle="#444",h.lineWidth=1,h.stroke(),h.beginPath(),h.strokeStyle=l.color||"#4db3fa",h.lineWidth=1;for(let t=0;t<n.width;t++){let a=Math.floor(t/n.width*(c.length-1)),i=.8*e*((c[a]-.5)*2),r=t;h.moveTo(r,e-i),h.lineTo(r,e+i)}h.stroke()}else eZ(h,n.width,n.height);if(l.showTransients&&Array.isArray(c.transients)){for(let e of(h.save(),h.strokeStyle=l.transientColor||"#ff0",h.lineWidth=1.5,c.transients)){let t=Math.floor(e*n.width);h.beginPath(),h.moveTo(t,0),h.lineTo(t,n.height),h.stroke()}h.restore()}break;case"oscilloscope":{let e="number"==typeof l.amplitude?l.amplitude:1,t=l.color||"#00ffff",a="number"==typeof l.glowIntensity?l.glowIntensity:0,i="number"==typeof l.traceWidth?l.traceWidth:2,r=!!l.showGrid,s=l.gridColor||"#333333";if(Array.isArray(c)&&c.length>0){if(r){h.save();let e=l.cornerRadius||0;e>0&&(h.beginPath(),h.roundRect(0,0,n.width,n.height,e),h.clip()),h.strokeStyle=s,h.lineWidth=.5;for(let e=0;e<=n.width;e+=n.width/10)h.beginPath(),h.moveTo(e,0),h.lineTo(e,n.height),h.stroke();for(let e=0;e<=n.height;e+=n.height/8)h.beginPath(),h.moveTo(0,e),h.lineTo(n.width,e),h.stroke();h.strokeStyle=s,h.lineWidth=1,h.beginPath(),h.moveTo(n.width/2,0),h.lineTo(n.width/2,n.height),h.moveTo(0,n.height/2),h.lineTo(n.width,n.height/2),h.stroke(),h.restore()}if(a>0){h.save();let i=.15*a,r=Math.max(1,Math.floor(n.width/100));for(let s=0;s<n.width;s+=r){let r=Math.floor(s/n.width*(c.length-1)),o=(c[r]-.5)*2,l=n.height/2-n.height/2*o*e,d=h.createRadialGradient(s,l,0,s,l,2.5*a),u=t.startsWith("#")?"rgba(".concat(parseInt(t.slice(1,3),16),", ").concat(parseInt(t.slice(3,5),16),", ").concat(parseInt(t.slice(5,7),16),", ").concat(i,")"):t;d.addColorStop(0,u),d.addColorStop(1,"transparent"),h.fillStyle=d,h.beginPath(),h.arc(s,l,2.5*a,0,2*Math.PI),h.fill()}h.restore()}h.strokeStyle=t,h.lineWidth=i,h.beginPath();for(let t=0;t<n.width;t++){let a=Math.floor(t/n.width*(c.length-1)),i=(c[a]-.5)*2,r=n.height/2-n.height/2*i*e;0===t?h.moveTo(t,r):h.lineTo(t,r)}h.stroke()}else eY(h,n.width,n.height,{...l,amplitude:e,traceWidth:i});break}default:eZ(h,n.width,n.height)}},[a,o,n,l,c]),(0,i.jsxs)("div",{"data-overlay-id":t,style:{position:"absolute",left:s.x,top:s.y,width:n.width,height:n.height,pointerEvents:"auto",zIndex:10,borderRadius:void 0!==l.cornerRadius?"".concat(l.cornerRadius,"px"):0,background:l.glass||l.glassmorphism?"rgba(20, 40, 60, 0.25)":"rgba(0,0,0,0.2)",userSelect:p||g?"none":"auto",cursor:p?"grabbing":"grab",backdropFilter:l.glass||l.glassmorphism?"blur(12px)":void 0,WebkitBackdropFilter:l.glass||l.glassmorphism?"blur(12px)":void 0,border:m?"1px dashed white":l.outline?"".concat(l.outlineWidth||1,"px solid ").concat(l.outlineColor||"#ffffff"):void 0,boxShadow:m?"0 0 0 1px rgba(255,255,255,0.2)":l.dropShadow?"0 4px ".concat(l.shadowBlur||8,"px ").concat(l.shadowColor||"#000000","40"):void 0,transition:"background 0.2s",isolation:"isolate"},onMouseDown:e=>{e.target.classList.contains("transform-anchor")||(y(!0),b({x:e.clientX-s.x,y:e.clientY-s.y})),h&&h()},onDoubleClick:d,onMouseEnter:()=>C(!0),onMouseLeave:()=>C(!1),children:[(0,i.jsx)("canvas",{ref:f,width:n.width,height:n.height,style:{width:"100%",height:"100%",display:"block",borderRadius:void 0!==l.cornerRadius?"".concat(l.cornerRadius,"px"):0}}),S&&eX.map(e=>(0,i.jsx)("div",{className:"transform-anchor",style:{position:"absolute",width:12,height:12,background:"#fff",border:"1px solid #ccc",borderRadius:2,boxShadow:"0 1px 2px rgba(0,0,0,0.08)",...e.style,zIndex:20,opacity:.95,transition:"background 0.2s, box-shadow 0.2s"},onMouseDown:t=>{var a;return a=e.key,void(t.stopPropagation(),x(a),k({startX:t.clientX,startY:t.clientY,x:s.x,y:s.y,width:n.width,height:n.height}))}},e.key))]})}let eK={waveform:[{label:"Color",key:"color",type:"color"},{label:"Line Width",key:"lineWidth",type:"number"},{label:"Corner Radius",key:"cornerRadius",type:"number",min:0,max:50,step:1},{label:"Drop Shadow",key:"dropShadow",type:"checkbox"},{label:"Shadow Color",key:"shadowColor",type:"color"},{label:"Shadow Blur",key:"shadowBlur",type:"number",min:0,max:50,step:1},{label:"Outline",key:"outline",type:"checkbox"},{label:"Outline Color",key:"outlineColor",type:"color"},{label:"Outline Width",key:"outlineWidth",type:"number",min:1,max:10,step:1}],spectrogram:[{label:"Color Map",key:"colorMap",type:"select",options:["Classic","Inferno","Viridis","Rainbow"]},{label:"Show Frequency Labels",key:"showFrequencyLabels",type:"checkbox"},{label:"Brightness",key:"brightness",type:"number",min:0,max:2,step:.01},{label:"Contrast",key:"contrast",type:"number",min:0,max:2,step:.01},{label:"Scroll Speed",key:"scrollSpeed",type:"number",min:.1,max:5,step:.1},{label:"FFT Size",key:"fftSize",type:"number",min:256,max:4096,step:256},{label:"Corner Radius",key:"cornerRadius",type:"number",min:0,max:50,step:1},{label:"Drop Shadow",key:"dropShadow",type:"checkbox"},{label:"Shadow Color",key:"shadowColor",type:"color"},{label:"Shadow Blur",key:"shadowBlur",type:"number",min:0,max:50,step:1},{label:"Outline",key:"outline",type:"checkbox"},{label:"Outline Color",key:"outlineColor",type:"color"},{label:"Outline Width",key:"outlineWidth",type:"number",min:1,max:10,step:1}],peakMeter:[{label:"Peak Color",key:"peakColor",type:"color"},{label:"Hold Time (ms)",key:"holdTime",type:"number"},{label:"Corner Radius",key:"cornerRadius",type:"number",min:0,max:50,step:1},{label:"Drop Shadow",key:"dropShadow",type:"checkbox"},{label:"Shadow Color",key:"shadowColor",type:"color"},{label:"Shadow Blur",key:"shadowBlur",type:"number",min:0,max:50,step:1},{label:"Outline",key:"outline",type:"checkbox"},{label:"Outline Color",key:"outlineColor",type:"color"},{label:"Outline Width",key:"outlineWidth",type:"number",min:1,max:10,step:1}],stereometer:[{label:"Trace Color",key:"traceColor",type:"color"},{label:"Glow Intensity",key:"glowIntensity",type:"number",min:0,max:1,step:.01},{label:"Point Size",key:"pointSize",type:"number",min:1,max:10,step:1},{label:"Show Grid",key:"showGrid",type:"checkbox"},{label:"Corner Radius",key:"cornerRadius",type:"number",min:0,max:50,step:1},{label:"Drop Shadow",key:"dropShadow",type:"checkbox"},{label:"Shadow Color",key:"shadowColor",type:"color"},{label:"Shadow Blur",key:"shadowBlur",type:"number",min:0,max:50,step:1},{label:"Outline",key:"outline",type:"checkbox"},{label:"Outline Color",key:"outlineColor",type:"color"},{label:"Outline Width",key:"outlineWidth",type:"number",min:1,max:10,step:1}],oscilloscope:[{label:"Follow Pitch",key:"followPitch",type:"checkbox"},{label:"Color",key:"color",type:"color"},{label:"Glow Intensity",key:"glowIntensity",type:"slider"},{label:"Amplitude",key:"amplitude",type:"slider"},{label:"Trace Width",key:"traceWidth",type:"slider",min:.5,max:2,step:.1},{label:"Show Grid",key:"showGrid",type:"checkbox"},{label:"Grid Color",key:"gridColor",type:"color"},{label:"Corner Radius",key:"cornerRadius",type:"number",min:0,max:50,step:1},{label:"Drop Shadow",key:"dropShadow",type:"checkbox"},{label:"Shadow Color",key:"shadowColor",type:"color"},{label:"Shadow Blur",key:"shadowBlur",type:"number",min:0,max:50,step:1},{label:"Outline",key:"outline",type:"checkbox"},{label:"Outline Color",key:"outlineColor",type:"color"},{label:"Outline Width",key:"outlineWidth",type:"number",min:1,max:10,step:1}],spectrumAnalyzer:[{label:"Bar Color",key:"barColor",type:"color"},{label:"Show Frequency Labels",key:"showFrequencyLabels",type:"checkbox"},{label:"FFT Size",key:"fftSize",type:"number"},{label:"Corner Radius",key:"cornerRadius",type:"number",min:0,max:50,step:1},{label:"Drop Shadow",key:"dropShadow",type:"checkbox"},{label:"Shadow Color",key:"shadowColor",type:"color"},{label:"Shadow Blur",key:"shadowBlur",type:"number",min:0,max:50,step:1},{label:"Outline",key:"outline",type:"checkbox"},{label:"Outline Color",key:"outlineColor",type:"color"},{label:"Outline Width",key:"outlineWidth",type:"number",min:1,max:10,step:1}],midiMeter:[{label:"Show Note Names",key:"showNoteNames",type:"checkbox"},{label:"Color",key:"color",type:"color"},{label:"Corner Radius",key:"cornerRadius",type:"number",min:0,max:50,step:1},{label:"Drop Shadow",key:"dropShadow",type:"checkbox"},{label:"Shadow Color",key:"shadowColor",type:"color"},{label:"Shadow Blur",key:"shadowBlur",type:"number",min:0,max:50,step:1},{label:"Outline",key:"outline",type:"checkbox"},{label:"Outline Color",key:"outlineColor",type:"color"},{label:"Outline Width",key:"outlineWidth",type:"number",min:1,max:10,step:1}],consoleFeed:[{label:"Data Source",key:"dataSource",type:"select",options:["MIDI","LUFS/RMS","FFT Summary","All"]},{label:"Font Size",key:"fontSize",type:"number",min:8,max:20,step:1},{label:"Font Color",key:"fontColor",type:"color"},{label:"Max Lines",key:"maxLines",type:"number",min:10,max:100,step:1},{label:"Scroll Speed",key:"scrollSpeed",type:"number",min:.1,max:5,step:.1},{label:"Glassmorphism Background",key:"glassmorphism",type:"checkbox"},{label:"Corner Radius",key:"cornerRadius",type:"number",min:0,max:50,step:1},{label:"Drop Shadow",key:"dropShadow",type:"checkbox"},{label:"Shadow Color",key:"shadowColor",type:"color"},{label:"Shadow Blur",key:"shadowBlur",type:"number",min:0,max:50,step:1},{label:"Outline",key:"outline",type:"checkbox"},{label:"Outline Color",key:"outlineColor",type:"color"},{label:"Outline Width",key:"outlineWidth",type:"number",min:1,max:10,step:1}],vuMeter:[{label:"Color",key:"color",type:"color"},{label:"Style",key:"style",type:"select",options:["Needle","Bar"]},{label:"Meter Type",key:"meterType",type:"select",options:["RMS","Peak"]},{label:"Glassmorphism Background",key:"glassmorphism",type:"checkbox"},{label:"Corner Radius",key:"cornerRadius",type:"number",min:0,max:50,step:1},{label:"Drop Shadow",key:"dropShadow",type:"checkbox"},{label:"Shadow Color",key:"shadowColor",type:"color"},{label:"Shadow Blur",key:"shadowBlur",type:"number",min:0,max:50,step:1},{label:"Outline",key:"outline",type:"checkbox"},{label:"Outline Color",key:"outlineColor",type:"color"},{label:"Outline Width",key:"outlineWidth",type:"number",min:1,max:10,step:1}],chromaWheel:[{label:"Color Scheme",key:"colorScheme",type:"select",options:["Classic","Rainbow","Viridis","Inferno"]},{label:"Show Note Names",key:"showNoteNames",type:"checkbox"},{label:"Glassmorphism Background",key:"glassmorphism",type:"checkbox"},{label:"Corner Radius",key:"cornerRadius",type:"number",min:0,max:50,step:1},{label:"Drop Shadow",key:"dropShadow",type:"checkbox"},{label:"Shadow Color",key:"shadowColor",type:"color"},{label:"Shadow Blur",key:"shadowBlur",type:"number",min:0,max:50,step:1},{label:"Outline",key:"outline",type:"checkbox"},{label:"Outline Color",key:"outlineColor",type:"color"},{label:"Outline Width",key:"outlineWidth",type:"number",min:1,max:10,step:1}]};function eJ(e){var t,a,s,n,o,l,c,d,u;let{overlay:m,onClose:h,onUpdate:f}=e,p=m.settings||{},y=eK[m.type]||[];function g(e,t){f({settings:{...p,[e]:t}})}let[{isOver:x,canDrop:v},b]=(0,P.L)({accept:["feature","AUDIO_STEM"],drop:e=>{"AUDIO_STEM"===e.type?f({stem:{id:e.id,name:e.name,stemType:e.stemType}}):f({stem:{id:e.id,name:e.stemType||e.id,stemType:e.stemType}})},canDrop:()=>!0,collect:e=>({isOver:e.isOver(),canDrop:e.canDrop()})}),w=r.useCallback(e=>{b(e)},[b]);return(0,i.jsx)(A,{title:"".concat(m.type.charAt(0).toUpperCase()+m.type.slice(1)," Settings"),isOpen:!0,onClose:h,children:(0,i.jsxs)("div",{className:"space-y-6",children:[(0,i.jsxs)("div",{children:[(0,i.jsx)("div",{className:"font-bold text-xs mb-2 text-white/80",children:"Audio Source"}),(0,i.jsxs)("div",{className:"space-y-2",children:[(0,i.jsxs)("div",{className:"flex items-center justify-between",children:[(0,i.jsx)("label",{className:"text-white/80 text-xs font-mono",children:"Audio Stem"}),(0,i.jsxs)("div",{ref:w,className:"\n                  relative flex items-center justify-center w-8 h-6 rounded-full cursor-pointer\n                  transition-all duration-200 ease-out\n                  ".concat((null===(t=m.stem)||void 0===t?void 0:t.id)?"bg-emerald-600/20 border-2 border-emerald-500/50 shadow-lg":"bg-stone-700/50 border-2 border-stone-600/50 shadow-inner","\n                  ").concat(x&&v?"scale-110 bg-emerald-500/30 border-emerald-400 shadow-lg ring-2 ring-emerald-400/50":"","\n                  ").concat((null===(a=m.stem)||void 0===a?void 0:a.id)||x?"":"hover:bg-stone-600/60 hover:border-stone-500/60","\n                "),style:{boxShadow:(null===(s=m.stem)||void 0===s?void 0:s.id)?"\n                      inset 0 1px 0 rgba(255, 255, 255, 0.1),\n                      inset 0 -1px 0 rgba(0, 0, 0, 0.2),\n                      0 2px 4px rgba(0, 0, 0, 0.3),\n                      0 0 8px rgba(16, 185, 129, 0.3)\n                    ":"\n                      inset 0 1px 0 rgba(255, 255, 255, 0.05),\n                      inset 0 -1px 0 rgba(0, 0, 0, 0.3),\n                      0 1px 2px rgba(0, 0, 0, 0.2)\n                    ",background:(null===(n=m.stem)||void 0===n?void 0:n.id)?"linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(16, 185, 129, 0.1) 100%)":"linear-gradient(135deg, rgba(68, 64, 60, 0.5) 0%, rgba(41, 37, 36, 0.5) 100%)"},children:[!(null===(o=m.stem)||void 0===o?void 0:o.id)&&(0,i.jsx)("div",{className:"\n                    w-2 h-2 rounded-full transition-all duration-200\n                    ".concat(x&&v?"bg-emerald-400 scale-125":"bg-stone-400/50","\n                  ")}),(null===(l=m.stem)||void 0===l?void 0:l.id)&&(0,i.jsx)("div",{className:"w-2 h-2 rounded-full bg-emerald-400 animate-pulse"})]})]}),(0,i.jsxs)("div",{className:"relative",children:[(0,i.jsx)("div",{className:"text-xs text-white/80",children:"Drop a stem here to drive this overlay"}),(null===(c=m.stem)||void 0===c?void 0:c.id)&&(null===(d=m.stem)||void 0===d?void 0:d.name)&&(0,i.jsx)("div",{className:"absolute -top-2 -right-2 z-10",children:(0,i.jsxs)(z.C,{className:"bg-emerald-600/90 text-emerald-100 text-xs px-2 py-1 border border-emerald-500/50 shadow-lg",style:{boxShadow:"0 2px 4px rgba(0, 0, 0, 0.3), 0 0 8px rgba(16, 185, 129, 0.2)"},children:[(0,i.jsx)("span",{className:"mr-1",children:m.stem.name}),(0,i.jsx)("button",{onClick:e=>{e.stopPropagation(),f({stem:null})},className:"ml-1 hover:bg-emerald-500/50 rounded-full p-0.5 transition-colors",children:(0,i.jsx)(L.Z,{className:"h-3 w-3"})})]})})]}),x&&v&&!(null===(u=m.stem)||void 0===u?void 0:u.id)&&(0,i.jsx)("div",{className:"text-xs text-emerald-400/80 font-mono animate-pulse",children:"Drop to assign stem"})]})]}),y.length>0&&(0,i.jsxs)("div",{children:[(0,i.jsx)("div",{className:"font-bold text-xs mb-2 text-white/80",children:"Overlay Settings"}),(0,i.jsx)("div",{className:"space-y-3",children:y.map(e=>{var t,a,r,s,n,o,l,c,d;return(0,i.jsxs)("div",{className:"flex items-center gap-2",children:[(0,i.jsx)("label",{className:"text-xs text-white/70 w-32",children:e.label}),"color"===e.type&&(0,i.jsx)("input",{type:"color",value:null!==(r=p[e.key])&&void 0!==r?r:"gridColor"===e.key?"#333333":"shadowColor"===e.key?"#000000":"outlineColor"===e.key?"#ffffff":"#00ffff",onChange:t=>g(e.key,t.target.value)}),"number"===e.type&&("cornerRadius"===e.key||"shadowBlur"===e.key||"outlineWidth"===e.key)&&(0,i.jsxs)("div",{className:"flex-1",children:[(0,i.jsx)(F.i,{value:[null!==(s=p[e.key])&&void 0!==s?s:"cornerRadius"===e.key?8:"shadowBlur"===e.key?8:1],onValueChange:t=>{let[a]=t;return g(e.key,a)},min:e.min||0,max:e.max||50,step:e.step||1,className:"w-full"}),(0,i.jsx)("div",{className:"text-xs text-white/60 mt-1",children:null!==(n=p[e.key])&&void 0!==n?n:"cornerRadius"===e.key?8:"shadowBlur"===e.key?8:1})]}),"number"===e.type&&!("cornerRadius"===e.key||"shadowBlur"===e.key||"outlineWidth"===e.key)&&(0,i.jsx)("input",{type:"number",value:null!==(o=p[e.key])&&void 0!==o?o:"",onChange:t=>g(e.key,Number(t.target.value)),className:"w-20 px-1 rounded"}),"slider"===e.type&&(0,i.jsxs)("div",{className:"flex-1",children:[(0,i.jsx)(F.i,{value:[null!==(l=p[e.key])&&void 0!==l?l:"glowIntensity"===e.key?0:"amplitude"===e.key?1:"traceWidth"===e.key?2:0],onValueChange:t=>{let[a]=t;return g(e.key,a)},min:"amplitude"===e.key?.1:"traceWidth"===e.key?.5:0,max:"amplitude"===e.key?2:"traceWidth"===e.key?2:5,step:"amplitude"===e.key?.01:(e.key,.1),className:"w-full"}),(0,i.jsx)("div",{className:"text-xs text-white/60 mt-1",children:null!==(c=p[e.key])&&void 0!==c?c:"glowIntensity"===e.key?0:"amplitude"===e.key?1:"traceWidth"===e.key?2:0})]}),"checkbox"===e.type&&(0,i.jsx)("input",{type:"checkbox",checked:null!==(d=p[e.key])&&void 0!==d?d:"showGrid"!==e.key&&!1,onChange:t=>g(e.key,t.target.checked)}),"select"===e.type&&(0,i.jsx)("select",{value:p[e.key]||(null===(t=e.options)||void 0===t?void 0:t[0]),onChange:t=>g(e.key,t.target.value),className:"px-1 rounded",children:null===(a=e.options)||void 0===a?void 0:a.map(e=>(0,i.jsx)("option",{value:e,children:e},e))})]},e.key)})})]})]})})}Object.keys(eK).forEach(e=>{eK[e].push({label:"Glassmorphism Background",key:"glassmorphism",type:"checkbox"})}),eK.waveform.push({label:"Show Transient Detector",key:"showTransients",type:"checkbox"}),eK.waveform.push({label:"Transient Color",key:"transientColor",type:"color"}),eK.waveform.push({label:"Transient Sensitivity",key:"transientSensitivity",type:"number",min:.01,max:1,step:.01}),eK.oscilloscope.push({label:"Lissajous Stereo Mode",key:"lissajous",type:"checkbox"});let e$=(0,r.createContext)(void 0);function e0(){let e=(0,r.useContext)(e$);if(!e)throw Error("useHudOverlayContext must be used within HudOverlayProvider");return e}let e1=e=>{let{children:t,cachedAnalysis:a=[],stemAudio:o,stemUrlMap:l={}}=e,[c,d]=(0,r.useState)([]),[u,m]=(0,r.useState)(null),[h,f]=(0,r.useState)(null),[p,y]=(0,r.useState)(!1),[g,x]=(0,r.useState)(0);(0,r.useRef)([]);let v=(0,r.useRef)(0);(0,r.useEffect)(()=>{let e;let t=()=>{let a=performance.now();v.current,v.current=a,x(e=>e+1),e=requestAnimationFrame(t)};return e=requestAnimationFrame(t),()=>cancelAnimationFrame(e)},[]);let b=ek(),w=ew(),k=a.length>0?a:b.cachedAnalysis,S=o||w;function C(e){return e?{...e,url:e.url||l[e.id]||""}:null}function D(e,t){let a=function(){if(!k||0===k.length)return null;let e=k.find(e=>"master"===e.stemType);return!e&&k.length>0&&(e=k.reduce((e,t)=>{var a,i;return((null===(a=t.metadata)||void 0===a?void 0:a.duration)||0)>((null==e?void 0:null===(i=e.metadata)||void 0===i?void 0:i.duration)||0)?t:e},k[0])),e||k[0]}(),i=a?C({id:a.fileMetadataId,name:a.stemType||"master",stemType:a.stemType}):null;i||console.warn("\uD83C\uDFB5 No master stem available for overlay, creating overlay without audio data"),d(a=>{let r=[...a,{id:Math.random().toString(36).slice(2),type:e,position:t||{x:100+40*a.length,y:100+40*a.length},size:{width:400,height:120},stem:i,settings:{}}];return function(e){let t=e.map(e=>C(e.stem)).filter(e=>e&&e.url);t.length>0&&S&&S.loadStems&&S.loadStems(t)}(r),r})}function j(e,t){d(a=>a.map(a=>a.id===e?{...a,...t}:a))}function N(e){d(t=>t.filter(t=>t.id!==e))}function T(e){m(e)}function A(){m(null)}return(0,r.useEffect)(()=>{},[k,a.length]),(0,r.useEffect)(()=>{},[k,g,a.length]),(0,r.useEffect)(()=>{function e(e){("Delete"===e.key||"Backspace"===e.key)&&h&&(N(h),f(null))}return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[h]),(0,r.useEffect)(()=>{y(!0)},[]),(0,r.useEffect)(()=>{let e=c.map(e=>{var t;return null===(t=e.stem)||void 0===t?void 0:t.id}).filter(Boolean);if(!e.every(e=>l[e])){console.log("[HudOverlayManager] Waiting for all stem URLs to be available",{allStemIds:e,stemUrlMap:l});return}c.forEach(e=>{e.stem&&e.stem.id&&(e.stem.url=l[e.stem.id])});let t=function(e,t){let a=[];return e.forEach(e=>{if(e.stem&&e.stem.id){let i=e.stem.url||t[e.stem.id];i&&a.push({...e.stem,url:i})}}),a}(c,l);S&&t.length>0&&(console.log("[HudOverlayManager] Calling loadStems with",t),S.loadStems(t))},[c,l,S]),(0,i.jsxs)(e$.Provider,{value:{overlays:c,addOverlay:D,updateOverlay:j,removeOverlay:N,moveOverlay:function(e,t){d(a=>{let i=[...a],[r]=i.splice(e,1);return i.splice(t,0,r),i})},openOverlayModal:T,modalOverlayId:u,closeOverlayModal:A,selectedOverlayId:h,setSelectedOverlayId:f},children:[t,p&&(0,M.createPortal)((0,i.jsx)(s.W,{backend:n.PD,children:(0,i.jsx)(e2,{addOverlay:D,setSelectedOverlayId:f,children:(0,i.jsxs)("div",{id:"hud-overlays",style:{position:"absolute",top:0,left:0,width:"100%",height:"100%",pointerEvents:"auto",zIndex:20},children:[c.map(e=>(0,i.jsx)(eQ,{...e,featureData:function(e){var t,a,i;if(!e.stem||!e.stem.id||!k||0===k.length)return null;let r=k.find(t=>t.fileMetadataId===e.stem.id);if(!r||!r.analysisData)return null;let s=function(e){switch(e){case"waveform":case"oscilloscope":case"peakMeter":case"midiMeter":return["rms","loudness"];case"spectrogram":case"spectrumAnalyzer":return["fft","spectralCentroid","rms","loudness"];case"stereometer":return["spectralCentroid","rms"];default:return["rms"]}}(e.type),n=null;if("spectrogram"===e.type||"spectrumAnalyzer"===e.type){if(r.analysisData.fft&&Array.isArray(r.analysisData.fft)&&r.analysisData.fft.length>0){let e=(null===(a=r.metadata)||void 0===a?void 0:a.duration)||1,t=(null==S?void 0:S.currentTime)||0,i=(null==S?void 0:S.isLooping)?t%e:t,s=r.analysisData.fft,n=[];for(let e=0;e<200;e++){let t=i-(200-e)*.1,a=new Float32Array(s.length),r=2*t*Math.PI,o=t*Math.PI;for(let e=0;e<s.length;e++){let t=e/s.length,i=s[e],n=1+.3*Math.sin(r+t*Math.PI*4),l=1+.2*Math.sin(o+t*Math.PI*2),c=1+.1*Math.sin(3*r+.1*e);a[e]=Math.max(0,i*n*l*c)}n.push(a)}return{fft:n[n.length-1],fftBuffer:n}}{let e=(null===(i=r.metadata)||void 0===i?void 0:i.duration)||1,t=(null==S?void 0:S.currentTime)||0,a=(null==S?void 0:S.isLooping)?t%e:t,s=new Float32Array(512);for(let e=0;e<512;e++){let t=e/512,a=.8*Math.exp(-(3*t)),i=.6*Math.exp(-(10*Math.pow(t-.3,2))),r=.4*Math.exp(-(5*Math.pow(t-.8,2)));s[e]=a+i+r+.1*Math.random()}let n=[];for(let e=0;e<200;e++){let t=a-(200-e)*.1,i=new Float32Array(512),r=2*t*Math.PI,o=t*Math.PI;for(let e=0;e<512;e++){let t=e/512,a=s[e],n=1+.3*Math.sin(r+t*Math.PI*4),l=1+.2*Math.sin(o+t*Math.PI*2),c=1+.1*Math.sin(3*r+.1*e);i[e]=Math.max(0,a*n*l*c)}n.push(i)}return{fft:n[n.length-1],fftBuffer:n}}}for(let e of s)if(r.analysisData[e]){n=r.analysisData[e];break}if(!n){let e=Object.keys(r.analysisData).filter(e=>Array.isArray(r.analysisData[e])&&r.analysisData[e].length>0);if(!(e.length>0))return null;n=r.analysisData[e[0]],e[0]}let o=(null===(t=r.metadata)||void 0===t?void 0:t.duration)||1,l=(null==S?void 0:S.currentTime)||0,c=Math.floor(Math.max(0,Math.min(((null==S?void 0:S.isLooping)?l%o:l)/o,1))*(n.length-1)),d=n[c];if("waveform"===e.type||"oscilloscope"===e.type){let e=c+1;return n.slice(Math.max(0,e-100),e)}if("spectrogram"===e.type||"spectrumAnalyzer"===e.type)return null;if("stereometer"!==e.type)return d;if(S&&S.getStereoWindow&&e.stem&&e.stem.id){let t=S.getStereoWindow(e.stem.id,1024);if(console.log("[stereometer getStereoWindow call]",{audioControllerExists:!!S,getStereoWindowExists:!!S.getStereoWindow,stemId:e.stem.id,stereoWindow:t}),t)return{stereoWindow:t}}return null}(e),onOpenModal:()=>T(e.id),onUpdate:t=>j(e.id,t),isSelected:h===e.id,onSelect:()=>f(e.id)},e.id)),u&&(0,i.jsx)(eJ,{overlay:c.find(e=>e.id===u),onClose:A,onUpdate:e=>j(u,e)})]})})}),document.getElementById("hud-overlays")||document.body)]})};function e2(e){let{addOverlay:t,setSelectedOverlayId:a,children:s}=e,n=r.useRef(null),[,o]=(0,P.L)({accept:["EFFECT_CARD"],drop:(e,a)=>{if("EFFECT_CARD"===e.type){let i=a.getClientOffset();if(i&&n.current){let a=n.current.getBoundingClientRect(),r=i.x-a.left,s=i.y-a.top;t(e.id,{x:r,y:s})}else t(e.id,void 0)}}});return o(n),(0,i.jsx)("div",{ref:n,style:{position:"absolute",top:0,left:0,width:"100%",height:"100%"},onClick:e=>{let t=e.target,i=t.closest("[data-overlay-id]");t!==n.current&&"hud-overlays"!==t.id||i||a(null)},children:s})}let e5=e=>{let{title:t,icon:a,isExpanded:r,onToggle:s,children:n,itemCount:o,itemType:l}=e;return(0,i.jsxs)("div",{className:"mb-1",children:[(0,i.jsxs)("button",{onClick:s,className:"w-full flex items-center justify-between py-1 px-2 bg-black border-b border-stone-700 text-xs font-mono font-bold text-white uppercase tracking-widest hover:bg-stone-900 transition-colors",style:{borderRadius:0},children:[(0,i.jsxs)("div",{className:"flex items-center gap-2",children:[a,(0,i.jsx)("span",{children:t})]}),(0,i.jsxs)("div",{className:"flex items-center gap-2",children:[(0,i.jsxs)("span",{className:"text-stone-400 font-normal",children:[o," ",l]}),r?(0,i.jsx)(eW.Z,{className:"h-3 w-3 text-stone-400"}):(0,i.jsx)(H.Z,{className:"h-3 w-3 text-stone-400"})]})]}),r&&(0,i.jsx)("div",{className:"pl-2",children:n})]})},e3=e=>{let{layer:t,index:a,startX:s,width:n,isActive:o,isSelected:l,isEmptyLane:c,onLayerSelect:d,onLayerDelete:u,onEffectClipEdit:m,onEffectClipRemove:f,onAssetDrop:p,currentTime:y,duration:g}=e,x="effect"===t.type,[{isOver:v,canDrop:b},w]=(0,P.L)({accept:["VIDEO_FILE","IMAGE_FILE","EFFECT_CARD"],drop:e=>{c&&p(e,t.id)},collect:e=>({isOver:e.isOver(),canDrop:e.canDrop()})}),k=(0,r.useCallback)(e=>{c&&w(e)},[w,c]);return(0,i.jsxs)("div",{ref:k,className:(0,h.cn)("absolute border border-stone-700 cursor-pointer flex items-center px-2 transition-all rounded-md",c?v&&b?"bg-emerald-950 border-emerald-400 text-emerald-400":"bg-stone-800/50 border-dashed border-stone-600 text-stone-400 hover:bg-stone-700/50 hover:border-stone-500":l?"bg-white text-black border-white":o?x?"bg-purple-400 text-black border-purple-500":"bg-emerald-500 text-black border-emerald-400":"bg-stone-700 text-stone-100 border-stone-700 hover:bg-stone-600 hover:text-white hover:border-white"),style:{left:"".concat(s,"px"),width:"".concat(n,"px"),minWidth:"60px",top:"".concat(32*a+8,"px"),height:"24px"},onClick:e=>{e.stopPropagation(),x?m(t.id):d(t.id)},onDoubleClick:e=>{e.stopPropagation(),x&&m(t.id)},children:[(0,i.jsx)("div",{className:"flex items-center gap-1",children:c?(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(eU.Z,{className:"h-3 w-3"}),(0,i.jsx)("span",{className:"truncate font-medium",children:v&&b?"Drop here":"Empty Lane"})]}):(0,i.jsxs)(i.Fragment,{children:["video"===t.type?(0,i.jsx)(e_.Z,{className:"h-3 w-3"}):"image"===t.type?(0,i.jsx)(eq.Z,{className:"h-3 w-3"}):(0,i.jsx)(eC.Z,{className:"h-3 w-3"}),(0,i.jsx)("span",{className:"truncate font-medium",children:"video"===t.type?"Video":"image"===t.type?"Image":t.src||"Effect"})]})}),!c&&(0,i.jsxs)("span",{className:"ml-2 text-[10px] text-stone-400",children:[(t.startTime||0).toFixed(1),"s - ",(t.endTime||g).toFixed(1),"s"]}),(0,i.jsx)("button",{className:"ml-auto px-1 text-stone-400 hover:text-red-500 border-none bg-transparent focus:outline-none text-xs rounded",onClick:e=>{e.stopPropagation(),x?f(t.id):u(t.id)},"aria-label":"Delete layer",children:"\xd7"})]})},e4=e=>{let{id:t,name:a,waveformData:r,isLoading:s,isActive:n,onClick:o,isSoloed:c,onToggleSolo:d,isMaster:u,onSeek:m,currentTime:f,stemType:p,isPlaying:y,analysisStatus:g,analysisProgress:x}=e,[{isDragging:v},b]=(0,q.c)({type:"AUDIO_STEM",item:{id:t,name:a,stemType:p},collect:e=>({isDragging:e.isDragging()})});return(0,i.jsxs)("div",{ref:b,className:(0,h.cn)("flex items-center group bg-stone-900/50 cursor-pointer transition-all border-l-4",n?"border-emerald-400 bg-emerald-900/30":"border-transparent hover:bg-stone-800/40"),style:{opacity:v?.5:1,height:"32px",minHeight:"32px"},onClick:o,children:[(0,i.jsxs)("div",{className:"w-56 px-3 py-2 flex items-center justify-between gap-2 border-r border-stone-700/50 flex-shrink-0",children:[(0,i.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,i.jsx)("p",{className:"text-sm font-medium text-stone-200 truncate group-hover:text-emerald-400",title:a,children:a}),r&&(0,i.jsxs)("p",{className:"text-xs text-stone-400",children:[r.duration.toFixed(2),"s"]}),s&&!r&&(0,i.jsx)(z.C,{variant:"secondary",className:"mt-1 text-xs",children:"Loading..."})]}),u?(0,i.jsx)(z.C,{variant:"outline",className:"border-amber-400 text-amber-400",children:"MASTER"}):(0,i.jsx)(l.z,{variant:c?"secondary":"ghost",size:"sm",onClick:e=>{e.stopPropagation(),d()},className:(0,h.cn)("transition-all px-3 font-semibold",c?"bg-yellow-400/80 text-black hover:bg-yellow-400":"text-stone-400 hover:text-white hover:bg-stone-700"),children:"Solo"})]}),(0,i.jsx)("div",{className:"flex-1 min-w-0 px-2 overflow-hidden",children:x?(0,i.jsxs)("div",{className:"w-full bg-stone-700 rounded-full h-2.5 my-auto",children:[(0,i.jsx)("div",{className:"bg-blue-600 h-2.5 rounded-full",style:{width:"".concat(100*x.progress,"%")}}),(0,i.jsx)("p",{className:"text-xs text-stone-400 truncate",children:x.message})]}):(0,i.jsx)("div",{className:"w-full overflow-hidden",children:(0,i.jsx)(eG,{waveformData:r,duration:(null==r?void 0:r.duration)||1,currentTime:f,onSeek:m,isPlaying:y,isLoading:s})})})]})};e4.displayName="StemTrack";let e8=e=>{let{overlay:t,index:a,moveOverlay:s,onOpenModal:n,onDelete:o}=e,l=r.useRef(null),[{isDragging:c},d]=(0,q.c)({type:"HUD_OVERLAY_CARD",item:{index:a},collect:e=>({isDragging:e.isDragging()})}),[,u]=(0,P.L)({accept:"HUD_OVERLAY_CARD",hover:e=>{e.index!==a&&(s(e.index,a),e.index=a)}});return d(u(l)),(0,i.jsxs)("div",{ref:l,style:{opacity:c?.5:1,width:56,height:56,margin:4,background:"#111",border:"2px solid #00ffff",borderRadius:8,boxShadow:"0 0 8px #00ffff88",display:"flex",alignItems:"center",justifyContent:"center",cursor:"grab",position:"relative"},onDoubleClick:n,title:t.type,children:[(0,i.jsx)("span",{style:{color:"#00ffff",fontWeight:700,fontSize:12,textShadow:"0 0 4px #00ffff"},children:t.type}),(0,i.jsx)("button",{onClick:e=>{e.stopPropagation(),o()},style:{position:"absolute",top:2,right:2,background:"none",border:"none",color:"#00ffff",fontWeight:900,fontSize:14,cursor:"pointer",padding:0},title:"Remove overlay",children:"\xd7"})]})},e6=()=>{let{overlays:e,moveOverlay:t,openOverlayModal:a,removeOverlay:r,addOverlay:s}=e0(),[,n]=(0,P.L)({accept:["EFFECT_CARD"],drop:e=>{"EFFECT_CARD"===e.type&&"Overlays"===e.category&&s(e.id)}});return(0,i.jsxs)("div",{ref:n,style:{display:"flex",alignItems:"center",minHeight:72,background:"linear-gradient(90deg, #0ff2, #222 60%)",borderBottom:"2px solid #00ffff",position:"relative",padding:"0 8px",marginBottom:8},children:[(0,i.jsxs)("div",{style:{marginRight:12,display:"flex",alignItems:"center",gap:4},children:[(0,i.jsx)("span",{style:{color:"#00ffff",fontWeight:700,fontSize:13},children:"HUD Overlays"}),(0,i.jsx)("span",{title:"Overlays are always visible. Drag up/down to reorder stacking. Drag from sidebar to add.",children:(0,i.jsx)("svg",{width:"16",height:"16",style:{verticalAlign:"middle"},children:(0,i.jsx)("rect",{x:"2",y:"2",width:"12",height:"12",rx:"3",fill:"#00ffff33",stroke:"#00ffff",strokeWidth:"2"})})})]}),(0,i.jsx)("div",{style:{display:"flex",flexDirection:"row",gap:4},children:e.map((e,s)=>(0,i.jsx)(e8,{overlay:e,index:s,moveOverlay:t,onOpenModal:()=>a(e.id),onDelete:()=>r(e.id)},e.id))})]})},e7=e=>{let{layers:t,onLayerAdd:a,onLayerUpdate:s,onLayerDelete:n,onLayerSelect:o,selectedLayerId:l,effectClips:c,onEffectClipAdd:d,onEffectClipRemove:u,onEffectClipEdit:m,stems:f=[],masterStemId:p=null,onStemSelect:y,activeTrackId:g=null,soloedStems:x=new Set,onToggleSolo:v,analysisProgress:b={},cachedAnalysis:w=[],stemLoadingState:k=!1,stemError:S=null,currentTime:C,duration:D,isPlaying:j,onSeek:M,className:N}=e,[T,A]=(0,r.useState)({composition:!0,audio:!0});(0,r.useEffect)(()=>{0===t.length&&0===c.length&&a({id:"layer-".concat(Date.now()),type:"image",src:"",position:{x:50,y:50},scale:{x:1,y:1},rotation:0,opacity:1,audioBindings:[],midiBindings:[],zIndex:0,blendMode:"normal",startTime:0,endTime:D,duration:D})},[]);let F=(e,i)=>{if(console.log("Asset dropped on timeline:",e,"target layer:",i),i){let a=t.find(e=>e.id===i);if(a&&!a.src){switch(e.type){case"VIDEO_FILE":s(i,{type:"video",src:e.src});break;case"IMAGE_FILE":s(i,{type:"image",src:e.src});break;case"EFFECT_CARD":s(i,{type:"effect",src:e.name||e.id,effectType:e.id,settings:e.parameters||{}});break;default:console.warn("Unknown asset type:",e.type)}return}}let r=t.find(e=>!e.src&&"effect"!==e.type);if(r)switch(e.type){case"VIDEO_FILE":s(r.id,{type:"video",src:e.src});break;case"IMAGE_FILE":s(r.id,{type:"image",src:e.src});break;case"EFFECT_CARD":s(r.id,{type:"effect",src:e.name||e.id,effectType:e.id,settings:e.parameters||{}});break;default:console.warn("Unknown asset type:",e.type);return}else switch(e.type){case"VIDEO_FILE":a({id:"video-".concat(Date.now()),type:"video",src:e.src,position:{x:50,y:50},scale:{x:1,y:1},rotation:0,opacity:1,audioBindings:[],midiBindings:[],zIndex:t.length,blendMode:"normal",startTime:0,endTime:D,duration:D});break;case"IMAGE_FILE":a({id:"image-".concat(Date.now()),type:"image",src:e.src,position:{x:50,y:50},scale:{x:1,y:1},rotation:0,opacity:1,audioBindings:[],midiBindings:[],zIndex:t.length,blendMode:"normal",startTime:0,endTime:D,duration:D});break;case"EFFECT_CARD":a({id:"effect-".concat(Date.now()),type:"effect",src:e.name||e.id,effectType:e.id,settings:e.parameters||{},position:{x:50,y:50},scale:{x:1,y:1},rotation:0,opacity:1,audioBindings:[],midiBindings:[],zIndex:t.length,blendMode:"normal",startTime:0,endTime:D,duration:D});break;default:console.warn("Unknown asset type:",e.type);return}},R=e=>100*e,I=e=>e/100,E=Math.max(100*D,800),P=e=>{A(t=>({...t,[e]:!t[e]}))};return(0,i.jsxs)("div",{className:(0,h.cn)("bg-stone-800 border border-stone-700 font-mono text-xs rounded-xl",N),children:[(0,i.jsxs)("div",{className:"flex items-center gap-2 px-2 py-1 border-b border-stone-700 text-white font-bold font-mono text-xs uppercase tracking-widest rounded-t-xl",children:[(0,i.jsx)(eC.Z,{className:"h-4 w-4"})," Timeline"]}),(0,i.jsx)("div",{className:"p-0",children:(0,i.jsx)("div",{className:"overflow-x-auto",children:(0,i.jsxs)("div",{className:"min-w-max",children:[(0,i.jsx)(e5,{title:"Composition Layers",icon:(0,i.jsx)(e_.Z,{className:"h-3 w-3"}),isExpanded:T.composition,onToggle:()=>P("composition"),itemCount:t.length+c.length,itemType:"layers",children:(0,i.jsxs)("div",{className:"space-y-1",children:[(0,i.jsx)("div",{className:"flex justify-between items-center mb-2",children:(0,i.jsx)("div",{className:"flex gap-2",children:(0,i.jsx)("button",{onClick:()=>{a({id:"layer-".concat(Date.now()),type:"image",src:"",position:{x:50,y:50},scale:{x:1,y:1},rotation:0,opacity:1,audioBindings:[],midiBindings:[],zIndex:t.length,blendMode:"normal",startTime:0,endTime:D,duration:D})},className:"px-3 py-1 bg-stone-700 hover:bg-stone-600 text-white text-xs font-mono rounded border border-stone-600 transition-colors",children:"+ Add Layer"})})}),(0,i.jsxs)("div",{className:"relative border-2 border-dashed border-stone-700 transition-all mb-1 bg-stone-800 rounded-lg overflow-hidden",onClick:e=>{if(!M)return;let t=e.currentTarget.getBoundingClientRect();M(Math.max(0,Math.min(D,I(e.clientX-t.left))))},style:{width:"".concat(E,"px"),height:"".concat(32*Math.max(t.length+c.length,1)+16,"px")},children:[0===t.length&&0===c.length&&(0,i.jsx)("div",{className:"absolute inset-0 flex items-center justify-center",children:(0,i.jsxs)("div",{className:"text-center text-stone-500",children:[(0,i.jsx)(eU.Z,{className:"h-4 w-4 mx-auto mb-1"}),(0,i.jsx)("div",{className:"text-xs",children:"Add layers and drag assets to them"})]})}),[...t,...c.map((e,a)=>({id:e.id,type:"effect",src:e.name,position:{x:50,y:50},scale:{x:1,y:1},rotation:0,opacity:1,audioBindings:[],midiBindings:[],zIndex:t.length+a,blendMode:"normal",startTime:e.startTime,endTime:e.endTime,duration:e.endTime-e.startTime}))].sort((e,t)=>e.zIndex-t.zIndex).map((e,t)=>{let a=R(e.startTime||0),r=R((e.endTime||D)-(e.startTime||0)),s=C>=(e.startTime||0)&&C<=(e.endTime||D),c=l===e.id,d="effect"!==e.type&&!e.src;return(0,i.jsx)(e3,{layer:e,index:t,startX:a,width:r,isActive:s,isSelected:c,isEmptyLane:d,onLayerSelect:o,onLayerDelete:n,onEffectClipEdit:m,onEffectClipRemove:u,onAssetDrop:F,currentTime:C,duration:D},e.id)}),(0,i.jsx)("div",{className:"absolute top-0 w-0.5 bg-emerald-400 pointer-events-none z-10",style:{left:"".concat(R(C),"px"),height:"100%"}})]})]})}),(0,i.jsx)(e5,{title:"Audio & MIDI",icon:(0,i.jsx)(ee.Z,{className:"h-3 w-3"}),isExpanded:T.audio,onToggle:()=>P("audio"),itemCount:f.length,itemType:"tracks",children:(0,i.jsxs)("div",{className:"space-y-1",children:[f.map(e=>{var t,a,r;let s=w.find(t=>t.fileMetadataId===e.id),n=null==b?void 0:b[e.id];return(0,i.jsx)(e4,{id:e.id,name:e.file_name,waveformData:null!==(t=null==s?void 0:s.waveformData)&&void 0!==t?t:null,isLoading:k,isActive:e.id===g,onClick:()=>null==y?void 0:y(e.id),isSoloed:x.has(e.id),onToggleSolo:()=>null==v?void 0:v(e.id),isMaster:e.id===p,onSeek:M,currentTime:C,stemType:null!==(r=null!==(a=null==s?void 0:s.stemType)&&void 0!==a?a:e.stem_type)&&void 0!==r?r:"unknown",isPlaying:j,analysisStatus:e.analysis_status,analysisProgress:n},e.id)}),0===f.length&&(0,i.jsx)("div",{className:"h-8 bg-stone-800 border-2 border-dashed border-stone-700 flex items-center justify-center rounded-lg",children:(0,i.jsxs)("div",{className:"text-center text-stone-500",children:[(0,i.jsxs)("div",{className:"flex items-center gap-2 mb-1",children:[(0,i.jsx)(eV.Z,{className:"h-3 w-3"}),(0,i.jsx)($.Z,{className:"h-3 w-3"})]}),(0,i.jsx)("div",{className:"text-xs",children:"No audio stems available"})]})}),S&&(0,i.jsx)("p",{className:"text-xs text-red-500 p-2",children:S})]})}),(0,i.jsx)(e5,{title:"HUD Overlays",icon:(0,i.jsx)(eH.Z,{className:"h-3 w-3"}),isExpanded:T.composition,onToggle:()=>P("composition"),itemCount:0,itemType:"overlays",children:(0,i.jsx)(e6,{})})]})})})]})},e9=e=>{let{onAddLayer:t,className:a}=e;return(0,i.jsxs)("div",{className:"flex items-center gap-2 p-2 bg-stone-800/50 rounded-lg border border-stone-600 ".concat(a),children:[(0,i.jsx)("span",{className:"text-xs font-mono text-stone-400",children:"TEST:"}),(0,i.jsxs)(l.z,{size:"sm",variant:"outline",onClick:()=>{t({id:"video-".concat(Date.now()),type:"video",src:"https://sample-videos.com/zip/10/mp4/SampleVideo_1280x720_1mb.mp4",position:{x:50,y:50},scale:{x:1,y:1},rotation:0,opacity:1,audioBindings:[{feature:"volume",inputRange:[0,1],outputRange:[.5,1],blendMode:"multiply"}],midiBindings:[{source:"velocity",inputRange:[0,127],outputRange:[.8,1.2],blendMode:"multiply"}],zIndex:0,blendMode:"normal",startTime:0,endTime:30,duration:30})},className:"h-6 px-2 text-xs bg-blue-900/20 border-blue-600 text-blue-300 hover:bg-blue-800/30",children:[(0,i.jsx)(e_.Z,{className:"h-3 w-3 mr-1"}),"Video"]}),(0,i.jsxs)(l.z,{size:"sm",variant:"outline",onClick:()=>{t({id:"image-".concat(Date.now()),type:"image",src:"https://picsum.photos/400/300",position:{x:25,y:25},scale:{x:.8,y:.8},rotation:15,opacity:.8,audioBindings:[{feature:"bass",inputRange:[0,1],outputRange:[.5,1.5],blendMode:"multiply"}],midiBindings:[],zIndex:1,blendMode:"multiply",startTime:5,endTime:25,duration:20})},className:"h-6 px-2 text-xs bg-green-900/20 border-green-600 text-green-300 hover:bg-green-800/30",children:[(0,i.jsx)(eq.Z,{className:"h-3 w-3 mr-1"}),"Image"]}),(0,i.jsxs)(l.z,{size:"sm",variant:"outline",onClick:()=>{t({id:"effect-".concat(Date.now()),type:"effect",effectType:"metaballs",settings:{animationSpeed:1,glowIntensity:.8},position:{x:75,y:75},scale:{x:1.2,y:1.2},rotation:0,opacity:.9,audioBindings:[{feature:"treble",inputRange:[0,1],outputRange:[.5,2],blendMode:"multiply"}],midiBindings:[{source:"velocity",inputRange:[0,127],outputRange:[.5,1.5],blendMode:"multiply"}],zIndex:2,blendMode:"screen",startTime:0,endTime:30,duration:30})},className:"h-6 px-2 text-xs bg-purple-900/20 border-purple-600 text-purple-300 hover:bg-purple-800/30",children:[(0,i.jsx)(eC.Z,{className:"h-3 w-3 mr-1"}),"Effect"]})]})};var te=a(7333),tt=a(5590),ta=a(4343),ti=a(8257),tr=a(6059);let ts={mobile:(0,i.jsx)(tt.Z,{className:"h-3 w-3"}),youtube:(0,i.jsx)(ta.Z,{className:"h-3 w-3"}),instagram:(0,i.jsx)(ti.Z,{className:"h-3 w-3"}),tiktok:(0,i.jsx)(e_.Z,{className:"h-3 w-3"}),landscape:(0,i.jsx)(tr.Z,{className:"h-3 w-3"})},tn={mobile:"MOB",youtube:"YT",instagram:"IG",tiktok:"TT",landscape:"LS"};function to(e){let{currentAspectRatio:t,onAspectRatioChange:a,disabled:r=!1,className:s}=e;W[t]||W.mobile;let n=ts[t]||ts.mobile,o=tn[t]||"MOB";return(0,i.jsxs)(te.h_,{children:[(0,i.jsx)(te.$F,{asChild:!0,children:(0,i.jsxs)(l.z,{variant:"outline",size:"sm",disabled:r,className:"bg-stone-800 border-stone-600 text-stone-300 hover:bg-stone-700 hover:border-stone-500 font-mono text-xs uppercase tracking-wider px-2 py-1 ".concat(s),style:{borderRadius:"6px"},children:[n," ",o,(0,i.jsx)(H.Z,{className:"h-3 w-3 ml-1"})]})}),(0,i.jsx)(te.AW,{align:"end",className:"bg-stone-800 border-stone-600 text-stone-300",children:Object.entries(W).map(e=>{let[r,s]=e;return(0,i.jsx)(te.Xi,{onClick:()=>a(r),className:"text-xs font-mono uppercase tracking-wider hover:bg-stone-700 ".concat(t===r?"bg-stone-700 text-white":"text-stone-300"),children:(0,i.jsxs)("span",{className:"flex items-center gap-2",children:[ts[r],s.name,(0,i.jsxs)("span",{className:"text-stone-500 ml-auto",children:[s.width,":",s.height]})]})},r)})})]})}let tl=e=>{let{effects:t,selectedEffects:a,onEffectToggle:s,onEffectDoubleClick:n,isVisible:o,stemUrlsReady:l}=e,[c,d]=(0,r.useState)(!1);(0,r.useEffect)(()=>{d(!0)},[]);let u=e0();return(0,i.jsx)(Y,{effects:t,selectedEffects:a,onEffectToggle:s,onEffectDoubleClick:e=>{if(!l){console.warn("[EffectsLibrarySidebarWithHud] Overlay creation blocked: stem URLs not ready");return}let a=t.find(t=>t.id===e);if(a&&"Overlays"===a.category&&c){let t={waveform:"waveform",spectrogram:"spectrogram",peakMeter:"peakMeter",stereometer:"stereometer",oscilloscope:"oscilloscope",spectrumAnalyzer:"spectrumAnalyzer",midiMeter:"midiMeter"}[e];t&&(console.log("\uD83C\uDFAF Adding HUD overlay:",t),u.addOverlay(t))}n(e)},isVisible:o})},tc=()=>{let e=[],t=[60,64,67,72,69,65,62,60,67,64,69,72,74,67,64,60];for(let a=0;a<t.length;a++)e.push({id:"melody-".concat(a),start:.5*a,duration:.4,pitch:t[a],velocity:60+40*Math.random(),track:"melody",noteName:"Note".concat(t[a])});return[2,4,6,8].forEach((t,a)=>{[48,52,55].forEach((i,r)=>{e.push({id:"chord-".concat(a,"-").concat(r),start:t,duration:1.5,pitch:i,velocity:40+30*Math.random(),track:"melody",noteName:"Chord".concat(i)})})}),{file:{name:"Creative Demo.mid",size:1024,duration:10,ticksPerQuarter:480,timeSignature:[4,4],keySignature:"C Major"},tracks:[{id:"melody",name:"Synth Lead",instrument:"Synthesizer",channel:1,color:"#84a98c",visible:!0,notes:e},{id:"bass",name:"Bass Synth",instrument:"Bass",channel:2,color:"#6b7c93",visible:!0,notes:[{id:"b1",start:0,duration:1,pitch:36,velocity:100,track:"bass",noteName:"C2"},{id:"b2",start:1,duration:1,pitch:40,velocity:95,track:"bass",noteName:"E2"},{id:"b3",start:2,duration:1,pitch:43,velocity:90,track:"bass",noteName:"G2"},{id:"b4",start:3,duration:1,pitch:48,velocity:85,track:"bass",noteName:"C3"},{id:"b5",start:4,duration:2,pitch:36,velocity:100,track:"bass",noteName:"C2"}]},{id:"drums",name:"Drums",instrument:"Drum Kit",channel:10,color:"#b08a8a",visible:!0,notes:[{id:"d1",start:0,duration:.1,pitch:36,velocity:120,track:"drums",noteName:"Kick"},{id:"d2",start:.5,duration:.1,pitch:42,velocity:80,track:"drums",noteName:"HiHat"},{id:"d3",start:1,duration:.1,pitch:38,velocity:100,track:"drums",noteName:"Snare"},{id:"d4",start:1.5,duration:.1,pitch:42,velocity:70,track:"drums",noteName:"HiHat"},{id:"d5",start:2,duration:.1,pitch:36,velocity:127,track:"drums",noteName:"Kick"},{id:"d6",start:2.5,duration:.1,pitch:42,velocity:85,track:"drums",noteName:"HiHat"},{id:"d7",start:3,duration:.1,pitch:38,velocity:110,track:"drums",noteName:"Snare"},{id:"d8",start:3.5,duration:.1,pitch:42,velocity:75,track:"drums",noteName:"HiHat"}]}],tempoChanges:[{tick:0,bpm:120,microsecondsPerQuarter:5e5}]}},td=e=>({file:{name:e.file.name,size:e.file.size,duration:e.file.duration,ticksPerQuarter:e.file.ticksPerQuarter,timeSignature:e.file.timeSignature,keySignature:e.file.keySignature},tracks:e.tracks.map(e=>({id:String(e.id),name:e.name,instrument:e.instrument,channel:e.channel,color:e.color,visible:!0,notes:e.notes.map(t=>({id:t.id,start:t.startTime,duration:t.duration,pitch:t.note,velocity:t.velocity,track:String(e.id),noteName:t.name}))})),tempoChanges:e.tempoChanges});function tu(){var e,t,a;let m=(0,o.useRouter)(),h=(0,o.useSearchParams)(),[f,p]=(0,r.useState)(!1);(0,r.useEffect)(()=>{p(!0)},[]);let[y,g]=(0,r.useState)(null),[x,v]=(0,r.useState)(!1),[b,w]=(0,r.useState)(null),[k,S]=(0,r.useState)(!1),[C,D]=(0,r.useState)(el.gA),[j,M]=(0,r.useState)(0),[N,T]=(0,r.useState)(!1),[I,P]=(0,r.useState)(60);(0,r.useRef)(null);let[z,L]=(0,r.useState)(!1),[O,W]=(0,r.useState)({id:"default",name:"Default",description:"Default visualization preset",category:"custom",tags:["default"],mappings:{},defaultSettings:{masterIntensity:1,transitionSpeed:1,backgroundAlpha:.1,particleCount:100,qualityLevel:"medium"},createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),isDefault:!0,usageCount:0}),[_,q]=(0,r.useState)([]),[V,H]=(0,r.useState)([]),[G,Z]=(0,r.useState)(null),[Y,X]=(0,r.useState)(!1),[Q,K]=(0,r.useState)({}),[$,ee]=(0,r.useState)("mobile"),[ea,ei]=(0,r.useState)({metaballs:!1,midiHud:!1,particleNetwork:!1}),[er,es]=(0,r.useState)({}),[en,ec]=(0,r.useState)({}),[ed,eu]=(0,r.useState)(null),[em,eh]=(0,r.useState)({}),[ef,ey]=(0,r.useState)({}),[eg,ex]=(0,r.useState)(0),[eS,eC]=(0,r.useState)({audioLatency:0,visualLatency:0,syncDrift:0,frameTime:0,lastUpdate:0}),[eD]=(0,r.useState)(tc()),ej=ew(),eM=ek(),eN=function(){let[e,t]=(0,r.useState)([]),[a,i]=(0,r.useState)(!1),[s,n]=(0,r.useState)(null),[o,l]=(0,r.useState)({}),[c,d]=(0,r.useState)({transientThreshold:.3,onsetThreshold:.2,chromaSmoothing:.8,rmsWindowSize:1024,pitchConfidence:.7,minNoteDuration:.1}),u=(0,r.useRef)(null),m=ek();(0,r.useEffect)(()=>(u.current||(u.current=new Worker("/workers/audio-analysis-worker.js"),u.current.onmessage=e=>{let{type:a,data:i}=e.data;if("ANALYSIS_PROGRESS"===a)l(e=>({...e,[i.fileId]:{progress:i.progress,message:i.message}}));else if("ANALYSIS_COMPLETE"===a){let{fileId:e,result:a}=i,r=h(a,c);t(t=>t.find(t=>t.fileMetadataId===e)?t.map(t=>t.fileMetadataId===e?{...t,analysisData:r}:t):[...t,{id:a.id,fileMetadataId:e,stemType:a.stemType,analysisData:r,waveformData:a.waveformData,metadata:{...a.metadata,analysisMethod:"enhanced"}}]),l(t=>({...t,[e]:null}))}else if("ANALYSIS_ERROR"===a){let{fileId:e,error:t}=i;n("Analysis failed for ".concat(e,": ").concat(t)),l(t=>({...t,[e]:null}))}}),()=>{u.current&&(u.current.terminate(),u.current=null)}),[c]);let h=(0,r.useCallback)((e,t)=>{if(e.transients&&e.chroma&&e.rms)return{original:{features:new Float32Array(0),markers:new Float32Array(0),frequencies:new Float32Array(0),timeData:new Float32Array(0),volume:new Float32Array(0),bass:new Float32Array(0),mid:new Float32Array(0),treble:new Float32Array(0),stereoWindow_left:new Float32Array(0),stereoWindow_right:new Float32Array(0),fft:new Float32Array(0),fftFrequencies:new Float32Array(0)},transients:e.transients||[],chroma:e.chroma||[],rms:e.rms||[],analysisParams:t};{var a,i,r,s,n,o,l,c,d,u,m,h,f,p,y;let g={features:(null===(a=e.analysisData)||void 0===a?void 0:a.features)||new Float32Array(0),markers:(null===(i=e.analysisData)||void 0===i?void 0:i.markers)||new Float32Array(0),frequencies:(null===(r=e.analysisData)||void 0===r?void 0:r.frequencies)||new Float32Array(0),timeData:(null===(s=e.analysisData)||void 0===s?void 0:s.timeData)||new Float32Array(0),volume:(null===(n=e.analysisData)||void 0===n?void 0:n.volume)||new Float32Array(0),bass:(null===(o=e.analysisData)||void 0===o?void 0:o.bass)||new Float32Array(0),mid:(null===(l=e.analysisData)||void 0===l?void 0:l.mid)||new Float32Array(0),treble:(null===(c=e.analysisData)||void 0===c?void 0:c.treble)||new Float32Array(0),stereoWindow_left:(null===(d=e.analysisData)||void 0===d?void 0:d.stereoWindow_left)||new Float32Array(0),stereoWindow_right:(null===(u=e.analysisData)||void 0===u?void 0:u.stereoWindow_right)||new Float32Array(0),fft:(null===(m=e.analysisData)||void 0===m?void 0:m.fft)||new Float32Array(0),fftFrequencies:(null===(h=e.analysisData)||void 0===h?void 0:h.fftFrequencies)||new Float32Array(0)};return{original:g,transients:(null===(f=e.analysisData)||void 0===f?void 0:f.transients)||[],chroma:(null===(p=e.analysisData)||void 0===p?void 0:p.chroma)||[],rms:(null===(y=e.analysisData)||void 0===y?void 0:y.rms)||[],analysisParams:t}}},[]),f=(0,r.useCallback)(async(e,a)=>{if(0!==e.length){i(!0),n(null);try{let e=m.cachedAnalysis.map(e=>({id:e.id,fileMetadataId:e.fileMetadataId,stemType:e.stemType,analysisData:{original:e.analysisData,transients:[],chroma:[],rms:[],analysisParams:c},waveformData:e.waveformData,metadata:{...e.metadata,analysisMethod:"enhanced"}}));t(e),console.log("Enhanced analysis structure created, ready for audio buffer analysis")}catch(e){console.error("Failed to load analysis:",e),n(e instanceof Error?e.message:"Failed to load analysis")}finally{i(!1)}}},[c]),p=(0,r.useCallback)((t,a,i)=>{if(!u.current){console.error("Analysis worker not ready.");return}if(o[t]){console.log("\uD83C\uDFB5 Skipping enhanced analysis - already in progress:",t);return}let r=e.find(e=>e.fileMetadataId===t);if(r&&r.analysisData.transients.length>0&&r.analysisData.chroma.length>0&&r.analysisData.rms.length>0){console.log("\uD83C\uDFB5 Skipping enhanced analysis - already has real data:",t);return}console.log("Starting enhanced analysis for:",t,i),l(e=>({...e,[t]:{progress:0,message:"Queued for enhanced analysis..."}}));let s=a.getChannelData(0),n=new Float32Array(s.length);n.set(s),u.current.postMessage({type:"ANALYZE_BUFFER",data:{fileId:t,channelData:n,sampleRate:a.sampleRate,duration:a.duration,stemType:i,analysisParams:c,enhancedAnalysis:!0}})},[e,o,c]),y=(0,r.useCallback)((t,a,i)=>{let r=e.find(e=>e.fileMetadataId===t);if(!r)return 0;let{analysisData:s}=r;switch(a){case"impact":let n=s.transients.find(e=>.1>Math.abs(e.time-i));return(null==n?void 0:n.intensity)||0;case"pitch-height":let o=s.chroma.find(e=>.1>Math.abs(e.time-i));return(null==o?void 0:o.pitch)||0;case"brightness":let l=s.chroma.find(e=>.1>Math.abs(e.time-i));return(null==l?void 0:l.confidence)||0;case"rms":case"volume":case"loudness":let c=s.rms.find(e=>.1>Math.abs(e.time-i));return(null==c?void 0:c.value)||0;default:if(s.original&&s.original[a]){let e=s.original[a];if(Array.isArray(e)&&e.length>0)return e[Math.round(10*i)]||0}return 0}},[e]);return{cachedAnalysis:e,isLoading:a,error:s,analysisProgress:o,analysisParams:c,loadAnalysis:f,analyzeAudioBuffer:p,updateAnalysisParams:(0,r.useCallback)(e=>{d(t=>({...t,...e}))},[]),getFeatureValue:y}}();(0,r.useEffect)(()=>{if(!N)return;let e=setInterval(()=>{let e=performance.now(),t=ej.currentTime,a=ej.getAudioLatency?1e3*ej.getAudioLatency():0,i=e-eS.lastUpdate;eC({audioLatency:a,visualLatency:i,syncDrift:1e3*Math.abs(t-j),frameTime:i,lastUpdate:e})},100);return()=>clearInterval(e)},[N,ej.currentTime,j,eS.lastUpdate]);let[eA,eF]=(0,r.useState)(!1),[eR,eI]=(0,r.useState)(!1),eE=(0,r.useRef)(!1),[eP,ez]=(0,r.useState)(!1),eL=(0,r.useRef)(eM.cachedAnalysis);(0,r.useEffect)(()=>{eL.current=eM.cachedAnalysis},[eM.cachedAnalysis]);let eO=et.S.file.getDownloadUrl.useMutation(),{data:eW,isLoading:eU,error:e_}=et.S.project.get.useQuery({id:b},{enabled:!!b}),{data:eq,isLoading:eV}=et.S.file.getUserFiles.useQuery({limit:20,fileType:"all",projectId:b||void 0},{enabled:!!b}),{data:eH,isLoading:eG,error:eZ}=et.S.midi.getVisualizationData.useQuery({fileId:y},{enabled:!!y&&!x});function eY(e){return[...e].sort((e,t)=>e.is_master&&!t.is_master?1:!e.is_master&&t.is_master?-1:0)}(0,r.useEffect)(()=>{let e=h.get("fileId"),t=h.get("projectId");t&&(w(t),v(!1)),e&&(g(e),v(!1)),t||e||v(!0),h.get("projectId")?eF(!1):eF(!0),S(!0)},[h]),(0,r.useEffect)(()=>{if((null==eq?void 0:eq.files)&&b&&k&&!eM.isLoading){let e=!1;return(async()=>{if(!eE.current){eE.current=!0;try{let t=eq.files.filter(e=>"audio"===e.file_type&&"completed"===e.upload_status);if(t.length>0){console.log("Found audio files, preparing to load:",t.map(e=>e.file_name)),console.log("Master stem info:",t.map(e=>({name:e.file_name,is_master:e.is_master}))),console.log("Audio file structure sample:",t[0]);let a=eY(t.map(e=>({...e,stemType:e.stem_type||tb(e.file_name)}))),i=await Promise.all(a.map(async e=>{if(!e.id)throw console.error("File missing ID:",e),Error("File missing ID: ".concat(e.file_name));console.log("Getting download URL for file:",{id:e.id,name:e.file_name});let t=await eO.mutateAsync({fileId:e.id});return{id:e.id,url:t.downloadUrl,label:e.file_name,isMaster:e.is_master||!1,stemType:e.stemType}}));if(!e){let e=i.filter(e=>!e.isMaster),t=i.filter(e=>e.isMaster);await ej.loadStems(e,(t,a)=>{let i=e.find(e=>e.id===t),r=eL.current,s=r.some(e=>e.fileMetadataId===t);console.log("\uD83C\uDFB5 Stem loaded callback:",{stemId:t,stemType:null==i?void 0:i.stemType,hasAnalysis:s,cachedAnalysisCount:r.length,cachedAnalysisIds:r.map(e=>e.fileMetadataId)}),i&&!s?(console.log("\uD83C\uDFB5 Triggering analysis for stem:",t,i.stemType),eM.analyzeAudioBuffer(t,a,i.stemType),eN.analyzeAudioBuffer(t,a,i.stemType)):console.log("\uD83C\uDFB5 Skipping analysis for stem:",t,"reason:",i?"analysis already exists":"no stem found")}),t.length>0&&await ej.loadStems(t,(e,a)=>{let i=t.find(t=>t.id===e),r=eL.current,s=r.some(t=>t.fileMetadataId===e);console.log("\uD83C\uDFB5 Master stem loaded callback:",{stemId:e,stemType:null==i?void 0:i.stemType,hasAnalysis:s,cachedAnalysisCount:r.length,cachedAnalysisIds:r.map(e=>e.fileMetadataId)}),i&&!s?(console.log("\uD83C\uDFB5 Triggering analysis for master stem:",e,i.stemType),eM.analyzeAudioBuffer(e,a,i.stemType),eN.analyzeAudioBuffer(e,a,i.stemType)):console.log("\uD83C\uDFB5 Skipping analysis for master stem:",e,"reason:",i?"analysis already exists":"no stem found")})}}else console.log("No completed audio files found in project.")}catch(t){e||console.error("Failed to load stems:",t)}finally{e||(eE.current=!1)}}})(),()=>{e=!0,eE.current=!1}}},[null==eq?void 0:eq.files,b,k,eM.isLoading]);let eX=(null==eq?void 0:null===(e=eq.files)||void 0===e?void 0:e.filter(e=>"audio"===e.file_type&&"completed"===e.upload_status))||[];(0,r.useEffect)(()=>{if(eX.length>0){let e=eX.map(e=>e.id);eM.loadAnalysis(e),eN.loadAnalysis(e)}},[eX.length]);let eQ=x?eD:(null==eH?void 0:eH.midiData)?td(eH.midiData):void 0;x?el.gA:(null==eH?void 0:eH.settings)||el.gA;let eK=(0,r.useCallback)(e=>{if(v(e),M(0),T(!1),e){let e=new URLSearchParams(h);e.delete("fileId");let t=e.toString()?"/creative-visualizer?".concat(e.toString()):"/creative-visualizer";m.push(t,{scroll:!1})}},[h,m]),eJ=async()=>{if(N)ej.pause(),T(!1);else if(e5)try{await ej.play(),T(!0)}catch(e){console.error("Failed to start audio playback:",e),T(!1)}else T(!0)},e$=e=>{w(e),eF(!1);let t=new URLSearchParams(h);t.set("projectId",e),m.push("/creative-visualizer?".concat(t.toString()))},e0=()=>{eF(!1),eI(!0)},e2=()=>{eI(!1)},e5=eX.length>0&&ej.stemsLoaded,e3=eX.length>0&&!ej.stemsLoaded,e4=[{id:"metaballs",name:"Metaballs Effect",description:"Organic, fluid-like visualizations that respond to audio intensity",category:"Generative",rarity:"Rare",parameters:{}},{id:"midiHud",name:"HUD Effect",description:"Technical overlay displaying real-time audio analysis and MIDI data",category:"Overlays",rarity:"Common",parameters:{}},{id:"particleNetwork",name:"Particle Effect",description:"Dynamic particle systems that react to rhythm and pitch",category:"Generative",rarity:"Mythic",parameters:{}},{id:"waveform",name:"Waveform Overlay",description:"Real-time audio waveform visualization",category:"Overlays",rarity:"Common",parameters:{}},{id:"spectrogram",name:"Spectrogram Overlay",description:"Frequency vs time visualization with color mapping",category:"Overlays",rarity:"Rare",parameters:{}},{id:"peakMeter",name:"Peak/LUFS Meter",description:"Professional audio level metering with peak and LUFS measurements",category:"Overlays",rarity:"Common",parameters:{}},{id:"stereometer",name:"Stereometer Overlay",description:"Stereo field visualization and correlation meter",category:"Overlays",rarity:"Rare",parameters:{}},{id:"oscilloscope",name:"Oscilloscope Overlay",description:"Real-time waveform oscilloscope with pitch tracking",category:"Overlays",rarity:"Mythic",parameters:{}},{id:"spectrumAnalyzer",name:"Spectrum Analyzer",description:"FFT-based frequency spectrum visualization",category:"Overlays",rarity:"Rare",parameters:{}},{id:"midiMeter",name:"MIDI Activity Meter",description:"Real-time MIDI note and velocity visualization",category:"Overlays",rarity:"Common",parameters:{}},{id:"vuMeter",name:"VU Meter",description:"Classic VU meter with needle and bar styles",category:"Overlays",rarity:"Common",parameters:{}},{id:"chromaWheel",name:"Chroma Wheel",description:"12-note chroma wheel for pitch class visualization",category:"Overlays",rarity:"Rare",parameters:{}},{id:"consoleFeed",name:"Data Feed",description:"Live data feed for MIDI, LUFS, FFT, and more",category:"Overlays",rarity:"Common",parameters:{}}],e8=e=>{ei(t=>({...t,[e]:!1}))},e6=e=>{H(t=>[...t,e])},te=(e,t)=>{console.log("handleLayerUpdate",e,t),H(a=>a.map(a=>a.id===e?{...a,...t}:a))},tt=e=>{H(t=>t.filter(t=>t.id!==e)),G===e&&Z(null)},ta=e=>{Z(e)},ti=(e,t)=>{console.log("\uD83C\uDF9B️ Creating mapping:",{parameterId:e,featureId:t,parameterName:e.split("-")[1],effectId:e.split("-")[0]}),es(a=>({...a,[e]:{featureId:t,modulationAmount:.5}}));let a=t.split("-").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" ");ec(e=>({...e,[t]:a})),console.log("\uD83C\uDF9B️ Mapping created successfully")},tr=e=>{console.log("\uD83C\uDF9B️ Removing mapping:",{parameterId:e,currentMapping:er[e]}),es(t=>({...t,[e]:{featureId:null,modulationAmount:.5}})),console.log("\uD83C\uDF9B️ Mapping removed successfully")},ts=(e,t)=>{es(a=>({...a,[e]:{...a[e],modulationAmount:t}}))},[tn,tu]=(0,r.useState)({}),tm=(0,r.useRef)(null),th=(0,r.useRef)(),tf=(e,t,a)=>{var i,r,s,n;let o=e.split("-");if(o.length<2)return null;let[,...l]=o;switch(l.join("-")){case"impact":case"transient":{let e=null===(i=a.transients)||void 0===i?void 0:i.find(e=>.1>Math.abs(e.time-t));return(null==e?void 0:e.intensity)||0}case"rms":case"volume":case"loudness":{let e=null===(r=a.rms)||void 0===r?void 0:r.find(e=>.1>Math.abs(e.time-t));return(null==e?void 0:e.value)||0}case"pitch":case"pitch-height":{let e=null===(s=a.chroma)||void 0===s?void 0:s.find(e=>.1>Math.abs(e.time-t));return(null==e?void 0:e.pitch)||0}case"brightness":case"confidence":{let e=null===(n=a.chroma)||void 0===n?void 0:n.find(e=>.1>Math.abs(e.time-t));return(null==e?void 0:e.confidence)||0}default:return 0}},tp=e=>{let t=e.split("-");return t.length>=2?t[0]:null};(0,r.useEffect)(()=>{if(tm.current){var e,t,a;console.log("\uD83C\uDF9B️ Visualizer ref available:",{hasRef:!!tm.current,availableEffects:(null===(a=tm.current)||void 0===a?void 0:null===(t=a.getAllEffects)||void 0===t?void 0:null===(e=t.call(a))||void 0===e?void 0:e.map(e=>e.id))||[],selectedEffects:Object.keys(Q).filter(e=>Q[e])})}else console.log("\uD83C\uDF9B️ Visualizer ref not available yet")},[tm.current,Q]),(0,r.useEffect)(()=>{let e=[],t=0,a=0,i=()=>{var r,s,n,o,l,c,d,u,m;if(!N||!tm.current){th.current=requestAnimationFrame(i);return}let h=performance.now();if(h-t<1e3/30){th.current=requestAnimationFrame(i);return}t=h,a++,M(ej.currentTime);let f=(null===(r=ej.getAudioContextTime)||void 0===r?void 0:r.call(ej))||0,p=Math.max(0,Math.max(0,f-((null===(s=ej.scheduledStartTimeRef)||void 0===s?void 0:s.current)||0))-((null===(n=ej.getAudioLatency)||void 0===n?void 0:n.call(ej))||0)+eg/1e3);if(eN.cachedAnalysis.length>0){let e=(null===(l=eN.cachedAnalysis[0])||void 0===l?void 0:null===(o=l.metadata)||void 0===o?void 0:o.duration)||1;e>0&&(p%=e)}if(e.length!==Object.keys(er).length&&(e=Object.entries(er).filter(e=>{let[,t]=e;return null!==t.featureId}).map(e=>{let[t,a]=e;return[t,a.featureId]})),eN.cachedAnalysis.length>0)for(let[t,i]of e){if(!i)continue;let e=tp(i);if(!e)continue;let r=eN.cachedAnalysis.find(t=>t.stemType===e);if(!(null==r?void 0:r.analysisData))continue;let s=tf(i,p,r.analysisData);if(null===s)continue;let[n,...o]=t.split("-"),l=o.join("-");if(!n||!l)continue;let h=ty(l),f=Math.max(-.5,Math.min(.5,(null!==(d=null===(c=er[t])||void 0===c?void 0:c.modulationAmount)&&void 0!==d?d:.5)*2-1)),y=null!==(m=em[t])&&void 0!==m?m:null!==(u=tn[t])&&void 0!==u?u:0,g=s*f*h,x=Math.max(0,Math.min(h,y+g));tm.current.updateEffectParameter(n,l,x),a%10==0&&ey(e=>({...e,[t]:x}))}th.current=requestAnimationFrame(i)};return th.current=requestAnimationFrame(i),()=>{th.current&&cancelAnimationFrame(th.current)}},[N,er,eN.cachedAnalysis,ej,eg]);let ty=e=>"base-radius"===e?1:"animation-speed"===e?2:"glow-intensity"===e?3:"hud-opacity"===e?1:"max-particles"===e?200:"connection-distance"===e?5:"particle-size"===e?50:100,tg=e=>"base-radius"===e||"animation-speed"===e||"glow-intensity"===e||"hud-opacity"===e?.1:"max-particles"===e?10:"connection-distance"===e?.1:"particle-size"===e?5:1,tx=(e,t,a)=>{let i="".concat(e,"-").concat(t);eh(e=>({...e,[i]:a})),tu(e=>({...e,[i]:a}))},tv=Object.entries(ea).map((e,t)=>{let[a,r]=e;if(!r)return null;let s=e4.find(e=>e.id===a);if(!s)return null;let n=Object.entries(s.parameters||{}).sort((e,t)=>{let[,a]=e,[,i]=t;return"boolean"==typeof a&&"boolean"!=typeof i?-1:"boolean"!=typeof a&&"boolean"==typeof i?1:0});return 0===n.length?null:(0,i.jsx)(A,{title:s.name.replace(" Effect",""),isOpen:r,onClose:()=>e8(a),initialPosition:{x:100+50*t,y:100+50*t},bounds:"#editor-bounds",children:(0,i.jsxs)("div",{className:"flex flex-col gap-4 max-h-96 overflow-y-auto",children:[n.map(e=>{let[t,r]=e;if("boolean"==typeof r)return(0,i.jsxs)("div",{className:"flex items-center justify-between",children:[(0,i.jsx)(R._,{className:"text-white/80 text-xs font-mono",children:t}),(0,i.jsx)(E,{checked:r,onCheckedChange:e=>tx(a,t,e)})]},t);if("number"==typeof r){var s,n,o,l,c;let e="".concat(a,"-").concat(t),d=er[e],u=(null==d?void 0:d.featureId)||null,m=u?en[u]:void 0,h=null!==(s=null==d?void 0:d.modulationAmount)&&void 0!==s?s:.5,f=null!==(n=tn[e])&&void 0!==n?n:r;return(0,i.jsx)(B,{parameterId:e,label:t,mappedFeatureId:u,mappedFeatureName:m,modulationAmount:h,baseValue:null!==(o=em[e])&&void 0!==o?o:f,modulatedValue:null!==(l=ef[e])&&void 0!==l?l:f,sliderMax:ty(t),onFeatureDrop:ti,onFeatureUnmap:tr,onModulationAmountChange:ts,className:"mb-2",dropZoneStyle:"inlayed",showTagOnHover:!0,children:(0,i.jsx)(F.i,{value:[null!==(c=tn[e])&&void 0!==c?c:r],onValueChange:i=>{let[r]=i;tu(t=>({...t,[e]:r})),tx(a,t,r)},min:0,max:ty(t),step:tg(t),className:"w-full",disabled:!!u})},e)}if(("highlightColor"===t||"particleColor"===t)&&Array.isArray(r)){let e="highlightColor"===t?"Highlight Color":"Particle Color";return(0,i.jsxs)("div",{className:"space-y-2",children:[(0,i.jsxs)(R._,{className:"text-white/90 text-sm font-medium flex items-center justify-between",children:[e,(0,i.jsx)("span",{className:"ml-2 w-6 h-6 rounded-full border border-white/40 inline-block",style:{background:"rgb(".concat(r.map(e=>Math.round(255*e)).join(","),")")}})]}),(0,i.jsx)("input",{type:"color",value:"#".concat(r.map(e=>Math.round(255*e).toString(16).padStart(2,"0")).join("")),onChange:e=>{let i=e.target.value;tx(a,t,[parseInt(i.slice(1,3),16)/255,parseInt(i.slice(3,5),16)/255,parseInt(i.slice(5,7),16)/255])},className:"w-12 h-8 rounded border border-white/30 bg-transparent cursor-pointer"})]},t)}return null}),(0,i.jsx)("div",{className:"pt-2 mt-2",children:(0,i.jsxs)("div",{className:"flex items-center justify-between",children:[(0,i.jsx)(R._,{className:"text-white/80 text-xs font-mono",children:"Effect Enabled"}),(0,i.jsx)(E,{checked:Q[a],onCheckedChange:e=>{K(t=>({...t,[a]:e}))}})]})})]})},a)}),tb=e=>{let t=e.toLowerCase();return t.includes("bass")?"bass":t.includes("drum")?"drums":t.includes("vocal")?"vocals":"other"},tw=eX.find(e=>e.id===ed),tk=tw?tw.stem_type||tb(tw.file_name):void 0,tS=()=>e5&&ej.duration&&ej.duration>0?ej.duration:(eQ||eD).file.duration;(0,r.useEffect)(()=>{let e;if(!N)return;let t=()=>{if(e5){let e=tS(),t=ej.currentTime;ej.isLooping&&e>0&&(t=ej.currentTime%e),M(t)}e=requestAnimationFrame(t)};return e=requestAnimationFrame(t),()=>cancelAnimationFrame(e)},[N,e5,ej]);let tC=eY(eX);(0,r.useEffect)(()=>{console.log("[CreativeVisualizerPage] projectFiles.files:",null==eq?void 0:eq.files)},[null==eq?void 0:eq.files]);let[tD,tj]=(0,r.useState)({});(0,r.useEffect)(()=>{!async function(){if(!(null==eq?void 0:eq.files))return;let e=eq.files.filter(e=>"audio"===e.file_type&&"completed"===e.upload_status);console.log("fetchUrls - projectFiles.files:",eq.files),console.log("fetchUrls - audioFiles:",e);let t=Object.fromEntries((await Promise.all(e.map(async e=>{let t=e.downloadUrl;if(!t&&eO)try{if(!e.id)return console.error("fetchUrls - File missing ID:",e),[e.id,null];console.log("fetchUrls - Getting download URL for file:",{id:e.id,name:e.file_name}),t=(await eO.mutateAsync({fileId:e.id})).downloadUrl}catch(t){console.error("[CreativeVisualizerPage] Failed to fetch downloadUrl for",e.id,t)}return[e.id,t]}))).filter(e=>{let[t,a]=e;return!!a}));tj(t),Object.keys(t).length>0?console.log("[CreativeVisualizerPage] asyncStemUrlMap populated:",t):console.log("[CreativeVisualizerPage] asyncStemUrlMap is empty")}()},[null==eq?void 0:eq.files]);let tM=Object.keys(tD).length>0;return f?b||x?(0,i.jsxs)(e1,{cachedAnalysis:eM.cachedAnalysis,stemAudio:ej,stemUrlMap:tD,children:[eA&&(0,i.jsx)(ev,{isOpen:eA,onClose:()=>m.push("/dashboard"),onSelect:e$,onCreateNew:e0}),eR&&(0,i.jsx)(eb.p,{isOpen:eR,onClose:e2}),(0,i.jsx)(s.W,{backend:n.PD,children:(0,i.jsxs)("div",{className:"flex h-screen bg-stone-800 text-white min-w-0 creative-visualizer-text",children:[(0,i.jsx)(ep,{children:(0,i.jsxs)("div",{className:"space-y-4",children:[(0,i.jsx)(eT,{activeTrackId:ed||void 0,className:"mb-4",selectedStemType:tk,currentTime:j,cachedAnalysis:eN.cachedAnalysis,isPlaying:N}),(0,i.jsx)(eo,{onFileSelected:e=>{g(e),v(!1),M(0),T(!1);let t=new URLSearchParams(h);t.set("fileId",e),m.push("/creative-visualizer?".concat(t.toString()),{scroll:!1})},selectedFileId:y||void 0,useDemoData:x,onDemoModeChange:eK,projectId:b||void 0,projectName:null==eW?void 0:eW.name})]})}),(0,i.jsxs)("main",{className:"flex-1 flex overflow-hidden min-w-0",children:[(0,i.jsxs)("div",{id:"editor-bounds",className:"relative flex-1 flex flex-col overflow-hidden min-w-0",style:{height:"100vh",position:"relative",contain:"layout"},children:[(0,i.jsx)("div",{className:"p-2 bg-stone-900/50 border-b border-white/10",children:(0,i.jsxs)("div",{className:"flex items-center justify-between min-w-0",children:[(0,i.jsxs)("div",{className:"flex items-center gap-2 min-w-0 overflow-hidden",children:[(0,i.jsx)(l.z,{onClick:eJ,size:"sm",disabled:e3,className:"font-mono text-xs uppercase tracking-wider px-4 py-2 transition-all duration-300 ".concat(e3?"bg-stone-600 text-stone-400 cursor-not-allowed":"bg-stone-700 hover:bg-stone-600"),children:e3?(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)("div",{className:"h-3 w-3 mr-1 animate-spin rounded-full border-2 border-stone-400 border-t-transparent"}),"LOADING"]}):(0,i.jsxs)(i.Fragment,{children:[N?(0,i.jsx)(c.Z,{className:"h-3 w-3 mr-1"}):(0,i.jsx)(d.Z,{className:"h-3 w-3 mr-1"}),N?"PAUSE":"PLAY"]})}),(0,i.jsxs)(l.z,{variant:"outline",size:"sm",disabled:e3,onClick:()=>ej.setLooping(!ej.isLooping),className:"bg-stone-800 border-stone-600 text-stone-300 hover:bg-stone-700 hover:border-stone-500 font-mono text-xs uppercase tracking-wider px-3 py-1 ".concat(e3?"opacity-50 cursor-not-allowed":ej.isLooping?"bg-emerald-900/20 border-emerald-600 text-emerald-300":""),style:{borderRadius:"6px"},children:["\uD83D\uDD04 ",(ej.isLooping,"LOOP")]}),(0,i.jsxs)(l.z,{variant:"outline",disabled:e3,onClick:()=>{ej.stop(),T(!1),M(0)},className:"bg-stone-800 border-stone-600 text-stone-300 hover:bg-stone-700 hover:border-stone-500 px-3 py-1 ".concat(e3?"opacity-50 cursor-not-allowed":""),children:[(0,i.jsx)(u.Z,{className:"h-3 w-3 mr-1"}),"RESET"]}),(0,i.jsxs)("div",{className:"flex items-center gap-1 overflow-hidden",children:[(0,i.jsxs)("div",{className:"text-xs font-mono uppercase tracking-wider px-2 py-1 rounded text-stone-300",style:{background:"rgba(30, 30, 30, 0.5)",backdropFilter:"blur(5px)",WebkitBackdropFilter:"blur(5px)",border:"1px solid rgba(255, 255, 255, 0.1)"},children:[(0,i.jsx)("span",{className:"font-creative-mono",children:j.toFixed(1)}),(0,i.jsx)("span",{className:"font-creative-mono",children:"S"})," / ",(0,i.jsx)("span",{className:"font-creative-mono",children:tS().toFixed(1)}),(0,i.jsx)("span",{className:"font-creative-mono",children:"S"})]}),(0,i.jsxs)("div",{className:"text-xs font-mono uppercase tracking-wider px-2 py-1 rounded text-stone-300",style:{background:"rgba(30, 30, 30, 0.5)",backdropFilter:"blur(5px)",WebkitBackdropFilter:"blur(5px)",border:"1px solid rgba(255, 255, 255, 0.1)"},children:["FPS: ",(0,i.jsx)("span",{className:"font-creative-mono",children:I})]}),(0,i.jsxs)("div",{className:"text-xs font-mono uppercase tracking-wider px-2 py-1 rounded text-stone-300",style:{background:"rgba(30, 30, 30, 0.5)",backdropFilter:"blur(5px)",WebkitBackdropFilter:"blur(5px)",border:"1px solid rgba(255, 255, 255, 0.1)"},children:["NOTES: ",(0,i.jsx)("span",{className:"font-creative-mono",children:(eQ||eD).tracks.reduce((e,t)=>e+t.notes.length,0)})]}),e5&&(0,i.jsxs)("div",{className:"text-xs font-mono uppercase tracking-wider px-2 py-1 rounded text-stone-300",style:{background:"rgba(30, 30, 30, 0.5)",backdropFilter:"blur(5px)",WebkitBackdropFilter:"blur(5px)",border:"1px solid rgba(255, 255, 255, 0.1)"},children:["STEMS: ",(0,i.jsx)("span",{className:"font-creative-mono",children:eX.length})]})]})]}),(0,i.jsxs)("div",{className:"flex items-center gap-2 flex-shrink-0 ml-2",children:[(0,i.jsx)(to,{currentAspectRatio:$,onAspectRatioChange:ee,disabled:e3}),(0,i.jsxs)(l.z,{variant:"outline",size:"sm",onClick:()=>X(!Y),className:"bg-stone-800 border-stone-600 text-stone-300 hover:bg-stone-700 hover:border-stone-500 font-mono text-xs uppercase tracking-wider px-2 py-1 ".concat(Y?"bg-emerald-900/20 border-emerald-600 text-emerald-300":""),style:{borderRadius:"6px"},children:["\uD83C\uDFAC ",Y?"COMP":"VIDEO"]}),Y&&(0,i.jsx)(e9,{onAddLayer:e6,className:"ml-2"})]})]})}),(0,i.jsx)("div",{className:"flex-1 flex flex-col overflow-hidden bg-stone-900 relative",children:(0,i.jsxs)("div",{className:"flex-1 flex flex-col min-h-0 px-4 overflow-y-auto",children:[(0,i.jsx)("div",{className:"flex-shrink-0 mb-4",children:(0,i.jsxs)("div",{className:"relative mx-auto bg-stone-900 rounded-lg overflow-hidden shadow-lg flex items-center justify-center",style:{height:"min(calc(100vh - 400px), 60vh)",minHeight:"200px",width:"100%",maxWidth:"100%"},children:[(0,i.jsx)(U,{midiData:eQ||eD,settings:C,currentTime:j,isPlaying:N,layers:V,selectedLayerId:G,onLayerSelect:ta,onPlayPause:eJ,onSettingsChange:D,onFpsUpdate:P,selectedEffects:Q,aspectRatio:$,openEffectModals:ea,onCloseEffectModal:e8,mappings:er,featureNames:en,onMapFeature:ti,onUnmapFeature:tr,onModulationAmountChange:ts,activeSliderValues:tn,setActiveSliderValues:tu,onSelectedEffectsChange:()=>{},visualizerRef:tm}),Y&&(0,i.jsx)(eB,{layers:V,width:"mobile"===$?400:1280,height:"mobile"===$?711:720,currentTime:j,isPlaying:N,audioFeatures:{frequencies:Array(256).fill(.5),timeData:Array(256).fill(.5),volume:.5,bass:.5,mid:.5,treble:.5},midiData:{activeNotes:[],currentTime:j,tempo:120,totalNotes:0,trackActivity:{}},onLayerUpdate:te,onLayerDelete:tt}),(0,i.jsx)("div",{id:"hud-overlays",style:{position:"absolute",top:0,left:0,width:"100%",height:"100%",pointerEvents:"none",zIndex:20}})]})}),(0,i.jsx)("div",{className:"flex-shrink-0 mb-4",children:(0,i.jsx)(e7,{layers:V,currentTime:j,duration:(eQ||eD).file.duration,onLayerAdd:e6,onLayerUpdate:te,onLayerDelete:tt,onLayerSelect:ta,selectedLayerId:G||void 0,effectClips:_,onEffectClipAdd:e=>{let t={id:"".concat(e.id,"-").concat(Date.now()),effectId:e.id,name:e.name,startTime:ej.currentTime,endTime:ej.currentTime+10,parameters:e.parameters||{}};q(e=>[...e,t]),K(t=>({...t,[e.id]:!0})),console.log("Effect added to timeline:",t)},onEffectClipRemove:e=>{q(t=>t.filter(t=>t.id!==e))},onEffectClipEdit:e=>{let t=_.find(t=>t.id===e);t&&ei(e=>({...e,[t.effectId]:!0}))},stems:tC,masterStemId:null!==(a=null==eq?void 0:null===(t=eq.files.find(e=>e.is_master))||void 0===t?void 0:t.id)&&void 0!==a?a:null,onStemSelect:e=>{console.log("\uD83C\uDF9B️ Selecting stem:",{stemId:e,previousActiveTrack:ed,availableAnalyses:eM.cachedAnalysis.map(e=>({id:e.fileMetadataId,stemType:e.stemType,hasData:!!e.analysisData,features:e.analysisData?Object.keys(e.analysisData):[]}))}),eu(e);let t=eM.cachedAnalysis.find(t=>t.fileMetadataId===e);t?console.log("\uD83C\uDF9B️ Selected stem analysis:",{stemId:e,stemType:t.stemType,duration:t.metadata.duration,features:t.analysisData?Object.keys(t.analysisData):[],sampleValues:t.analysisData?Object.entries(t.analysisData).reduce((e,t)=>{let[a,i]=t;return Array.isArray(i)&&i.length>0&&(e[a]={length:i.length,firstValue:i[0],lastValue:i[i.length-1],sampleValues:i.slice(0,5)}),e},{}):{}}):console.warn("\uD83C\uDF9B️ No analysis found for selected stem:",e)},activeTrackId:ed,soloedStems:ej.soloedStems,onToggleSolo:ej.toggleStemSolo,analysisProgress:eN.analysisProgress,cachedAnalysis:eN.cachedAnalysis,stemLoadingState:eN.isLoading,stemError:eN.error,isPlaying:N,onSeek:M,className:"bg-stone-800 border border-gray-700"})})]})}),tv]}),(0,i.jsx)(J,{children:(0,i.jsx)(tl,{effects:e4,selectedEffects:Q,onEffectToggle:e=>{K(t=>({...t,[e]:!t[e]})),ei(t=>({...t,[e]:!0}))},onEffectDoubleClick:e=>{ei(t=>({...t,[e]:!0}))},isVisible:!0,stemUrlsReady:tM})})]})]})})]}):(0,i.jsxs)(i.Fragment,{children:[eA&&(0,i.jsx)(ev,{isOpen:eA,onClose:()=>m.push("/dashboard"),onSelect:e$,onCreateNew:e0}),eR&&(0,i.jsx)(eb.p,{isOpen:eR,onClose:e2}),(0,i.jsx)("div",{className:"flex h-screen bg-stone-800 text-white items-center justify-center",children:(0,i.jsxs)("div",{className:"text-center",children:[(0,i.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-white mx-auto mb-4"}),(0,i.jsx)("div",{className:"text-sm text-stone-300",children:"Please create or select a project."})]})})]}):(0,i.jsx)("div",{className:"flex h-screen bg-stone-800 text-white items-center justify-center",children:(0,i.jsxs)("div",{className:"text-center",children:[(0,i.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-white mx-auto mb-4"}),(0,i.jsx)("div",{className:"text-sm text-stone-300",children:"Loading..."})]})})}function tm(){return(0,i.jsx)(r.Suspense,{children:(0,i.jsx)(tu,{})})}},1822:function(e,t,a){"use strict";a.d(t,{z:function(){return c}});var i=a(1279),r=a(12),s=a(7690),n=a(5544),o=a(8092);let l=(0,n.j)("inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",{variants:{variant:{default:"bg-primary text-primary-foreground shadow hover:bg-primary/90",destructive:"bg-destructive text-destructive-foreground shadow-sm hover:bg-destructive/90",outline:"border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground",secondary:"bg-secondary text-secondary-foreground shadow-sm hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground",link:"text-primary underline-offset-4 hover:underline"},size:{default:"h-9 px-4 py-2",sm:"h-8 rounded-md px-3 text-xs",lg:"h-10 rounded-md px-8",icon:"h-9 w-9"}},defaultVariants:{variant:"default",size:"default"}}),c=r.forwardRef((e,t)=>{let{className:a,variant:r,size:n,asChild:c=!1,...d}=e,u=c?s.g7:"button";return(0,i.jsx)(u,{className:(0,o.cn)(l({variant:r,size:n,className:a})),ref:t,...d})});c.displayName="Button"},5935:function(e,t,a){"use strict";a.d(t,{Ol:function(){return o},SZ:function(){return c},Zb:function(){return n},aY:function(){return d},eW:function(){return u},ll:function(){return l}});var i=a(1279),r=a(12),s=a(8092);let n=r.forwardRef((e,t)=>{let{className:a,...r}=e;return(0,i.jsx)("div",{ref:t,className:(0,s.cn)("rounded-xl border bg-card text-card-foreground shadow",a),...r})});n.displayName="Card";let o=r.forwardRef((e,t)=>{let{className:a,...r}=e;return(0,i.jsx)("div",{ref:t,className:(0,s.cn)("flex flex-col space-y-1.5 p-6",a),...r})});o.displayName="CardHeader";let l=r.forwardRef((e,t)=>{let{className:a,...r}=e;return(0,i.jsx)("div",{ref:t,className:(0,s.cn)("font-semibold leading-none tracking-tight",a),...r})});l.displayName="CardTitle";let c=r.forwardRef((e,t)=>{let{className:a,...r}=e;return(0,i.jsx)("div",{ref:t,className:(0,s.cn)("text-sm text-muted-foreground",a),...r})});c.displayName="CardDescription";let d=r.forwardRef((e,t)=>{let{className:a,...r}=e;return(0,i.jsx)("div",{ref:t,className:(0,s.cn)("p-6 pt-0",a),...r})});d.displayName="CardContent";let u=r.forwardRef((e,t)=>{let{className:a,...r}=e;return(0,i.jsx)("div",{ref:t,className:(0,s.cn)("flex items-center p-6 pt-0",a),...r})});u.displayName="CardFooter"},7333:function(e,t,a){"use strict";a.d(t,{$F:function(){return u},AW:function(){return m},Ju:function(){return f},VD:function(){return p},Xi:function(){return h},h_:function(){return d}});var i=a(1279),r=a(12),s=a(2362),n=a(5787),o=a(7982),l=a(3905),c=a(8092);let d=s.fC,u=s.xz;s.ZA,s.Uv,s.Tr,s.Ee,r.forwardRef((e,t)=>{let{className:a,inset:r,children:o,...l}=e;return(0,i.jsxs)(s.fF,{ref:t,className:(0,c.cn)("flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",r&&"pl-8",a),...l,children:[o,(0,i.jsx)(n.Z,{className:"ml-auto"})]})}).displayName=s.fF.displayName,r.forwardRef((e,t)=>{let{className:a,...r}=e;return(0,i.jsx)(s.tu,{ref:t,className:(0,c.cn)("z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]",a),...r})}).displayName=s.tu.displayName;let m=r.forwardRef((e,t)=>{let{className:a,sideOffset:r=4,...n}=e;return(0,i.jsx)(s.Uv,{children:(0,i.jsx)(s.VY,{ref:t,sideOffset:r,className:(0,c.cn)("z-50 max-h-[var(--radix-dropdown-menu-content-available-height)] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md","data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]",a),...n})})});m.displayName=s.VY.displayName;let h=r.forwardRef((e,t)=>{let{className:a,inset:r,...n}=e;return(0,i.jsx)(s.ck,{ref:t,className:(0,c.cn)("relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&>svg]:size-4 [&>svg]:shrink-0",r&&"pl-8",a),...n})});h.displayName=s.ck.displayName,r.forwardRef((e,t)=>{let{className:a,children:r,checked:n,...l}=e;return(0,i.jsxs)(s.oC,{ref:t,className:(0,c.cn)("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",a),checked:n,...l,children:[(0,i.jsx)("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:(0,i.jsx)(s.wU,{children:(0,i.jsx)(o.Z,{className:"h-4 w-4"})})}),r]})}).displayName=s.oC.displayName,r.forwardRef((e,t)=>{let{className:a,children:r,...n}=e;return(0,i.jsxs)(s.Rk,{ref:t,className:(0,c.cn)("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",a),...n,children:[(0,i.jsx)("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:(0,i.jsx)(s.wU,{children:(0,i.jsx)(l.Z,{className:"h-2 w-2 fill-current"})})}),r]})}).displayName=s.Rk.displayName;let f=r.forwardRef((e,t)=>{let{className:a,inset:r,...n}=e;return(0,i.jsx)(s.__,{ref:t,className:(0,c.cn)("px-2 py-1.5 text-sm font-semibold",r&&"pl-8",a),...n})});f.displayName=s.__.displayName;let p=r.forwardRef((e,t)=>{let{className:a,...r}=e;return(0,i.jsx)(s.Z0,{ref:t,className:(0,c.cn)("-mx-1 my-1 h-px bg-muted",a),...r})});p.displayName=s.Z0.displayName},8497:function(e,t,a){"use strict";a.d(t,{i:function(){return o}});var i=a(1279),r=a(12),s=a(4571),n=a(8092);let o=r.forwardRef((e,t)=>{let{className:a,...r}=e;return(0,i.jsxs)(s.fC,{ref:t,className:(0,n.cn)("relative flex w-full touch-none select-none items-center",a),...r,children:[(0,i.jsx)(s.fQ,{className:"relative h-1.5 w-full grow overflow-hidden rounded-full bg-white/20",children:(0,i.jsx)(s.e6,{className:"absolute h-full bg-white/80"})}),(0,i.jsx)(s.bU,{className:"block h-4 w-4 rounded-full border-2 border-white/80 bg-white/50 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-white/60 focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50"})]})});o.displayName=s.fC.displayName},5487:function(e,t,a){"use strict";a.d(t,{pm:function(){return m}});var i=a(12);let r=0,s=new Map,n=e=>{if(s.has(e))return;let t=setTimeout(()=>{s.delete(e),d({type:"REMOVE_TOAST",toastId:e})},1e6);s.set(e,t)},o=(e,t)=>{switch(t.type){case"ADD_TOAST":return{...e,toasts:[t.toast,...e.toasts].slice(0,1)};case"UPDATE_TOAST":return{...e,toasts:e.toasts.map(e=>e.id===t.toast.id?{...e,...t.toast}:e)};case"DISMISS_TOAST":{let{toastId:a}=t;return a?n(a):e.toasts.forEach(e=>{n(e.id)}),{...e,toasts:e.toasts.map(e=>e.id===a||void 0===a?{...e,open:!1}:e)}}case"REMOVE_TOAST":if(void 0===t.toastId)return{...e,toasts:[]};return{...e,toasts:e.toasts.filter(e=>e.id!==t.toastId)}}},l=[],c={toasts:[]};function d(e){c=o(c,e),l.forEach(e=>{e(c)})}function u(e){let{...t}=e,a=(r=(r+1)%Number.MAX_SAFE_INTEGER).toString(),i=()=>d({type:"DISMISS_TOAST",toastId:a});return d({type:"ADD_TOAST",toast:{...t,id:a,open:!0,onOpenChange:e=>{e||i()}}}),{id:a,dismiss:i,update:e=>d({type:"UPDATE_TOAST",toast:{...e,id:a}})}}function m(){let[e,t]=i.useState(c);return i.useEffect(()=>(l.push(t),()=>{let e=l.indexOf(t);e>-1&&l.splice(e,1)}),[e]),{...e,toast:u,dismiss:e=>d({type:"DISMISS_TOAST",toastId:e})}}},8148:function(e,t,a){"use strict";a.d(t,{O:function(){return n}});var i=a(3895);let r="https://ahqgihozxzpyxrgesnxm.supabase.co",s="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFocWdpaG96eHpweXhyZ2VzbnhtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA5MTAyMDIsImV4cCI6MjA2NjQ4NjIwMn0.cT8XhsaPazK72VbeKQF8izhiedgEdmNqwZp2hB5nYfQ";r&&s||console.error("\uD83D\uDD25 SUPABASE NOT CONFIGURED! Auth and database will not work.");let n=(0,i.eI)(r||"https://dummy.supabase.co",s||"dummy-key")},8092:function(e,t,a){"use strict";a.d(t,{cn:function(){return s},q:function(){return n}});var i=a(1057),r=a(8755);function s(){for(var e=arguments.length,t=Array(e),a=0;a<e;a++)t[a]=arguments[a];return(0,r.m6)((0,i.W)(t))}let n={log:function(){for(var e=arguments.length,t=Array(e),a=0;a<e;a++)t[a]=arguments[a]},warn:function(){for(var e=arguments.length,t=Array(e),a=0;a<e;a++)t[a]=arguments[a]},error:function(){for(var e=arguments.length,t=Array(e),a=0;a<e;a++)t[a]=arguments[a];console.error(...t)},info:function(){for(var e=arguments.length,t=Array(e),a=0;a<e;a++)t[a]=arguments[a]}}}},function(e){e.O(0,[439,489,311,336,293,422,69,32,541,132,921,218,915,264,744],function(){return e(e.s=5120)}),_N_E=e.O()}]);