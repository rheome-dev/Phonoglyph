# Story 7.4: Simplified Audio Feature Mapping Interface

**Epic**: 7 - MVP Consolidation & Production Readiness  
**Story**: 7.4  
**Status**: Not Started 🔴  
**Priority**: High  
**Estimated Effort**: 14 hours  
**Dependencies**: Story 5.2 ✅, Story 7.2 🔴, Story 7.3 🔴

## User Story

**As a** user  
**I want** a simplified, MIDI-like interface for mapping audio features to visualization parameters  
**So that** I can easily control visualizations without complex technical knowledge

## Technical Implementation Details

### **Simplified Mapping System**
```typescript
interface SimplifiedMappingConfig {
  mode: 'midi-like' | 'advanced';
  features: {
    transient: boolean; // Note on detection
    chroma: boolean;    // Pitch detection
    volume: boolean;    // Volume/amplitude
    brightness: boolean; // Dynamic CC-like feature
  };
  sensitivity: {
    transient: number; // 0-100
    chroma: number;    // 0-100
    volume: number;    // 0-100
    brightness: number; // 0-100
  };
}

interface AudioFeatureMapping {
  id: string;
  featureType: 'transient' | 'chroma' | 'volume' | 'brightness';
  targetParameter: string; // Visualization parameter to control
  mapping: {
    source: string; // Audio feature source
    transform: 'linear' | 'exponential' | 'logarithmic';
    range: [number, number]; // Min/max values
    sensitivity: number; // 0-100
  };
  enabled: boolean;
}

interface SimplifiedMappingService {
  config: SimplifiedMappingConfig;
  mappings: AudioFeatureMapping[];
  
  createMapping(featureType: string, targetParameter: string): AudioFeatureMapping;
  updateMapping(mappingId: string, updates: Partial<AudioFeatureMapping>): void;
  deleteMapping(mappingId: string): void;
  getMappedValue(featureType: string, audioData: AudioFeatures): number;
  validateMapping(mapping: AudioFeatureMapping): boolean;
}
```

### **Database Schema Extensions**
```sql
-- Create simplified mapping configuration table
CREATE TABLE "simplified_mappings" (
  "id" TEXT NOT NULL PRIMARY KEY,
  "project_id" TEXT NOT NULL REFERENCES "projects"("id") ON DELETE CASCADE,
  "feature_type" TEXT NOT NULL CHECK (feature_type IN ('transient', 'chroma', 'volume', 'brightness')),
  "target_parameter" TEXT NOT NULL,
  "mapping_config" JSONB NOT NULL,
  "enabled" BOOLEAN NOT NULL DEFAULT true,
  "created_at" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
  "updated_at" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- Add index for efficient mapping queries
CREATE INDEX "idx_simplified_mappings_project" ON "simplified_mappings" ("project_id");
CREATE INDEX "idx_simplified_mappings_feature" ON "simplified_mappings" ("feature_type");
```

### **Frontend Interface**
```typescript
interface UseSimplifiedMapping {
  config: SimplifiedMappingConfig;
  mappings: AudioFeatureMapping[];
  createMapping: (featureType: string, targetParameter: string) => void;
  updateMapping: (mappingId: string, updates: Partial<AudioFeatureMapping>) => void;
  deleteMapping: (mappingId: string) => void;
  toggleMapping: (mappingId: string) => void;
  getMappedValue: (featureType: string) => number;
}

interface SimplifiedMappingUI {
  featureType: 'transient' | 'chroma' | 'volume' | 'brightness';
  targetParameter: string;
  sensitivity: number;
  enabled: boolean;
  onUpdate: (updates: Partial<AudioFeatureMapping>) => void;
}

// Hook for simplified mapping
const useSimplifiedMapping = (projectId: string): UseSimplifiedMapping => {
  // Implementation with drag-and-drop and real-time preview
};
```

## Acceptance Criteria

### 🎛️ **MIDI-Like Interface**
- [ ] **AC1**: Interface provides transient detection with envelope (note on)
- [ ] **AC2**: Chroma (pitch) mapping is available and intuitive
- [ ] **AC3**: Volume mapping is clearly presented and functional
- [ ] **AC4**: Brightness (dynamic CC-esque feature) is available
- [ ] **AC5**: Mapping interface is drag-and-drop or similar intuitive interaction

### 🎯 **User Experience**
- [ ] **AC6**: Real-time preview shows mapping effects immediately
- [ ] **AC7**: Sensitivity controls are intuitive and responsive
- [ ] **AC8**: Mapping presets are available for common scenarios
- [ ] **AC9**: Visual feedback shows active mappings clearly
- [ ] **AC10**: Undo/redo functionality for mapping changes

### ⚡ **Performance & Integration**
- [ ] **AC11**: Mapping updates are applied in real-time without lag
- [ ] **AC12**: Interface works with both audio analysis and MIDI data
- [ ] **AC13**: Mappings are saved and restored with projects
- [ ] **AC14**: Interface is responsive on mobile devices
- [ ] **AC15**: Mapping conflicts are resolved automatically

## Technical Dependencies

### External Libraries
- **Drag-and-drop library for intuitive mapping**
- **Real-time audio processing for immediate feedback**
- **Sensitivity curve visualization**

### Internal Dependencies
- **Story 5.2: Audio analysis system for feature extraction**
- **Story 7.2: Audio caching for performance**
- **Story 7.3: MIDI integration for hybrid mode**
- **Existing visualization engine from Epic 2**
- **Project state management system**

## Implementation Tasks

### Backend Tasks
- [ ] **Task 1**: Create simplified_mappings table and migrations
- [ ] **Task 2**: Implement SimplifiedMappingService
- [ ] **Task 3**: Add mapping validation and conflict resolution
- [ ] **Task 4**: Create tRPC endpoints for mapping operations
- [ ] **Task 5**: Implement mapping preset system

### Frontend Tasks
- [ ] **Task 6**: Create useSimplifiedMapping React hook
- [ ] **Task 7**: Build drag-and-drop mapping interface
- [ ] **Task 8**: Implement real-time mapping preview
- [ ] **Task 9**: Create sensitivity control components
- [ ] **Task 10**: Add mapping preset selection UI

### Integration Tasks
- [ ] **Task 11**: Connect mapping with existing visualization engine
- [ ] **Task 12**: Integrate with audio analysis and MIDI systems
- [ ] **Task 13**: Add mapping state to project save/load
- [ ] **Task 14**: Implement mapping conflict resolution
- [ ] **Task 15**: Create comprehensive mapping testing suite

## Integration Verification

### Existing System Compatibility
- **IV1**: Existing audio analysis features are properly exposed
- **IV2**: Visualization engine responds correctly to mapped parameters
- **IV3**: UI maintains consistency with existing design system
- **IV4**: Project save/load system includes mapping data
- **IV5**: Real-time visualization performance is maintained

### Performance Requirements
- **IV6**: Mapping updates apply within 16ms
- **IV7**: Interface remains responsive during audio playback
- **IV8**: Memory usage remains stable with multiple mappings
- **IV9**: Mapping calculations don't impact visualization frame rate
- **IV10**: Mobile interface works smoothly on touch devices

## Success Metrics

### User Experience Metrics
- [ ] **Mapping interface reduces setup time by 70%**
- [ ] **User satisfaction with mapping controls >90%**
- [ ] **Mapping preset usage >60%**
- [ ] **Real-time feedback satisfaction >95%**

### Technical Metrics
- [ ] **Mapping update latency under 16ms**
- [ ] **Interface responsiveness maintained at 60fps**
- [ ] **Mapping accuracy >95%**
- [ ] **Mobile performance score >90**

## Dev Notes

### Previous Story Insights
- **Story 5.2**: Audio analysis provides the feature extraction foundation
- **Story 5.3**: Waveform visualization shows real-time data integration patterns
- **Story 7.3**: MIDI integration provides mapping reference patterns

### Data Models
**Simplified Mappings Table**:
```sql
CREATE TABLE "simplified_mappings" (
  "id" TEXT NOT NULL PRIMARY KEY,
  "project_id" TEXT NOT NULL REFERENCES "projects"("id") ON DELETE CASCADE,
  "feature_type" TEXT NOT NULL CHECK (feature_type IN ('transient', 'chroma', 'volume', 'brightness')),
  "target_parameter" TEXT NOT NULL,
  "mapping_config" JSONB NOT NULL,
  "enabled" BOOLEAN NOT NULL DEFAULT true,
  "created_at" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
  "updated_at" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP
);
```

### File Locations
**Backend Implementation**:
- `apps/api/src/routers/simplified-mapping.ts` - tRPC router for mapping operations
- `apps/api/src/services/simplified-mapping.ts` - SimplifiedMappingService implementation
- `apps/api/src/db/migrations/020_simplified_mappings.sql` - Database migration

**Frontend Implementation**:
- `apps/web/src/hooks/use-simplified-mapping.ts` - React hook for mapping
- `apps/web/src/components/simplified-mapping/` - Mapping UI components
- `apps/web/src/lib/simplified-mapping.ts` - Mapping utilities

### Technical Constraints
- **Must integrate with existing audio analysis system**
- **Must work with both audio and MIDI data sources**
- **Must maintain real-time visualization performance**
- **Must provide intuitive user experience**
- **Must handle mapping conflicts gracefully**

### Testing Requirements
- [ ] **Vitest Unit Tests**: Mapping service and utilities (coverage: 90%)
- [ ] **Vitest Integration Tests**: Mapping with audio analysis and MIDI
- [ ] **E2E Tests**: Mapping interface workflow and real-time feedback
- [ ] **Performance Tests**: Mapping under load with multiple parameters

## Dev Agent Record

### Agent Model Used: {{Agent Model Name/Version}}

### Debug Log References
[[LLM: (Dev Agent) If the debug is logged to during the current story progress, create a table with the debug log and the specific task section in the debug log - do not repeat all the details in the story]]

### Completion Notes List
- **Status**: Not Started
- **Assigned**: TBD
- **Started**: TBD
- **Completed**: TBD
- **Notes**: User experience story - simplifies complex audio feature mapping

### Change Log
[[LLM: (Dev Agent) Track document versions and changes during development that deviate from story dev start]]

| Date | Version | Description | Author |
| :--- | :------ | :---------- | :----- | 