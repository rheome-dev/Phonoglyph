# Story 5.7: Stem Visualization Control Interface

**Epic**: 5 - Stem Separation & Audio Analysis  
**Story**: 5.7  
**Status**: Not Started ðŸ”´  
**Priority**: High  
**Estimated Effort**: 20 hours  
**Dependencies**: Story 5.2 âœ…, Story 5.3 âœ…

## User Story

**As a** music producer or content creator  
**I want to** have an intuitive interface to map stem features to visual parameters  
**So that** I can easily create complex visualizations without understanding the technical details

## Technical Implementation Details

### UI Component Architecture
```typescript
interface StemControlPanel {
  stems: {
    drums: StemControl;
    bass: StemControl;
    vocals: StemControl;
    other: StemControl;
  };
  
  globalControls: {
    masterIntensity: number;
    smoothing: number;
    visualStyle: "particles" | "geometry" | "shader";
  };
}

interface StemControl {
  // Feature mapping controls
  featureMappings: {
    rhythm: {
      target: "scale" | "rotation" | "color" | "emission" | "position";
      intensity: number;
      smoothing: number;
      enabled: boolean;
    };
    pitch: {
      target: "height" | "color" | "size" | "shape";
      intensity: number;
      range: [number, number];
      enabled: boolean;
    };
    timbre: {
      target: "texture" | "complexity" | "distortion";
      intensity: number;
      enabled: boolean;
    };
  };
  
  // Visual presets
  presets: {
    name: string;
    description: string;
    mappings: FeatureMappings;
  }[];
  
  // Real-time preview
  preview: {
    currentFeatures: AudioFeatures;
    visualPreview: THREE.Object3D;
  };
}

interface VisualizationPreset {
  name: string;
  thumbnail: string;
  description: string;
  stemMappings: {
    [key in StemType]: {
      defaultFeatures: FeatureMappings;
      recommendedVisualStyle: string;
    };
  };
}
```

### Component Layout
```tsx
<GlassCard className="stem-control-panel">
  <Tabs defaultValue="drums">
    <TabsList>
      <TabsTrigger value="drums">Drums</TabsTrigger>
      <TabsTrigger value="bass">Bass</TabsTrigger>
      <TabsTrigger value="vocals">Vocals</TabsTrigger>
      <TabsTrigger value="other">Other</TabsTrigger>
    </TabsList>
    
    <TabsContent value="drums">
      <FeatureMappingControls
        stem="drums"
        features={["rhythm", "pitch", "timbre"]}
        visualTargets={visualTargets}
        onChange={updateMapping}
      />
      <PresetSelector
        stemType="drums"
        presets={drumPresets}
        onSelect={applyPreset}
      />
      <RealTimePreview
        stemType="drums"
        features={currentFeatures.drums}
        mapping={currentMapping.drums}
      />
    </TabsContent>
    {/* Similar content for other stems */}
  </Tabs>
  
  <GlobalControls
    intensity={globalIntensity}
    smoothing={globalSmoothing}
    visualStyle={currentStyle}
    onChange={updateGlobalSettings}
  />
</GlassCard>
```

## Acceptance Criteria

1. User Interface:
   - Intuitive stem selection and control
   - Real-time visual feedback
   - Preset management system
   - Global control panel

2. Feature Mapping:
   - Visual parameter mapping for each stem
   - Intensity and smoothing controls
   - Enable/disable individual features

3. Presets:
   - Save and load custom presets
   - Built-in preset library
   - Preview thumbnails

4. Performance:
   - Smooth real-time updates
   - No UI lag during processing
   - Efficient state management

## Technical Dependencies

1. React/Next.js for UI components
2. Three.js for visualization preview
3. Tailwind CSS for styling
4. Zustand for state management

## Success Metrics

1. User engagement:
   - Average time spent adjusting controls
   - Preset usage rate
   - Custom preset creation rate

2. Performance:
   - UI response time under 16ms
   - Preview frame rate above 30fps
   - State update latency under 50ms

## Dev Agent Record

- [ ] Create base UI components
- [ ] Implement feature mapping controls
- [ ] Add preset management system
- [ ] Build real-time preview
- [ ] Optimize performance
- [ ] Add documentation and tooltips 