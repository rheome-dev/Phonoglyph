# Story 5.6: Credit System & Cost Management

**Epic**: 5 - Stem Separation & Audio Analysis  
**Story**: 5.6  
**Status**: Not Started ðŸ”´  
**Priority**: High  
**Estimated Effort**: 16 hours  
**Dependencies**: Story 5.1 âœ…

## User Story

**As a** service administrator  
**I want to** have a flexible credit system that accounts for stem separation costs  
**So that** we can maintain profitability while providing fair pricing to users

## Technical Implementation Details

### Credit System Architecture
```typescript
interface CreditSystem {
  // Credit calculation for different operations
  creditCalculator: {
    calculateStemSeparationCredits(audioLength: number): number;
    calculateVideoRenderingCredits(
      length: number,
      resolution: "720p" | "1080p" | "4K",
      complexity: "basic" | "medium" | "complex"
    ): number;
  };
  
  // Credit management
  creditManager: {
    deductCredits(userId: string, amount: number): Promise<boolean>;
    refundCredits(userId: string, amount: number): Promise<boolean>;
    getCreditBalance(userId: string): Promise<number>;
  };
  
  // Cost tracking
  costTracker: {
    trackProcessingCost(
      operationType: "stem_separation" | "video_rendering",
      resourceUsage: {
        computeTimeSeconds: number;
        storageGigabytes: number;
        gpuUtilization: number;
      }
    ): Promise<void>;
  };
  
  // Batch processing optimization
  batchProcessor: {
    queueJob(
      jobType: "stem_separation" | "video_rendering",
      priority: "normal" | "high",
      timing: "immediate" | "off_peak"
    ): Promise<string>;
    
    getBatchStatus(batchId: string): Promise<{
      status: "queued" | "processing" | "complete" | "failed";
      estimatedCreditCost: number;
      actualCreditCost?: number;
    }>;
  };
}
```

### Database Schema
```sql
CREATE TABLE credit_transactions (
  id UUID PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id),
  amount INTEGER NOT NULL,
  operation_type TEXT NOT NULL,
  resource_usage JSONB,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  batch_id UUID
);

CREATE TABLE credit_balances (
  user_id UUID PRIMARY KEY REFERENCES auth.users(id),
  balance INTEGER NOT NULL DEFAULT 0,
  last_updated TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE batch_jobs (
  id UUID PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id),
  job_type TEXT NOT NULL,
  priority TEXT NOT NULL,
  timing TEXT NOT NULL,
  status TEXT NOT NULL,
  estimated_credits INTEGER,
  actual_credits INTEGER,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  completed_at TIMESTAMPTZ
);
```

## Acceptance Criteria

1. Credit calculation accurately reflects resource usage:
   - Base credits for stem separation (10 credits)
   - Length multiplier (1 credit per minute)
   - Resolution and complexity multipliers for video rendering

2. Credit management system:
   - Deduct credits before processing
   - Refund mechanism for failed jobs
   - Real-time balance checking

3. Cost tracking:
   - Monitor actual AWS costs vs credits charged
   - Track resource utilization
   - Generate cost reports

4. Batch processing:
   - Queue jobs for off-peak processing
   - Priority processing for pro users
   - Status monitoring and notifications

## Technical Dependencies

1. AWS Cost Explorer API for cost tracking
2. Supabase for credit balance management
3. Redis for job queue management
4. AWS EventBridge for scheduling off-peak processing

## Success Metrics

1. Processing costs remain under 40% of credit value
2. Average processing time under 2 minutes for 3-minute songs
3. 95% successful completion rate for batch jobs
4. User credit usage tracking accuracy within 1%

## Dev Agent Record

- [ ] Implement credit calculation system
- [ ] Set up credit balance management
- [ ] Create batch processing queue
- [ ] Implement cost tracking and reporting
- [ ] Add monitoring and alerting for cost thresholds 